<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allocation Distribution System - Ministry of Health</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>

<meta name="theme-color" content="#1a5f7a">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* ========== CSS VARIABLES - ENHANCED ========== */
:root {
    --primary: #1a5f7a;
    --primary-light: #2a7f9e;
    --primary-dark: #0d455c;
    --secondary: #2d8c5a;
    --secondary-light: #3aac70;
    --danger: #d64545;
    --warning: #e6a100;
    --info: #2c8da5;
    --light: #f8fafc;
    --dark: #1e2a3a;
    --gray: #64748b;
    --gray-light: #e2e8f0;
    --border: #cbd5e1;
    --success: #28a745;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 6px 12px -2px rgba(0, 0, 0, 0.1), 0 3px 6px -1px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 15px 30px -5px rgba(0, 0, 0, 0.15), 0 5px 15px -3px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --border-radius-lg: 12px;
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ========== RESET & BASE STYLES - ENHANCED ========== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body {
    background-color: #f1f5f9;
    color: var(--dark);
    line-height: 1.7;
    font-size: 15px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.container {
    max-width: 1400px;
    padding: 0 24px;
    margin: 0 auto;
}

/* ========== TYPOGRAPHY - ENHANCED ========== */
h1, h2, h3, h4, h5, h6 {
    margin-bottom: 1rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--dark);
}

h1 { 
    font-size: 2.25rem; 
    font-weight: 700;
    letter-spacing: -0.5px;
}
h2 { 
    font-size: 1.875rem; 
    font-weight: 600;
}
h3 { 
    font-size: 1.5rem; 
    border-left: 4px solid var(--primary);
    padding-left: 12px;
}
h4 { 
    font-size: 1.25rem; 
    font-weight: 600;
}
h5 { 
    font-size: 1.125rem; 
}
h6 { 
    font-size: 1rem; 
    color: var(--gray);
}

/* ========== NEW LOGIN SCREEN - ENHANCED ========== */
.login-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 24px;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    position: relative;
    overflow: hidden;
}

.login-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
}

.login-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 48px 40px;
    width: 100%;
    max-width: 440px;
    text-align: center;
    position: relative;
    z-index: 1;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.login-logo {
    width: 96px;
    height: 96px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 40px;
    box-shadow: 0 8px 25px rgba(26, 95, 122, 0.4);
    transition: transform 0.3s ease;
}

.login-logo:hover {
    transform: scale(1.05);
}

.login-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--dark);
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.login-subtitle {
    color: var(--gray);
    margin-bottom: 36px;
    font-size: 16px;
    font-weight: 500;
}

/* ========== FORM STYLES - ENHANCED ========== */
.form-group {
    margin-bottom: 24px;
    text-align: left;
}

.form-label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: var(--dark);
    font-size: 14px;
    letter-spacing: 0.3px;
}

.form-control {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid var(--border);
    border-radius: var(--border-radius);
    font-size: 15px;
    transition: var(--transition);
    background-color: white;
    color: var(--dark);
    font-weight: 500;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(26, 95, 122, 0.15);
    background-color: white;
}

.form-control.readonly {
    background-color: #f8fafc;
    border-color: #e2e8f0;
    color: var(--gray);
    cursor: not-allowed;
}

.role-selector {
    display: flex;
    margin-bottom: 28px;
    border-radius: var(--border-radius);
    overflow: hidden;
    border: 2px solid var(--border);
    background: white;
}

.role-option {
    flex: 1;
    padding: 14px;
    text-align: center;
    background-color: white;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    font-size: 14px;
    color: var(--gray);
    border-right: 1px solid var(--border);
}

.role-option:last-child {
    border-right: none;
}

.role-option.active {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(26, 95, 122, 0.3);
}

.role-option:hover:not(.active) {
    background-color: #f8fafc;
    color: var(--primary);
}

/* ========== BUTTON STYLES - ENHANCED ========== */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 28px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    box-shadow: var(--shadow);
    text-decoration: none;
    letter-spacing: 0.3px;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.btn-secondary {
    background: linear-gradient(135deg, var(--secondary) 0%, #237a48 100%);
}

.btn-secondary:hover {
    box-shadow: 0 10px 25px rgba(45, 140, 90, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%);
}

.btn-danger:hover {
    box-shadow: 0 10px 25px rgba(214, 69, 69, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning) 0%, #d68e00 100%);
}

.btn-warning:hover {
    box-shadow: 0 10px 25px rgba(230, 161, 0, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, var(--info) 0%, #1d7085 100%);
}

.btn-info:hover {
    box-shadow: 0 10px 25px rgba(44, 141, 165, 0.4);
}

.btn:disabled {
    background: #cbd5e1;
    color: #94a3b8;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn:disabled::before {
    display: none;
}

.btn-block {
    width: 100%;
}

.btn-sm {
    padding: 10px 20px;
    font-size: 14px;
}

/* ========== DASHBOARD STYLES - ENHANCED ========== */
.dashboard {
    display: none;
    min-height: 100vh;
    background-color: #f1f5f9;
}

.header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 20px 0;
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    font-weight: 700;
    font-size: 20px;
    color: white;
    gap: 12px;
}

.logo-icon {
    font-size: 28px;
    background: rgba(255, 255, 255, 0.2);
    padding: 10px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.user-name {
    color: white;
    font-weight: 600;
    font-size: 15px;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 16px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
}

.logout-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    padding: 10px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    color: white;
    font-weight: 600;
    transition: var(--transition);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.main-content {
    padding: 32px 0;
}

.page-title {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 32px;
    color: var(--dark);
    text-align: center;
    position: relative;
    padding-bottom: 20px;
}

.page-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 2px;
}

/* ========== TAB STYLES - ENHANCED ========== */
.user-tabs, .admin-tabs {
    display: flex;
    margin-bottom: 32px;
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 8px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
}

.user-tabs::-webkit-scrollbar, .admin-tabs::-webkit-scrollbar {
    display: none;
}

.user-tab, .admin-tab {
    padding: 16px 28px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    color: var(--gray);
    position: relative;
    font-size: 15px;
    white-space: nowrap;
    border-radius: calc(var(--border-radius) - 4px);
    margin: 0 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.user-tab.active, .admin-tab.active {
    color: var(--primary);
    background: rgba(26, 95, 122, 0.1);
    box-shadow: 0 2px 8px rgba(26, 95, 122, 0.1);
}

.user-tab:hover:not(.active), .admin-tab:hover:not(.active) {
    background: #f8fafc;
    color: var(--primary);
}

.notification-badge {
    background-color: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 8px;
    right: 8px;
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(214, 69, 69, 0.3);
}

/* ========== FORM SECTIONS - ENHANCED ========== */
.allocation-form, .data-table-container, .requests-table, .allocation-history, .vote-distribution {
    background-color: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow);
    padding: 32px;
    margin-bottom: 32px;
    border: 1px solid var(--border);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.allocation-form:hover, .data-table-container:hover, .requests-table:hover, 
.allocation-history:hover, .vote-distribution:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.form-section {
    margin-bottom: 36px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
}

.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.section-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 3px solid var(--primary);
    color: var(--primary);
    position: relative;
}

.section-title::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

/* ========== TABLE STYLES - ENHANCED ========== */
.table-header, .data-table-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
}

.table-title, .data-table-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 12px;
}

.table-title::before, .data-table-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--primary);
    border-radius: 2px;
}

.table-container, .table-scroll-container {
    overflow-x: auto;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 800px;
}

th, td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-size: 14px;
    transition: background-color 0.2s ease;
}

th {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    font-weight: 700;
    color: var(--dark);
    position: sticky;
    top: 0;
    z-index: 10;
    border-top: 1px solid var(--border);
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.5px;
}

th:first-child {
    border-top-left-radius: var(--border-radius);
}

th:last-child {
    border-top-right-radius: var(--border-radius);
}

tr:hover {
    background-color: #f8fafc;
}

tr:last-child td {
    border-bottom: none;
}

.highlighted-row {
    background: linear-gradient(90deg, rgba(26, 95, 122, 0.05) 0%, transparent 100%) !important;
    border-left: 4px solid var(--primary);
}

/* ========== STATUS BADGES - ENHANCED ========== */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.status-pending {
    background: linear-gradient(135deg, #fff8e6 0%, #ffedcc 100%);
    color: #e6a100;
    border: 1px solid #ffd966;
}

.status-approved {
    background: linear-gradient(135deg, #e8f5e9 0%, #d0e6d2 100%);
    color: var(--secondary);
    border: 1px solid #a5d6a7;
}

.status-rejected {
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    color: var(--danger);
    border: 1px solid #ef9a9a;
}

.status-completed {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: var(--primary);
    border: 1px solid #90caf9;
}

/* ========== CHARTS GRID - UPDATED ========== */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 24px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    min-height: 320px;
    display: flex;
    flex-direction: column;
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.chart-card h4 {
    color: var(--primary);
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--primary-light);
    flex-shrink: 0;
}

.chart-card canvas {
    flex-grow: 1;
    width: 100% !important;
    height: auto !important;
    max-height: 250px;
}

/* Analytics specific charts */
#viewAnalyticsTab .charts-grid {
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

#viewAnalyticsTab .chart-card {
    padding: 24px;
    min-height: 350px;
}

#viewAnalyticsTab .chart-card h4 {
    margin-bottom: 20px;
}
.summary-tables .data-table-container {
    margin-bottom: 30px;
    border: 1px solid var(--border);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
}

.summary-tables .data-table-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 15px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.summary-tables .data-table-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--dark);
}

/* Responsive adjustments */
@media (max-width: 992px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-card {
        margin-bottom: 20px;
    }
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .summary-tables .data-table-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .summary-tables .data-table-header .btn {
        align-self: flex-end;
    }
}
/* ========== MODAL STYLES - ENHANCED ========== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background-color: white;
    border-radius: var(--border-radius-lg);
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    position: sticky;
    top: 0;
    z-index: 10;
}

.modal-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 12px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--gray);
    transition: var(--transition);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-modal:hover {
    background-color: #f1f5f9;
    color: var(--danger);
}

.modal-body {
    padding: 32px;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 16px;
    background: #f8fafc;
    border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    position: sticky;
    bottom: 0;
}

/* ========== STATS CARDS - ENHANCED ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.stat-card {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius-lg);
    padding: 28px;
    box-shadow: var(--shadow);
    text-align: center;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, var(--primary), var(--secondary));
}

.stat-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    font-size: 36px;
    margin-bottom: 16px;
    color: var(--primary);
    width: 64px;
    height: 64px;
    background: rgba(26, 95, 122, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}

.stat-value {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 8px;
    color: var(--dark);
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-label {
    font-size: 14px;
    color: var(--gray);
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* ========== ENHANCED PDF PREVIEW - ENHANCED ========== */
.enhanced-pdf {
    border: 2px solid var(--border);
    border-radius: var(--border-radius-lg);
    padding: 32px;
    margin-top: 24px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    box-shadow: var(--shadow);
    position: relative;
}

.enhanced-pdf::before {
    content: 'PREVIEW';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary);
    color: white;
    padding: 6px 20px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
}

.enhanced-pdf-header {
    text-align: center;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 3px solid var(--primary);
    position: relative;
}

.enhanced-pdf-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.enhanced-pdf-subtitle {
    font-size: 16px;
    color: var(--gray);
    font-weight: 500;
}

.enhanced-pdf-section {
    margin-bottom: 24px;
    padding: 20px;
    border-radius: var(--border-radius);
    background: white;
    border-left: 4px solid var(--primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease;
}

.enhanced-pdf-section:hover {
    transform: translateX(4px);
}

.enhanced-pdf-label {
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--dark);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.enhanced-pdf-label::before {
    content: '▸';
    color: var(--primary);
}

.enhanced-pdf-value {
    margin-bottom: 0;
    color: var(--gray);
    font-size: 15px;
    line-height: 1.6;
}

.enhanced-pdf-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

/* ========== SUCCESS MESSAGE - ENHANCED ========== */
.success-message {
    background: linear-gradient(135deg, #e8f5e9 0%, #d0e6d2 100%);
    border: 2px solid var(--secondary);
    border-radius: var(--border-radius-lg);
    padding: 32px;
    text-align: center;
    margin: 24px 0;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.success-message::before {
    content: '✓';
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 48px;
    color: rgba(45, 140, 90, 0.2);
}

.success-message h2 {
    color: var(--secondary);
    margin-bottom: 16px;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.password-notice {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid var(--primary);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    margin: 24px 0;
    text-align: center;
    box-shadow: var(--shadow);
}

.password-value {
    font-family: 'Courier New', monospace;
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    background: white;
    padding: 12px 24px;
    border-radius: var(--border-radius);
    border: 2px dashed var(--primary);
    display: inline-block;
    margin: 12px 0;
    letter-spacing: 2px;
}

/* ========== CONTROLS - ENHANCED ========== */
.admin-controls, .report-controls, .history-filter {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
    padding: 24px;
    background: white;
    border-radius: var(--border-radius);
    border: 1px solid var(--border);
}

.search-control {
    position: relative;
}

.search-control .form-control, .search-container .form-control {
    padding-left: 48px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 16px center;
    background-size: 20px;
}

.search-control i, .search-container i {
    display: none;
}

/* ========== PAGINATION - ENHANCED ========== */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 24px;
    gap: 12px;
    padding: 20px;
    background: white;
    border-radius: var(--border-radius);
    border: 1px solid var(--border);
}

.pagination button {
    padding: 10px 20px;
    border: 2px solid var(--border);
    background-color: white;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.pagination button:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.pagination-info {
    margin: 0 20px;
    font-size: 14px;
    color: var(--gray);
    font-weight: 600;
}

/* ========== SIGNATURE SECTION - ENHANCED ========== */
.signature-section {
    margin-top: 40px;
    padding-top: 32px;
    border-top: 2px solid var(--border);
    background: linear-gradient(135deg, #f8fafc 0%, white 100%);
    border-radius: var(--border-radius);
    padding: 24px;
}

.signature-line {
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--dark), transparent);
    margin: 24px 0 12px;
}

.signature-label {
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--dark);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.signature-name {
    font-size: 16px;
    margin-bottom: 4px;
    color: var(--dark);
    font-weight: 600;
}

.signature-title {
    font-size: 14px;
    color: var(--gray);
}

/* ========== HOSPITAL SUMMARY - ENHANCED ========== */
.hospital-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.hospital-summary-card {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    box-shadow: var(--shadow);
    border-left: 6px solid var(--primary);
    transition: all 0.3s ease;
}

.hospital-summary-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.hospital-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
}

.hospital-summary-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--dark);
}

.hospital-summary-count {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(26, 95, 122, 0.3);
}

.hospital-summary-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.hospital-stat-item {
    text-align: center;
    padding: 16px;
    background: white;
    border-radius: var(--border-radius);
    border: 1px solid var(--border);
    transition: transform 0.2s ease;
}

.hospital-stat-item:hover {
    transform: scale(1.05);
    border-color: var(--primary);
}

.hospital-stat-value {
    font-size: 20px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
}

.hospital-stat-label {
    font-size: 13px;
    color: var(--gray);
    font-weight: 600;
}

/* ========== HISTORY CARDS - ENHANCED ========== */
.history-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.history-summary-card {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius);
    padding: 24px;
    border-left: 6px solid var(--primary);
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
}

.history-summary-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.history-summary-card .value {
    font-size: 32px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 8px;
    line-height: 1;
}

.history-summary-card .label {
    font-size: 14px;
    color: var(--gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* ========== UTILITY CLASSES ========== */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.mt-10 { margin-top: 10px; }
.mt-20 { margin-top: 20px; }
.mt-30 { margin-top: 30px; }
.mb-10 { margin-bottom: 10px; }
.mb-20 { margin-bottom: 20px; }
.mb-30 { margin-bottom: 30px; }
.ml-10 { margin-left: 10px; }
.mr-10 { margin-right: 10px; }

.hidden { display: none; }
.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.w-100 { width: 100%; }

/* ========== LOADING SPINNER - ENHANCED ========== */
.spinner {
    border: 3px solid rgba(26, 95, 122, 0.1);
    border-top: 3px solid var(--primary);
    border-right: 3px solid var(--primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.7);
    z-index: 100;
}

/* ========== SCROLLBAR STYLING - ENHANCED ========== */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
    border: 2px solid #f1f5f9;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

/* ========== BUTTON GROUP - ENHANCED ========== */
.button-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px;
    margin-top: 32px;
    padding: 24px;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: var(--border-radius-lg);
    border: 1px solid var(--border);
}

.button-group .btn {
    flex: 1;
    min-width: 200px;
    max-width: 300px;
    margin: 0;
}

/* ========== REJECTION STYLES - ENHANCED ========== */
#rejectionSection {
    background: linear-gradient(135deg, #fff5f5 0%, #ffebeb 100%);
    border: 2px solid #fed7d7;
    border-radius: var(--border-radius);
    padding: 20px;
    margin: 20px 0;
    display: none;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid var(--danger);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#rejectionSection.show {
    display: block;
}

/* ========== RESPONSIVE DESIGN - ENHANCED ========== */
@media (max-width: 1200px) {
    .container {
        max-width: 100%;
        padding: 0 20px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .hospital-summary-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 992px) {
    h1 { font-size: 2rem; }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.5rem; }
    
    .login-card {
        padding: 36px 28px;
    }
    
    .allocation-form, .data-table-container, .requests-table {
        padding: 24px;
    }
    
    .modal-content {
        margin: 10px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
    }
    
    .logo {
        flex-direction: column;
        gap: 8px;
    }
    
    .user-info {
        flex-direction: column;
        gap: 12px;
    }
    
    .user-tabs, .admin-tabs {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .user-tab, .admin-tab {
        flex: 1;
        min-width: 120px;
        padding: 14px 16px;
        font-size: 14px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .hospital-summary-grid {
        grid-template-columns: 1fr;
    }
    
    .history-summary {
        grid-template-columns: 1fr;
    }
    
    .admin-controls, .report-controls, .history-filter {
        grid-template-columns: 1fr;
    }
    
    .modal-footer {
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
        margin-bottom: 8px;
    }
    
    .button-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .button-group .btn {
        min-width: 100%;
        max-width: 100%;
    }
}

@media (max-width: 576px) {
    .container {
        padding: 0 16px;
    }
    
    .login-card {
        padding: 28px 20px;
    }
    
    .page-title {
        font-size: 1.75rem;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .table-header, .data-table-header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
    }
    
    .table-title, .data-table-title {
        font-size: 18px;
    }
    
    th, td {
        padding: 12px 8px;
        font-size: 13px;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 14px;
    }
}

/* ========== VIEW-ONLY TABS ========== */
.view-only-tabs {
    display: flex;
    margin-bottom: 32px;
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 8px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
}

.view-only-tabs::-webkit-scrollbar {
    display: none;
}

.view-only-tab {
    padding: 16px 28px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    color: var(--gray);
    position: relative;
    font-size: 15px;
    white-space: nowrap;
    border-radius: calc(var(--border-radius) - 4px);
    margin: 0 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.view-only-tab.active {
    color: var(--primary);
    background: rgba(26, 95, 122, 0.1);
    box-shadow: 0 2px 8px rgba(26, 95, 122, 0.1);
}

.view-only-tab:hover:not(.active) {
    background: #f8fafc;
    color: var(--primary);
}

/* ========== ENHANCED VIEW-ONLY STATUS CARDS ========== */
.view-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.view-status-card {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    box-shadow: var(--shadow);
    border-top: 6px solid;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.view-status-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 100%);
    z-index: 1;
}

.view-status-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.view-status-card.pending {
    border-color: var(--warning);
    background: linear-gradient(135deg, #fff8e6 0%, #ffedcc 100%);
}

.view-status-card.approved {
    border-color: var(--secondary);
    background: linear-gradient(135deg, #e8f5e9 0%, #d0e6d2 100%);
}

.view-status-card.rejected {
    border-color: var(--danger);
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
}

.view-status-card.completed {
    border-color: var(--primary);
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.view-status-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(0,0,0,0.05);
    position: relative;
    z-index: 2;
}

.view-status-title {
    font-size: 18px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.view-status-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
}

/* Add this to your CSS section, around line where view-only styles are defined */

/* ========== VIEW-ONLY STATUS CARDS ========== */
.status-card {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    border-left: 6px solid;
    transition: all 0.3s ease;
}

.status-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.status-card.pending {
    border-left-color: var(--warning);
    background: linear-gradient(135deg, #fff8e6 0%, #ffedcc 100%);
}

.status-card.approved {
    border-left-color: var(--secondary);
    background: linear-gradient(135deg, #e8f5e9 0%, #d0e6d2 100%);
}

.status-card.rejected {
    border-left-color: var(--danger);
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
}

.status-card.completed {
    border-left-color: var(--primary);
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.status-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
}

.status-card-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--dark);
}

.status-card-count {
    font-size: 24px;
    font-weight: 800;
    padding: 8px 16px;
    border-radius: 20px;
    color: white;
    min-width: 50px;
    text-align: center;
}

.status-card-pending {
    background: linear-gradient(135deg, var(--warning) 0%, #d68e00 100%);
}

.status-card-approved {
    background: linear-gradient(135deg, var(--secondary) 0%, #237a48 100%);
}

.status-card-rejected {
    background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%);
}

.status-card-completed {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

.selection-list {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
}

.selection-list::-webkit-scrollbar {
    width: 6px;
}

.selection-list::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
}

.selection-item {
    background: white;
    border-radius: var(--border-radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    transition: all 0.2s ease;
    cursor: pointer;
}

.selection-item:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 8px rgba(26, 95, 122, 0.1);
}

.allocation-status-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
}
.view-status-card.pending .view-status-icon {
    background: linear-gradient(135deg, var(--warning) 0%, #d68e00 100%);
}

.view-status-card.approved .view-status-icon {
    background: linear-gradient(135deg, var(--secondary) 0%, #237a48 100%);
}

.view-status-card.rejected .view-status-icon {
    background: linear-gradient(135deg, var(--danger) 0%, #c53030 100%);
}

.view-status-card.completed .view-status-icon {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}

.view-status-count {
    font-size: 32px;
    font-weight: 800;
    text-align: center;
    margin: 15px 0;
    position: relative;
    z-index: 2;
}

.view-status-card.pending .view-status-count {
    color: var(--warning);
}

.view-status-card.approved .view-status-count {
    color: var(--secondary);
}

.view-status-card.rejected .view-status-count {
    color: var(--danger);
}

.view-status-card.completed .view-status-count {
    color: var(--primary);
}

.view-status-progress {
    height: 6px;
    background: rgba(0,0,0,0.1);
    border-radius: 3px;
    margin: 15px 0;
    overflow: hidden;
    position: relative;
    z-index: 2;
}

.view-status-progress-bar {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
}

.view-status-card.pending .view-status-progress-bar {
    background: linear-gradient(90deg, var(--warning) 0%, #ffb347 100%);
}

.view-status-card.approved .view-status-progress-bar {
    background: linear-gradient(90deg, var(--secondary) 0%, #4caf50 100%);
}

.view-status-card.rejected .view-status-progress-bar {
    background: linear-gradient(90deg, var(--danger) 0%, #ff6b6b 100%);
}

.view-status-card.completed .view-status-progress-bar {
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
}

.view-status-percentage {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray);
    text-align: right;
    margin-top: 5px;
    position: relative;
    z-index: 2;
}

.view-status-list-container {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 20px;
    padding-right: 5px;
    position: relative;
    z-index: 2;
}

.view-status-list-container::-webkit-scrollbar {
    width: 5px;
}

.view-status-list-container::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 10px;
}

.view-status-item {
    background: white;
    border-radius: var(--border-radius);
    padding: 12px 15px;
    margin-bottom: 10px;
    border-left: 4px solid;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    cursor: pointer;
}

.view-status-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.view-status-item.pending {
    border-left-color: var(--warning);
    background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, transparent 100%);
}

.view-status-item.approved {
    border-left-color: var(--secondary);
    background: linear-gradient(90deg, rgba(76, 175, 80, 0.1) 0%, transparent 100%);
}

.view-status-item.rejected {
    border-left-color: var(--danger);
    background: linear-gradient(90deg, rgba(244, 67, 54, 0.1) 0%, transparent 100%);
}

.view-status-item.completed {
    border-left-color: var(--primary);
    background: linear-gradient(90deg, rgba(33, 150, 243, 0.1) 0%, transparent 100%);
}

.view-status-ref {
    font-weight: 700;
    font-size: 14px;
    color: var(--dark);
    margin-bottom: 5px;
}

.view-status-hospital {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 3px;
}

.view-status-amount {
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
}

.view-status-empty {
    text-align: center;
    padding: 20px;
    color: var(--gray);
    font-style: italic;
}

.view-status-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    position: relative;
    z-index: 2;
}

.view-status-total-amount {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
}

.view-status-update-time {
    font-size: 11px;
    color: var(--gray);
    font-style: italic;
}

/* ========== ENHANCED FILTER CONTROLS ========== */
.view-status-controls {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius-lg);
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}

.view-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.view-filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.view-filter-label {
    font-weight: 600;
    font-size: 14px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.view-filter-label i {
    color: var(--primary);
}

/* ========== QUICK STATS ========== */
.view-quick-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.view-quick-stat {
    background: linear-gradient(135deg, white 0%, #f8fafc 100%);
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
}

.view-quick-stat:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.view-quick-stat-value {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.view-quick-stat-label {
    font-size: 13px;
    color: var(--gray);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ========== RESPONSIVE ADJUSTMENTS ========== */
@media (max-width: 768px) {
    .view-status-grid {
        grid-template-columns: 1fr;
    }
    
    .view-filter-grid {
        grid-template-columns: 1fr;
    }
    
    .view-quick-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .view-quick-stats {
        grid-template-columns: 1fr;
    }
    
    .view-status-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
/* ========== PRINT STYLES ========== */
@media print {
    .header, .user-tabs, .admin-tabs, .button-group, .pagination,
    .admin-controls, .report-controls, .history-filter {
        display: none !important;
    }
    
    .dashboard, .main-content, .container {
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    .allocation-form, .data-table-container, .requests-table,
    .allocation-history, .vote-distribution, .enhanced-pdf {
        box-shadow: none !important;
        border: 1px solid #000 !important;
        page-break-inside: avoid;
    }
}        



    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">🏥</div>
            <h1 class="login-title">Allocation Distribution System</h1>
            <p class="login-subtitle">Ministry of Health</p>
            
            <div class="role-selector">
                <div class="role-option active" data-role="hospital">User</div>
                
            </div>
            
            <div class="form-group">
                <label class="form-label" for="hospitalSelect">Select Hospital/User</label>
                <select id="hospitalSelect" class="form-control">
                    <option value="">Select Hospital/User</option>
                    <option value="admin">Administrator</option>
		    <option value="Deputy Director General (Planning)">Deputy Director General (Planning)</option>
		    <option value="Accountant (Budget Control)">Accountant (Budget Control)</option>
                     </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password">
                <small class="form-text">For System Inquiries 011 2 692 382</small>
            </div>
            
            <button id="loginBtn" class="btn btn-block">Login to System</button>
            <div id="loginSpinner" class="spinner mt-20 hidden"></div>
            <div id="loginMessage" class="mt-20 hidden"></div>
        </div>
    </div>
    
    <!-- Hospital User Dashboard -->
    <div id="hospitalDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">🏥</span>
                        <span>ADS - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="hospitalDisplayName">Hospital User</span>
                        <button id="hospitalLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Distribution System</h1>
                
                <div class="user-tabs">
                    <div class="user-tab active" data-tab="allocation">Allocation Request</div>
                    <div class="user-tab" data-tab="myRequests">My Requests</div>
                    <div class="user-tab" data-tab="allocations">Allocation Status</div>
                    <div class="user-tab" data-tab="history">Allocation History</div>
                    <div class="user-tab" data-tab="voteDistribution">Vote Distribution</div>
                </div>
                
                <!-- Allocation Request Tab -->
                <div id="allocationTab" class="user-tab-content">
                    <div class="allocation-form" id="allocationForm">
                        <div class="form-section">
                            <h2 class="section-title">Hospital Information</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="hospitalName">Hospital Name *</label>
                                        <input type="text" id="hospitalName" class="form-control readonly" placeholder="Hospital name will be auto-filled" readonly required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPerson">Contact Person *</label>
                                        <input type="text" id="contactPerson" class="form-control" placeholder="Enter contact person name" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactPhone">Contact Phone *</label>
                                        <input type="tel" id="contactPhone" class="form-control" placeholder="Enter contact phone number" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="contactEmail">Contact Email</label>
                                        <input type="email" id="contactEmail" class="form-control" placeholder="Enter contact email">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h2 class="section-title">Allocation Details</h2>
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="voteNumber">Vote Number *</label>
                                        <select id="voteNumber" class="form-control" required>
                                            <option value="">-- Select Vote Number --</option>
                                            <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                            <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                            <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                            <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                            <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                            <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                            
                                            <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                            <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                            <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                            <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                            <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                            <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                            <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                            <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                            <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                           <option value="111-1-2-2505(11) Procurement Preparedness">111-1-2-2505(11) Procurement Preparedness</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="jobDescription">Job Description *</label>
                                        <textarea id="jobDescription" class="form-control" rows="3" placeholder="Describe the job/work required" required></textarea>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredAmount">Required Amount (LKR) *</label>
                                        <input type="number" id="requiredAmount" class="form-control" placeholder="Enter required amount in LKR" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="priorityLevel">Priority Level *</label>
                                        <select id="priorityLevel" class="form-control" required>
                                            <option value="">Select priority level</option>
                                            <option value="Low">Low</option>
                                            <option value="Medium">Medium</option>
                                            <option value="High">High</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="requiredDate">Record Entry Date *</label>
                                        <input type="date" id="requiredDate" class="form-control" required>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label" for="additionalNotes">Additional Notes</label>
                                        <textarea id="additionalNotes" class="form-control" rows="3" placeholder="Add any additional notes or comments"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="submitAllocation" class="btn btn-block">Submit Allocation Request</button>
                        <div id="submitSpinner" class="spinner mt-20 hidden"></div>
                    </div>
                    
                    <div id="allocationSuccess" class="hidden">
                        <div class="success-message">
                            <h2>Allocation Request Submitted Successfully!</h2>
                            <p>Your allocation request has been submitted and is pending approval.</p>
                            <div class="password-notice">
                                <h3>Your Request Password: <span id="uniquePasswordDisplay" class="password-value"></span></h3>
                                <p><strong>Important:</strong> Save this password. You'll need it for any updates or inquiries about this request.</p>
                            </div>
                        </div>
                        
                        <div class="enhanced-pdf" id="enhancedPdfPreview">
                            <div class="enhanced-pdf-header">
                                <div class="enhanced-pdf-title">Ministry of Health</div>
                                <div class="enhanced-pdf-subtitle">Allocation Request Confirmation</div>
                            </div>
                            <div class="enhanced-pdf-grid">
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Request Reference:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRefNumber">ADS-2023-001</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Unique Password:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPassword">XXXXXX</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Submission Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Hospital Details:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfHospitalDetails">Hospital Name, Contact Person, Phone</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Vote Number:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfVoteNumber">Vote Number</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Job Description:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfJobDescription">Job Description</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Amount:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAmount">0 LKR</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Priority Level:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfPriority">Low</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Required Date:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfRequiredDate">01/01/2023</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Additional Notes:</div>
                                    <div class="enhanced-pdf-value" id="enhancedPdfAdditionalNotes">No additional notes</div>
                                </div>
                                <div class="enhanced-pdf-section">
                                    <div class="enhanced-pdf-label">Status:</div>
                                    <div class="enhanced-pdf-value">Pending Approval</div>
                                </div>
                            </div>
                            <div class="enhanced-pdf-section">
   			    <div class="enhanced-pdf-label">Approval Date:</div>
    			   <div class="enhanced-pdf-value" id="viewApprovalDate">N/A</div>
			  </div>
                            <!-- Add Important Instructions Section -->
                            <div class="enhanced-pdf-section" style="grid-column: 1 / -1;">
                                <div class="enhanced-pdf-label">Important Instructions:</div>
                                <div class="enhanced-pdf-value">
                                    <p><strong>3. The following instructions should be followed when incurring these expenses:</strong></p>
                                    <p>I. Action should be taken in accordance with the Government Financial Regulations (GFR), Establishment Code, GFR 135 on Delegation of Authority, other laws and regulations, and the relevant instructions of Budget Circular No. 01/2025 dated 22.03.2025, which authorizes expenditure for the year 2025 and pertains to public expenditure management.</p>
                                    <p>II. The relevant work subjects should be executed upon approval by your Hospital's Regional Procurement Committee, in accordance with this Ministry Circular and instructions.</p>
                                    <p>III. In order to prevent the Government as well as the contractors/service providers from facing difficulties due to the accumulation of unsettled liabilities, it is important to confirm the availability of cash flow before entering into commitments, even if the provision has been allocated.</p>
                                    <p>IV. Starting work without provisions should especially be avoided, and expenses exceeding the limit of the allocated provisions should not be incurred.</p>
                                    <p>V. The provisions granted through this letter will expire on 31.12.2026.</p>
                                    <p><strong>4. Monthly expenditure reports</strong>, stating the work subjects for which the provisions were expended, must be submitted by the Accountant of the Hospitals/Institutions to the email address ddglogisticsmoh@gmail.com. The Institutional Section must also complete the physical and financial progress for every month according to the provided format. Kindly note that both these reports must be submitted before the 10th day of the following month.</p>
                                </div>
                            </div>
                            
                            <div class="signature-section">
                                <div class="signature-line"></div>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">H.M.N Dinipriya Herath</div>
                                        <div class="signature-title">Deputy Director General (Logistics)</div>
                                        <div class="signature-title">For Secretary</div>
                                    </div>
                                    <div>
                                        <div class="signature-label">Approval Signature:</div>
                                        <div class="signature-name">Director Building Branch</div>
                                        <div class="signature-title">Director Building Branch (Administration)</div>
                                    </div>
                                </div>
                                <div class="mt-20">
                                    <div class="signature-label">Copies:</div>
                                    <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                                    <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                                </div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button id="downloadPdf" class="btn">Download Confirmation</button>
                            <button id="newAllocation" class="btn btn-secondary">Make Another Request</button>
                        </div>
                    </div>
                </div>
                
                <!-- My Requests Tab -->
                <div id="myRequestsTab" class="user-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="myRequestsStatusFilter">Filter by Status</label>
                            <select id="myRequestsStatusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchMyRequests">Search My Requests</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchMyRequests" class="form-control" placeholder="Search by reference or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">My Allocation Requests</div>
                            <div id="myRequestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="myRequestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="myRequestsPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="myRequestsPageInfo">Page 1 of 1</span>
                            <button id="myRequestsNextPage" disabled>Next</button>
                        </div>
                        
                        <div id="myRequestsSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="user-tab-content hidden">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="stat-value" id="userTotalAllocations">0</div>
                            <div class="stat-label">Total Requests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-value" id="userApprovedCount">0</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-value" id="userPendingCount">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                            <div class="stat-value" id="userRejectedCount">0</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                    </div>
                    
                    <div class="user-allocation-status">
                        <h2 class="section-title">Allocation Status Overview</h2>
                        <p>Current status of all your allocation requests.</p>
                        
                        <div class="data-table-controls mb-20">
                            <div class="search-control">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchUserAllocations" class="form-control" placeholder="Search allocations...">
                                </div>
                            </div>
                            <div class="pagination-info" id="userAllocationPageInfo">Page 1 of 1</div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table class="user-allocation-table">
                                <thead>
                                    <tr>
                                        <th>Ref No</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="userAllocationsList">
                                    <!-- Allocations will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="userAllocationPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="userAllocationPaginationInfo">Page 1 of 1</span>
                            <button id="userAllocationNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Allocation History Tab -->
                <div id="historyTab" class="user-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Allocation History</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="historyYearFilter">Year</label>
                                <select id="historyYearFilter" class="form-control">
                                    <option value="all">All Years</option>
				    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="historyVoteFilter">Vote Number</label>
                                <select id="historyVoteFilter" class="form-control">
                                    <option value="all">All Votes</option>
                                    <!-- Vote options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="historyStatusFilter">Status</label>
                                <select id="historyStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="history-summary">
                            <div class="history-summary-card">
                                <div class="value" id="totalHistoricalRequests">0</div>
                                <div class="label">Total Requests</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="totalHistoricalAmount">LKR 0</div>
                                <div class="label">Total Amount</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="avgApprovalTime">0 days</div>
                                <div class="label">Avg. Approval Time</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="successRate">0%</div>
                                <div class="label">Approval Rate</div>
                            </div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Requested Amount</th>
                                        <th>Approved Amount</th>
                                        <th>Status</th>
                                        <th>Submitted Date</th>
                                        <th>Approved Date</th>
                                        <th>Approved By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="historyPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="historyPageInfo">Page 1 of 1</span>
                            <button id="historyNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Vote Distribution Tab -->
                <div id="voteDistributionTab" class="user-tab-content hidden">
                    <div class="vote-distribution">
                        <h2 class="section-title">Vote-wise Allocation Distribution</h2>
                        
                        <div class="form-group">
                            <label class="form-label" for="distributionYearFilter">Select Year</label>
                            <select id="distributionYearFilter" class="form-control">
				<option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="vote-distribution-chart">
                            <canvas id="voteDistributionChart"></canvas>
                        </div>
                        
                        <div class="vote-distribution-table">
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Vote Number</th>
                                            <th>Total Requests</th>
                                            <th>Approved Requests</th>
                                            <th>Total Requested</th>
                                            <th>Total Approved</th>
                                            <th>Approval Rate</th>
                                            <th>Avg. Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="voteDistributionTableBody">
                                        <!-- Vote distribution data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportVoteDistribution" class="btn">Export to Excel</button>
                            <button id="printVoteDistribution" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="dashboard hidden">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">🏥</span>
                        <span>ADS Admin - Ministry of Health</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" id="adminDisplayName">Administrator</span>
                        <button id="adminLogout" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="container">
                <h1 class="page-title">Allocation Requests Management</h1>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                        <div class="stat-value" id="totalAllocations">0</div>
                        <div class="stat-label">Total Requests</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="pendingAllocations">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="approvedAllocations">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="totalAllocatedAmount">0</div>
                        <div class="stat-label">Total Allocated (LKR)</div>
                    </div>
                </div>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" data-tab="requests">
                        Allocation Requests
                        <span id="pendingAllocationBadge" class="notification-badge hidden">0</span>
                    </div>
                    <div class="admin-tab" data-tab="allocations">Allocation Status</div>
                    <div class="admin-tab" data-tab="allocationHistory">Allocation History</div>
                    <div class="admin-tab" data-tab="voteDistribution">Vote Distribution</div>
                    <div class="admin-tab" data-tab="hospitalSummary">Hospital Summary</div>
                    <div class="admin-tab" data-tab="reports">Reports</div>
                    <div class="admin-tab" data-tab="logs">System Logs</div>
                </div>
                
                <!-- Allocation Requests Tab -->
                <div id="requestsTab" class="admin-tab-content">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilter">Filter by Status</label>
                            <select id="statusFilter" class="form-control">
                                <option value="all">All Requests</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocations">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocations" class="form-control" placeholder="Search by reference, hospital, or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="requests-table">
                        <div class="table-header">
                            <div class="table-title">Allocation Requests</div>
                            <div id="requestCount">0 requests</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Hospital</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Amount</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody"></tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="prevPage" disabled>Previous</button>
                            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                            <button id="nextPage" disabled>Next</button>
                        </div>
                        
                        <div id="adminSpinner" class="spinner mt-20 mb-20 hidden"></div>
                    </div>
                </div>
                
                <!-- Allocation Status Tab -->
                <div id="allocationsTab" class="admin-tab-content hidden">
                    <div class="admin-controls">
                        <div class="filter-control">
                            <label class="form-label" for="statusFilterAllocations">Filter by Status</label>
                            <select id="statusFilterAllocations" class="form-control">
                                <option value="all">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="search-control filter-control">
                            <label class="form-label" for="searchAllocationsStatus">Search Allocations</label>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchAllocationsStatus" class="form-control" placeholder="Search by hospital or vote number">
                            </div>
                        </div>
                    </div>
                    
                    <div class="allocation-status-cards">
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Pending Allocations</div>
                                <div class="status-card-count status-card-pending" id="pendingAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="pendingAllocationsList">
                                <!-- Pending allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Approved Allocations</div>
                                <div class="status-card-count status-card-approved" id="approvedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="approvedAllocationsList">
                                <!-- Approved allocations will be populated here -->
                            </div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-card-header">
                                <div class="status-card-title">Rejected Allocations</div>
                                <div class="status-card-count status-card-rejected" id="rejectedAllocationsCount">0</div>
                            </div>
                            <div class="selection-list" id="rejectedAllocationsList">
                                <!-- Rejected allocations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Allocation History Tab -->
                <div id="allocationHistoryTab" class="admin-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Allocation History</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryYearFilter">Year</label>
                                <select id="adminHistoryYearFilter" class="form-control">
                                    <option value="all">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryHospitalFilter">Hospital</label>
                                <select id="adminHistoryHospitalFilter" class="form-control">
                                    <option value="all">All Hospitals</option>
                                    <!-- Hospital options will be populated dynamically -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="adminHistoryStatusFilter">Status</label>
                                <select id="adminHistoryStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="history-summary">
                            <div class="history-summary-card">
                                <div class="value" id="adminTotalHistoricalRequests">0</div>
                                <div class="label">Total Requests</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminTotalHistoricalAmount">LKR 0</div>
                                <div class="label">Total Amount</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminAvgApprovalTime">0 days</div>
                                <div class="label">Avg. Approval Time</div>
                            </div>
                            <div class="history-summary-card">
                                <div class="value" id="adminSuccessRate">0%</div>
                                <div class="label">Approval Rate</div>
                            </div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref No.</th>
                                        <th>Hospital</th>
                                        <th>Vote Number</th>
                                        <th>Job Description</th>
                                        <th>Requested Amount</th>
                                        <th>Approved Amount</th>
                                        <th>Status</th>
                                        <th>Submitted Date</th>
                                        <th>Approved Date</th>
                                        <th>Approved By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminHistoryTableBody">
                                    <!-- History data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button id="adminHistoryPrevPage" disabled>Previous</button>
                            <span class="pagination-info" id="adminHistoryPageInfo">Page 1 of 1</span>
                            <button id="adminHistoryNextPage" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <!-- Vote Distribution Tab -->
                <div id="voteDistributionTab" class="admin-tab-content hidden">
                    <div class="vote-distribution">
                        <h2 class="section-title">Vote-wise Allocation Distribution</h2>
                        
                        <div class="form-group">
                            <label class="form-label" for="adminDistributionYearFilter">Select Year</label>
                            <select id="adminDistributionYearFilter" class="form-control">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        
                        <div class="vote-distribution-chart">
                            <canvas id="adminVoteDistributionChart"></canvas>
                        </div>
                        
                        <div class="vote-distribution-table">
                            <div class="table-scroll-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Vote Number</th>
                                            <th>Total Requests</th>
                                            <th>Approved Requests</th>
                                            <th>Total Requested</th>
                                            <th>Total Approved</th>
                                            <th>Approval Rate</th>
                                            <th>Avg. Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adminVoteDistributionTableBody">
                                        <!-- Vote distribution data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportAdminVoteDistribution" class="btn">Export to Excel</button>
                            <button id="printAdminVoteDistribution" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>

                <!-- Hospital Summary Tab -->
                <div id="hospitalSummaryTab" class="admin-tab-content hidden">
                    <div class="allocation-history">
                        <h2 class="section-title">Hospital-wise Allocation Summary</h2>
                        
                        <div class="history-filter">
                            <div class="form-group">
                                <label class="form-label" for="hospitalSummaryYearFilter">Year</label>
                                <select id="hospitalSummaryYearFilter" class="form-control">
                                    <option value="all">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="hospitalSummaryStatusFilter">Status</label>
                                <select id="hospitalSummaryStatusFilter" class="form-control">
                                    <option value="all">All Status</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="hospital-summary-grid" id="hospitalSummaryGrid">
                            <!-- Hospital summary cards will be populated here -->
                        </div>
                        
                        <div class="table-scroll-container mt-20">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hospital</th>
                                        <th>Total Requests</th>
                                        <th>Pending</th>
                                        <th>Approved</th>
                                        <th>Rejected</th>
                                        <th>Total Requested</th>
                                        <th>Total Approved</th>
                                        <th>Approval Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hospitalSummaryTableBody">
                                    <!-- Hospital summary data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="button-group mt-20">
                            <button id="exportHospitalSummary" class="btn">Export to Excel</button>
                            <button id="printHospitalSummary" class="btn btn-secondary">Print Report</button>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reportsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">Generate Reports</h2>
                        
                        <div class="report-controls">
                            <div class="report-control">
                                <label class="form-label" for="reportType">Report Type</label>
                                <select id="reportType" class="form-control">
                                    <option value="allocations">Allocation Summary</option>
                                    <option value="hospitals">Hospital-wise Summary</option>
                                    <option value="votes">Vote-wise Summary</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label" for="hospitalFilter">Hospital</label>
                                <select id="hospitalFilter" class="form-control">
                                    <option value="all">All Hospitals</option>
                                    <!-- Hospital options will be populated here -->
                                </select>
                            </div>
                            
                            <div class="report-control">
                                <label class="form-label">&nbsp;</label>
                                <button id="generateReport" class="btn">Generate Report</button>
                            </div>
                        </div>
                        
                        <div id="reportResults"></div>
                    </div>
                </div>
                
                <!-- System Logs Tab -->
                <div id="logsTab" class="admin-tab-content hidden">
                    <div class="report-section">
                        <h2 class="section-title">System Logs</h2>
                        
                        <div class="admin-controls">
                            <div class="filter-control">
                                <label class="form-label" for="logTypeFilter">Filter by Type</label>
                                <select id="logTypeFilter" class="form-control">
                                    <option value="all">All Logs</option>
                                    <option value="allocation">Allocation</option>
                                    <option value="approval">Approval</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                            <div class="filter-control">
                                <label class="form-label" for="userFilter">Filter by User</label>
                                <select id="userFilter" class="form-control">
                                    <option value="all">All Users</option>
                                    <!-- User options will be populated here -->
                                </select>
                            </div>
                            <div class="search-control filter-control">
                                <label class="form-label" for="searchLogs">Search Logs</label>
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchLogs" class="form-control" placeholder="Search logs...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-table-container">
                            <div class="data-table-header">
                                <div class="data-table-title">System Activity Log</div>
                                <div class="data-table-controls">
                                    <button id="refreshLogs" class="btn btn-secondary">Refresh</button>
                                    <button id="exportLogs" class="btn">Export</button>
                                </div>
                            </div>
                            <div class="table-scroll-container">
                                <table class="user-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Type</th>
                                            <th>User</th>
                                            <th>Action</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemLogsTable">
                                        <!-- Logs will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination">
                                <button id="logsPrevPage" disabled>Previous</button>
                                <span class="pagination-info" id="logsPageInfo">Page 1 of 1</span>
                                <button id="logsNextPage" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- ========== VIEW-ONLY DASHBOARD ========== -->
<div id="viewOnlyDashboard" class="dashboard hidden view-only-dashboard">
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">👁️</span>
                    <span>ADS View Only - Ministry of Health</span>
                </div>
                <div class="user-info">
                    <span class="user-name" id="viewOnlyDisplayName">View Only User</span>
                    <button id="viewOnlyLogout" class="logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="container">
            <h1 class="page-title">Allocation System - View Only Access</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-list-alt"></i></div>
                    <div class="stat-value" id="viewOnlyTotalAllocations">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-value" id="viewOnlyPendingAllocations">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-value" id="viewOnlyApprovedAllocations">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="stat-value" id="viewOnlyTotalAllocatedAmount">0</div>
                    <div class="stat-label">Total Allocated (LKR)</div>
                </div>
            </div>
            
            <div class="view-only-tabs">
                <!-- KEEP ONLY View Allocation Status tab -->
                <div class="view-only-tab active" data-tab="viewAllocations">View Allocation Status</div>
		<div class="view-only-tab" data-tab="viewAnalytics">Analytics Dashboard</div>
                <!-- REMOVE ALL OTHER TABS -->
            </div>
            
            <!-- KEEP ONLY View Allocation Status Tab -->
            <div id="viewAllocationsTab" class="admin-tab-content">
                <div class="admin-controls">
                    <div class="filter-control">
                        <label class="form-label" for="viewStatusFilterAllocations">Filter by Status</label>
                        <select id="viewStatusFilterAllocations" class="form-control">
                            <option value="all">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div class="search-control filter-control">
                        <label class="form-label" for="viewSearchAllocationsStatus">Search Allocations</label>
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="viewSearchAllocationsStatus" class="form-control" placeholder="Search by hospital or vote number">
                        </div>
                    </div>
                </div>
                
                <div class="allocation-status-cards">
                    <div class="status-card">
                        <div class="status-card-header">
                            <div class="status-card-title">Pending Allocations</div>
                            <div class="status-card-count status-card-pending" id="viewPendingAllocationsCount">0</div>
                        </div>
                        <div class="selection-list" id="viewPendingAllocationsList">
                            <!-- Pending allocations will be populated here -->
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <div class="status-card-header">
                            <div class="status-card-title">Approved Allocations</div>
                            <div class="status-card-count status-card-approved" id="viewApprovedAllocationsCount">0</div>
                        </div>
                        <div class="selection-list" id="viewApprovedAllocationsList">
                            <!-- Approved allocations will be populated here -->
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <div class="status-card-header">
                            <div class="status-card-title">Rejected Allocations</div>
                            <div class="status-card-count status-card-rejected" id="viewRejectedAllocationsCount">0</div>
                        </div>
                        <div class="selection-list" id="viewRejectedAllocationsList">
                            <!-- Rejected allocations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
           <!-- Analytics Tab -->
<div id="viewAnalyticsTab" class="admin-tab-content hidden">
    <div class="allocation-history">
        <h2 class="section-title">Analytics Dashboard</h2>
        
        <!-- Quick Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-value" id="analyticsTotalAmount">0</div>
                <div class="stat-label">Total Requested</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-value" id="analyticsApprovedAmount">0</div>
                <div class="stat-label">Total Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                <div class="stat-value" id="analyticsApprovalRate">0%</div>
                <div class="stat-label">Approval Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-hospital"></i></div>
                <div class="stat-value" id="analyticsHospitalsCount">0</div>
                <div class="stat-label">Active Hospitals</div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="admin-controls">
            <div class="filter-control">
                <label class="form-label" for="analyticsYearFilter">Year</label>
                <select id="analyticsYearFilter" class="form-control">
                    <option value="all">All Years</option>
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            <div class="filter-control">
                <label class="form-label" for="analyticsVoteFilter">Vote Number</label>
                <select id="analyticsVoteFilter" class="form-control">
                    <option value="all">All Votes</option>
                </select>
            </div>
            <div class="filter-control">
                <label class="form-label" for="analyticsHospitalFilter">Hospital</label>
                <select id="analyticsHospitalFilter" class="form-control">
                    <option value="all">All Hospitals</option>
                </select>
            </div>
        </div>
        
        <div class="charts-section">
    <h3 class="section-title">Analytics Charts</h3>
    
    <div class="charts-grid">
        <div class="chart-card">
            <h4>Monthly Allocation Trend</h4>
            <canvas id="monthlyTrendChart"></canvas>
        </div>
        <div class="chart-card">
            <h4>Vote-wise Distribution</h4>
            <canvas id="voteDistributionAnalyticsChart"></canvas>
        </div>
        <div class="chart-card">
            <h4>Hospital-wise Allocation</h4>
            <canvas id="hospitalAllocationChart"></canvas>
        </div>
        <div class="chart-card">
            <h4>Status Distribution</h4>
            <canvas id="statusDistributionChart"></canvas>
        </div>
    </div>
</div>
        
        <!-- Summary Tables -->
        <div class="summary-tables" style="margin-bottom: 32px;">
            <h3 class="section-title">Summary Tables</h3>
            
            <!-- Hospital Summary -->
            <div class="data-table-container" style="margin-bottom: 32px;">
                <div class="data-table-header">
                    <div class="data-table-title">Hospital-wise Summary</div>
                    <button id="exportHospitalSummaryAnalytics" class="btn btn-sm">Export to Excel</button>
                </div>
                <div class="table-scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Hospital</th>
                                <th>Total Requests</th>
                                <th>Pending</th>
                                <th>Approved</th>
                                <th>Rejected</th>
                                <th>Requested Amount</th>
                                <th>Approved Amount</th>
                                <th>Approval Rate</th>
                                <th>Avg. Processing Time</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalAnalyticsTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Vote Summary -->
            <div class="data-table-container" style="margin-bottom: 32px;">
                <div class="data-table-header">
                    <div class="data-table-title">Vote-wise Summary</div>
                    <button id="exportVoteSummaryAnalytics" class="btn btn-sm">Export to Excel</button>
                </div>
                <div class="table-scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Vote Number</th>
                                <th>Total Requests</th>
                                <th>Approved</th>
                                <th>Rejected</th>
                                <th>Total Requested</th>
                                <th>Total Approved</th>
                                <th>Approval Rate</th>
                                <th>Avg. Amount</th>
                            </tr>
                        </thead>
                        <tbody id="voteAnalyticsTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Monthly Summary -->
            <div class="data-table-container">
                <div class="data-table-header">
                    <div class="data-table-title">Monthly Summary</div>
                    <button id="exportMonthlySummaryAnalytics" class="btn btn-sm">Export to Excel</button>
                </div>
                <div class="table-scroll-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Requests</th>
                                <th>Approved</th>
                                <th>Rejected</th>
                                <th>Total Requested</th>
                                <th>Total Approved</th>
                                <th>Approval Rate</th>
                                <th>Avg. Processing Time</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyAnalyticsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Detailed Data Table -->
        <div class="detailed-data" style="margin-bottom: 32px;">
            <h3 class="section-title">Detailed Allocation Data</h3>
            
            <div class="admin-controls">
                <div class="search-control filter-control">
                    <label class="form-label" for="searchAnalyticsData">Search Data</label>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchAnalyticsData" class="form-control" placeholder="Search by hospital, vote number, or reference">
                    </div>
                </div>
                <div class="filter-control">
                    <label class="form-label">&nbsp;</label>
                    <button id="exportAllAnalyticsData" class="btn">Export All Data to Excel</button>
                </div>
            </div>
            
            <div class="table-scroll-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ref No.</th>
                            <th>Hospital</th>
                            <th>Vote Number</th>
                            <th>Job Description</th>
                            <th>Requested Amount</th>
                            <th>Approved Amount</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Submitted Date</th>
                            <th>Approved Date</th>
                            <th>Processing Time</th>
                            <th>Approving Authority</th>
                        </tr>
                    </thead>
                    <tbody id="detailedAnalyticsTableBody"></tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button id="analyticsPrevPage" disabled>Previous</button>
                <span class="pagination-info" id="analyticsPageInfo">Page 1 of 1</span>
                <button id="analyticsNextPage" disabled>Next</button>
            </div>
        </div>
    </div>
</div>
            
     
       <!-- Approval Modal -->
    <div id="approvalModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Approve Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="uniquePassword">Request Password *</label>
                    <input type="password" id="uniquePassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-section">
    <h4 class="section-title">Allocation Details</h4>
    <div class="enhanced-pdf-section">
        <div><strong>Reference:</strong> <span id="approvalRefNumber"></span></div>
        <div><strong>Hospital:</strong> <span id="approvalHospital"></span></div>
        <div><strong>Vote Number:</strong> <span id="approvalVoteNumber"></span></div>
        <div><strong>Job Description:</strong> <span id="approvalJobDescription"></span></div>
        <div><strong>Requested Amount:</strong> <span id="approvalRequestedAmount"></span></div>
        <div><strong>Priority:</strong> <span id="approvalPriority"></span></div>
        <!-- ADDED: Additional Notes with red highlighting -->
        <div style="margin-top: 10px; padding: 10px; background-color: #ffebee; border-left: 4px solid #ea4335; border-radius: 4px;">
            <strong style="color: #ea4335;">Additional Notes from Request:</strong>
            <div id="approvalAdditionalNotes" style="color: #333; margin-top: 5px; font-size: 14px;"></div>
        </div>
    </div>
</div>                
                <div class="form-section">
                    <h4 class="section-title">Approval Details</h4>
                    <div class="form-group">
                        <label class="form-label" for="approvedAmount">Approved Amount (LKR) *</label>
                        <input type="number" id="approvedAmount" class="form-control" placeholder="Enter approved amount" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvalNotes">Approval Notes</label>
                        <textarea id="approvalNotes" class="form-control" rows="3" placeholder="Add any notes about the approval..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="approvingAuthority">Approving Authority *</label>
                        <select id="approvingAuthority" class="form-control" required>
                            <option value="">Select approving authority</option>
                            <option value="Deputy Director General (Logistics)">Deputy Director General (Logistics)</option>
                            <option value="Director Building (Administration)">Director Building (Administration)</option>
                        </select>
                    </div>
                </div>
            </div>

		<!-- Add this in the approval modal body, after the approving authority field -->
<div class="form-group">
    <label class="form-label" for="approvalDate">Approval Date *</label>
    <input type="date" id="approvalDate" class="form-control" required>
</div>

            <div class="modal-footer">
                <button id="rejectRequest" class="btn btn-danger">Reject Request</button>
                <button id="confirmApproval" class="btn">Approve Request</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editHospitalName">Hospital Name</label>
                            <input type="text" id="editHospitalName" class="form-control readonly" readonly>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPerson">Contact Person</label>
                            <input type="text" id="editContactPerson" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactPhone">Contact Phone</label>
                            <input type="tel" id="editContactPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editContactEmail">Contact Email</label>
                            <input type="email" id="editContactEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editVoteNumber">Vote Number</label>
                            <select id="editVoteNumber" class="form-control">
                                <option value="">-- Select Vote Number --</option>
                                <option value="111-1-5-2001(11) Building Rehabilitation-Hospital">111-1-5-2001(11) Building Rehabilitation-Hospital</option>
                                <option value="111-1-5-2002(11) Service and Maintenance-Hospital">111-1-5-2002(11) Service and Maintenance-Hospital</option>
                                <option value="111-1-5-2103(11) Machinery Purchasing-Hospitals">111-1-5-2103(11) Machinery Purchasing-Hospitals</option>
                                <option value="111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions">111-1-5-0-1409-138(11) Service and Maintenance Agreements-Hospital & Other Institutions</option>
                                <option value="111-2-26-2001(11) Building Rehabilitation-Other Health Institutions">111-2-26-2001(11) Building Rehabilitation-Other Health Institutions</option>
                                <option value="111-2-26-2002(11) Service and Maintenance-Other Health Institutions">111-2-26-2002(11) Service and Maintenance-Other Health Institutions</option>
                                <option value="111-2-20-001-2001(11) Building Rehabilitation-NTS">111-2-20-001-2001(11) Building Rehabilitation-NTS</option>
                                <option value="111-2-20-001-2002(11) Service and Maintenance-NTS">111-2-20-001-2002(11) Service and Maintenance-NTS</option>
                                <option value="111-2-20-001-2103(11) Machinery Purchasing-NTS">111-2-20-001-2103(11) Machinery Purchasing-NTS</option>
                                <option value="111-2-26-008-2001(11) Strengthening Primary Level Health Care">111-2-26-008-2001(11) Strengthening Primary Level Health Care</option>
                                <option value="111-1-2-2001(11) Building and Structures- Ministry Administration">111-1-2-2001(11) Building and Structures- Ministry Administration</option>
                                <option value="111-1-1-2001(11) Building and Structures- Minister Office">111-1-1-2001(11) Building and Structures- Minister Office</option>
                                <option value="111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office">111-1-1-2002(11) Plant, Machinery & Equipment Service & Maintenance - Minister Office</option>
                                <option value="111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration">111-1-2-2002(11) Plant, Machinery & Equipment Service & Maintenance - Ministry Administration</option>
                                <option value="111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration">111-1-2-2103(11) Plant, Machinery & Equipment Purchasing - Ministry Administration</option>
                                <option value="111-1-2-2505(11) Procurement Preparedness">111-1-2-2505(11) Procurement Preparedness</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editJobDescription">Job Description</label>
                            <textarea id="editJobDescription" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredAmount">Required Amount (LKR)</label>
                            <input type="number" id="editRequiredAmount" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editPriorityLevel">Priority Level</label>
                            <select id="editPriorityLevel" class="form-control">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                                <option value="Critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editRequiredDate">Required Date</label>
                            <input type="date" id="editRequiredDate" class="form-control">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="editAdditionalNotes">Additional Notes</label>
                            <textarea id="editAdditionalNotes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEdit" class="btn btn-danger">Cancel</button>
                <button id="confirmEdit" class="btn">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- View Modal -->
    <div id="viewModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Allocation Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="enhanced-pdf">
                    <div class="enhanced-pdf-header">
                        <div class="enhanced-pdf-title">Ministry of Health</div>
                        <div class="enhanced-pdf-subtitle">Allocation Request Details</div>
                    </div>
                    <div class="enhanced-pdf-grid">
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Request Reference:</div>
                            <div class="enhanced-pdf-value" id="viewRefNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Submission Date:</div>
                            <div class="enhanced-pdf-value" id="viewDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Hospital Details:</div>
                            <div class="enhanced-pdf-value" id="viewHospitalDetails"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Vote Number:</div>
                            <div class="enhanced-pdf-value" id="viewVoteNumber"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Job Description:</div>
                            <div class="enhanced-pdf-value" id="viewJobDescription"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Requested Amount:</div>
                            <div class="enhanced-pdf-value" id="viewRequestedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approved Amount:</div>
                            <div class="enhanced-pdf-value" id="viewApprovedAmount"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Priority Level:</div>
                            <div class="enhanced-pdf-value" id="viewPriority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Required Date:</div>
                            <div class="enhanced-pdf-value" id="viewRequiredDate"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Additional Notes:</div>
                            <div class="enhanced-pdf-value" id="viewAdditionalNotes"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Status:</div>
                            <div class="enhanced-pdf-value" id="viewStatus"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approving Authority:</div>
                            <div class="enhanced-pdf-value" id="viewApprovingAuthority"></div>
                        </div>
                        <div class="enhanced-pdf-section">
                            <div class="enhanced-pdf-label">Approval Notes:</div>
                            <div class="enhanced-pdf-value" id="viewApprovalNotes"></div>
                        </div>
                    </div>
			<div class="enhanced-pdf-section" id="rejectionSection" style="display: none; background-color: #ffebee; border-left: 4px solid #ea4335;">
                    <div class="enhanced-pdf-label" style="color: #ea4335;">Rejection Reason</div>
                    <div class="enhanced-pdf-value" id="viewRejectionReason" style="color: #333; font-weight: 500;"></div>
                </div>
		  <!-- Hospital Section Signature -->
                        <div class="hospital-signature-section">
                            <div class="signature-line"></div>
                            <div class="signature-label">Hospital Authorization:</div>
                            <div class="signature-name" id="hospitalSignatureName">[Hospital Director/Deputy Director General]</div>
                            <div class="signature-title" id="hospitalSignatureTitle">[Position]</div>
                            <div class="signature-title" id="hospitalSignatureInstitution">[Hospital Name]</div>
                        </div>

                    <div class="signature-section">
                        <!-- DDG Only Signature (shown when approved by DDG) -->
                        <div class="signature-ddgonly" id="ddgSignatureSection">
                            <div class="signature-line"></div>
                            <div class="signature-label">Approval Signature:</div>
                            <div class="signature-name">H.M.N Dinipriya Herath</div>
                            <div class="signature-title">Deputy Director General (Logistics)</div>
                            <div class="signature-title">For Secretary</div>
                        </div>
                        
                        <!-- Director Only Signature (shown when approved by Director) -->
                        <div class="signature-directoronly" id="directorSignatureSection">
                            <div class="signature-line"></div>
                            <div class="signature-label">Approval Signature:</div>
                            <div class="signature-name">Director Building Branch</div>
                            <div class="signature-title">Director Building Branch (Administration)</div>
                        </div>
                        
                      
                        
                        <div class="mt-20">
                            <div class="signature-label">Copies:</div>
                            <div class="signature-title">1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)</div>
                            <div class="signature-title">2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeView" class="btn">Close</button>
                <button id="downloadFinalPdf" class="btn btn-secondary">Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="rejectionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reject Allocation Request</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="rejectionPassword">Request Password *</label>
                    <input type="password" id="rejectionPassword" class="form-control" placeholder="Enter request password for verification" required>
                    <small class="form-text">Enter the unique password provided for this request</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Request Details:</label>
                    <div id="rejectionRequestDetails" class="enhanced-pdf-section">
                        <div><strong>Reference:</strong> <span id="rejectionRefNumber"></span></div>
                        <div><strong>Hospital:</strong> <span id="rejectionHospital"></span></div>
                        <div><strong>Vote Number:</strong> <span id="rejectionVoteNumber"></span></div>
                        <div><strong>Requested Amount:</strong> <span id="rejectionRequestedAmount"></span></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="rejectionReason">Rejection Reason *</label>
                    <textarea id="rejectionReason" class="form-control" rows="4" placeholder="Provide detailed reason for rejection..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelRejection" class="btn btn-secondary">Cancel</button>
                <button id="confirmRejection" class="btn btn-danger">Reject Request</button>
            </div>
        </div>
    </div>

    <!-- Admin Password Modal -->
    <div id="adminPasswordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Admin Authentication Required</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="adminPassword">Admin Password *</label>
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelAdminPassword" class="btn btn-danger">Cancel</button>
                <button id="confirmAdminPassword" class="btn">Authenticate</button>
            </div>
        </div>
    </div>

    <!-- Hospital History Modal -->
    <div id="hospitalHistoryModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Hospital Allocation History</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h4 id="hospitalHistoryTitle" style="margin-bottom: 15px;"></h4>
                </div>
                
                <div class="history-summary">
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryTotalRequests">0</div>
                        <div class="label">Total Requests</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryTotalAmount">LKR 0</div>
                        <div class="label">Total Amount</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryApprovedCount">0</div>
                        <div class="label">Approved</div>
                    </div>
                    <div class="history-summary-card">
                        <div class="value" id="hospitalHistoryApprovalRate">0%</div>
                        <div class="label">Approval Rate</div>
                    </div>
                </div>
                
                <div class="table-scroll-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Ref No.</th>
                                <th>Vote Number</th>
                                <th>Job Description</th>
                                <th>Requested Amount</th>
                                <th>Approved Amount</th>
                                <th>Status</th>
                                <th>Submitted Date</th>
                                <th>Approved Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hospitalHistoryTableBody">
                            <!-- Hospital history data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeHospitalHistory" class="btn">Close</button>
                <button id="exportHospitalHistory" class="btn btn-secondary">Export History</button>
            </div>
        </div>
    </div>

    <script>
     // Google Apps Script Web App URL
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbytS1JHS5rsQf3Oc9EVnjunOZjCJF2l4TYvAdPcv_j2yOHwg82jkNC5i2tRIaaNNG1o/exec';

// Global variables
let currentUserRole = 'hospital';
let currentUserId = null;
let currentRequestId = null;
let currentRequestRef = null;
let currentPage = 1;
const itemsPerPage = 10;
let allAllocations = [];
let filteredAllocations = [];
let systemLogs = [];
let currentUserIsViewOnly = false;

// Admin password
const ADMIN_PASSWORD = "";

// Pending action variables
let pendingAction = null;
let pendingRequestId = null;

// Pagination variables
let myRequestsPage = 1;
let myRequestsItemsPerPage = 10;
let filteredMyRequests = [];

let logsPage = 1;
let logsItemsPerPage = 15;
let filteredLogs = [];

// Hospital accounts
const hospitalAccounts = {
    'Ministry of Health': { password: 'moh123' },
    'National Hospital Sri Lanka': { password: 'nhsl123' },
    'Colombo South Teaching Hospital': { password: 'csth123' },
    'Lady Ridgeway Hospital': { password: 'lrh123' },
    'Apeksha Hospital Maharagama': { password: 'ahm123' },
    'Colombo East Base Hospital Mulleriyawa': { password: 'cebhm123' },
    'Infections Diseases Hospital': { password: 'idh123' },
    'NIMH': { password: 'nimh123' },
    'De Soysa Hospital': { password: 'dsh123' },
    'Castle Street Hospital for Women': { password: 'csshw123' },
    'National Eye Hospital': { password: 'neh123' },
    'Institute of Oral Health-Maharagama': { password: 'iohm123' },
    'National Blood Transfusion Service': { password: 'nbts123' },
    'National Institute for Nephrology Dialysis and Transplantation - Maligawatta': { password: 'nindtm123' },
    'Medical Research Institute': { password: 'mri123' },
    'National Dental Hospital': { password: 'ndh123' },
    'Colombo North Teaching Hospital - Ragama': { password: 'cnthr123' },
    'Rheumatology & Rehabilitation Hospital, Ragama': { password: 'rrhr123' },
    'District Hospital Kandana': { password: 'dhk123' },
    'National Hospital for Respiratory Diseases, Welisara': { password: 'nhrdw123' },
    'Leprosy Hospital - Handala': { password: 'lhh123' },
    'DGH Negombo (District General Hospital)': { password: 'dghn123' },
    'Teaching Hospital Kalutara': { password: 'thk123' },
    'National Institute of Health Sciences Kalutara': { password: 'nihsk123' },
    'National Hospital - Kandy': { password: 'nhk123' },
    'Base Hospital Gampola': { password: 'bhg123' },
    'Teaching Hospital Peradeniya': { password: 'thp123' },
    'Sirimavo Bandaranayake Hospital - Peradeniya': { password: 'sbhp123' },
    'District General Hospital Nawalapitiya': { password: 'dghn123' },
    'District General Hospital NuwaraEliya': { password: 'dghne123' },
    'District General Hospital Matale': { password: 'dghm123' },
    'National Hospital - Galle (Karapitiya)': { password: 'nhg123' },

    'Deputy Director General (Planning)': { password: 'ddgp123' },
    'Accountant (Budget Control)': { password: 'abc123' },
    'German Sri Lanka Friendship Hospital for Women - Galle (Mahamodara)': { password: 'gslfhwg123' },
    'District General Hospital Matara': { password: 'dghm123' },
    'District General Hospital Hambantota': { password: 'dghh123' },
    'TH Jaffna': { password: 'thj123' },
    'Base Hospital Akkaraipattu': { password: 'bha123' },
    'Ashroff Hospital - Kalmunai': { password: 'ahk123' },
    'Base Hospital Kalmunai North': { password: 'bhkn123' },
    'District General Hospital Ampara': { password: 'dgha123' },
    'Base Hospital Pottuvil': { password: 'bhp123' },
    'District General Hospital Trincomalee': { password: 'dght123' },
    'District General Hospital Kantale': { password: 'dghk123' },
    'Teaching Hospital Batticaloa': { password: 'thb123' },
    'District General Hospital Chilaw': { password: 'dghc123' },
    'Teaching Hospital Kurunegala': { password: 'thk123' },
    'Teaching Hospital Kuliyapitiya': { password: 'thk123' },
    'District General Hospital Polonnaruwa': { password: 'dghp123' },
    'China Sri Lanka Friendship National Nephrology Specialized Hospital, Polonnaruwa (CKD Hospital)': { password: 'cslfnshp123' },
    'TH Anuradhapura': { password: 'tha123' },
    'TH Badulla': { password: 'thb123' },
    'District General Hospital Monaragala': { password: 'dghm123' },
    'District General Hospital Kegalle': { password: 'dghk123' },
    'Teaching Hospital Ratnapura': { password: 'thr123' },
    'District General Hospital Embilipitiya': { password: 'dghe123' },
    'National STD/AIDS Control Programme': { password: 'nsacp123' },
    'Biomedical Engineering Services': { password: 'bes123' },
    'Epidemiology Unit': { password: 'eu123' },
    'National Cancer Control Programme': { password: 'nccp123' },
    'National Programme for Tuberculosis Control & Chest Diseases': { password: 'nptccd123' },
    'Institute for Forensic Medicine & Toxicology': { password: 'ifmt123' },
    'Health Promotion Bureau': { password: 'hpb123' },
    'Dengue Control Programme': { password: 'dcp123' },
    'Anti Malaria Campaign': { password: 'amc123' },
    'Family Health Bureau': { password: 'fhb123' },
    'Anti Filariasis Campaign': { password: 'afc123' },
    'Medical Supplies Division': { password: 'msd123' },
    'Public Health Veterinary Services': { password: 'phvs123' },
};

// Admin accounts
const adminAccounts = {
    'ddg_logistics': { name: 'Deputy Director General (Logistics)', password: 'ddg123', permissions: ['full'] },
    'director_building': { name: 'Director Building (Administration)', password: 'dba123', permissions: ['full'] },
    'ddg_planning': { name: 'Deputy Director General (Planning)', password: 'ddgp123', permissions: ['view_only'] },
    'accountant_budget': { name: 'Accountant (Budget Control)', password: 'abc123', permissions: ['view_only'] }
};

// Hospital Signatories Database
const hospitalSignatories = {
    'National Hospital Sri Lanka': { 
        name: '', 
        title: 'Director',
        institution: 'National Hospital Sri Lanka'
    },
    'Colombo South Teaching Hospital': { 
        name: '', 
        title: 'Deputy Director General',
        institution: 'Colombo South Teaching Hospital'
    },
    'Lady Ridgeway Hospital': { 
        name: '', 
        title: 'Director',
        institution: 'Lady Ridgeway Hospital'
    },
    'Apeksha Hospital Maharagama': { 
        name: '', 
        title: 'Director',
        institution: 'Apeksha Hospital Maharagama'
    },
    'Colombo East Base Hospital Mulleriyawa': { 
        name: '', 
        title: 'Director',
        institution: 'Colombo East Base Hospital Mulleriyawa'
    },
    'National Hospital - Kandy': { 
        name: '', 
        title: 'Director',
        institution: 'National Hospital - Kandy'
    },
    'National Hospital - Galle (Karapitiya)': { 
        name: '', 
        title: 'Director',
        institution: 'National Hospital - Galle'
    },
    'Teaching Hospital Kurunegala': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Kurunegala'
    },
    'TH Anuradhapura': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Anuradhapura'
    },
    'Teaching Hospital Batticaloa': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Batticaloa'
    },
    'TH Jaffna': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Jaffna'
    },
    'Teaching Hospital Ratnapura': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Ratnapura'
    },
    'TH Badulla': { 
        name: '', 
        title: 'Director',
        institution: 'Teaching Hospital Badulla'
    },
    'Ministry of Health': { 
        name: '', 
        title: ' Director Building Administration',
        institution: 'Ministry of Health'
    }
};

// ========== ENHANCED STATUS STYLES ==========
const enhancedStatusStyles = `
/* ========== ENHANCED STATUS BADGES ========== */
.status-badge-enhanced {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 100px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.status-badge-enhanced::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: currentColor;
    opacity: 0.3;
}

.status-badge-enhanced.pending {
    background: linear-gradient(135deg, #ffeb3b 0%, #fbc02d 100%);
    color: #856404;
    border: 2px solid #ffc107;
    animation: pulse 2s infinite;
}

.status-badge-enhanced.approved {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    color: #155724;
    border: 2px solid #28a745;
}

.status-badge-enhanced.rejected {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    color: #721c24;
    border: 2px solid #dc3545;
}

.status-badge-enhanced.completed {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: #004085;
    border: 2px solid #17a2b8;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

/* ========== STATUS CARDS ENHANCED ========== */
.status-card-enhanced {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-lg);
    border-top: 5px solid;
    transition: transform 0.3s ease;
}

.status-card-enhanced:hover {
    transform: translateY(-5px);
}

.status-card-enhanced.pending {
    border-color: var(--warning);
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
}

.status-card-enhanced.approved {
    border-color: var(--secondary);
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
}

.status-card-enhanced.rejected {
    border-color: var(--danger);
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
}

.status-card-enhanced.completed {
    border-color: var(--primary);
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.status-card-count-enhanced {
    font-size: 32px;
    font-weight: 800;
    margin: 10px 0;
    display: block;
}

.status-card-label-enhanced {
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* ========== ENHANCED TABLE STYLES ========== */
.enhanced-table-row {
    transition: all 0.3s ease;
}

.enhanced-table-row:hover {
    transform: scale(1.005);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
`;

// Add the CSS to the document
const styleSheet = document.createElement("style");
styleSheet.textContent = enhancedStatusStyles;
document.head.appendChild(styleSheet);

// Initialize localStorage if not exists
function initializeLocalStorage() {
    if (!localStorage.getItem('allocations')) {
        localStorage.setItem('allocations', JSON.stringify([]));
    }
    if (!localStorage.getItem('systemLogs')) {
        localStorage.setItem('systemLogs', JSON.stringify([]));
    }
}

// Utility Functions
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    const date = new Date(dateTimeString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function showElement(element, show = true) {
    if (element) {
        element.style.display = show ? 'block' : 'none';
    }
}

function showMessage(message, type = 'error') {
    const loginMessage = document.getElementById('loginMessage');
    loginMessage.textContent = message;
    loginMessage.style.color = type === 'error' ? 'red' : 'green';
    showElement(loginMessage);
    setTimeout(() => showElement(loginMessage, false), 5000);
}

function generateUniquePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let password = '';
    for (let i = 0; i < 6; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

function formatCurrency(amount) {
    // Convert to number first
    let num = parseFloat(amount);
    
    // Check if it's a valid number
    if (isNaN(num)) {
        return 'LKR 0';
    }
    
    // Format with 2 decimal places and commas for thousands
    return 'LKR ' + num.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Enhanced Status Display Functions
function getEnhancedStatusBadge(status, isEnhanced = true) {
    if (!isEnhanced) {
        const statusClass = `status-${status.toLowerCase()}`;
        return `<span class="status-badge ${statusClass}">${status}</span>`;
    }
    
    const statusClass = `status-badge-enhanced ${status.toLowerCase()}`;
    let icon = '';
    
    switch(status.toLowerCase()) {
        case 'pending':
            icon = '<i class="fas fa-clock mr-5"></i>';
            break;
        case 'approved':
            icon = '<i class="fas fa-check-circle mr-5"></i>';
            break;
        case 'rejected':
            icon = '<i class="fas fa-times-circle mr-5"></i>';
            break;
        case 'completed':
            icon = '<i class="fas fa-check-double mr-5"></i>';
            break;
        default:
            icon = '<i class="fas fa-info-circle mr-5"></i>';
    }
    
    return `<span class="${statusClass}">${icon}${status}</span>`;
}

// System Logging Function
function logSystemActivity(type, user, action, details = '') {
    const log = {
        timestamp: new Date().toISOString(),
        type: type,
        user: user,
        action: action,
        details: details
    };
    
    const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
    logs.unshift(log);
    if (logs.length > 1000) logs.pop();
    localStorage.setItem('systemLogs', JSON.stringify(logs));
    
    systemLogs = logs;
    
    const logsTab = document.getElementById('logsTab');
    if (logsTab && !logsTab.classList.contains('hidden')) {
        filterLogs();
    }
}

// Update pending allocation notification
function updatePendingAllocationNotification() {
    const pendingAllocationBadge = document.getElementById('pendingAllocationBadge');
    const pendingCount = allAllocations.filter(allocation => allocation.status === 'Pending').length;
    if (pendingCount > 0) {
        pendingAllocationBadge.textContent = pendingCount;
        showElement(pendingAllocationBadge);
    } else {
        showElement(pendingAllocationBadge, false);
    }
}

// Admin password authentication
function authenticateAdmin(action, requestId = null) {
    pendingAction = action;
    pendingRequestId = requestId;
    document.getElementById('adminPassword').value = '';
    showElement(document.getElementById('adminPasswordModal'));
}

function executePendingAction() {
    if (pendingAction === 'edit') {
        openEditModal(pendingRequestId);
    } else if (pendingAction === 'delete') {
        deleteAllocation(pendingRequestId);
    }
    
    pendingAction = null;
    pendingRequestId = null;
}

// API Functions
async function callGoogleAppsScript(action, data = {}) {
    try {
        const formData = new URLSearchParams();
        formData.append('action', action);
        
        for (const [key, value] of Object.entries(data)) {
            formData.append(key, value);
        }

        const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
    } catch (error) {
        console.error('API call failed:', error);
        return getMockData(action, data);
    }
}

// Enhanced Mock Data
function getMockData(action, data) {
    switch(action) {
        case 'login':
    if (data.role === 'admin' && data.password === 'ADS005') {
        logSystemActivity('system', 'Administrator', 'Login', 'Main admin login successful');
        return { success: true, message: 'Login successful', role: 'mainadmin' };
    }
    if (data.role === 'admin' && data.userId && adminAccounts[data.userId] && data.password === adminAccounts[data.userId].password) {
        logSystemActivity('system', 'Admin', 'Login', `Admin ${data.userId} login successful`);
        const userAccount = adminAccounts[data.userId];
        return { 
            success: true, 
            message: 'Login successful', 
            userName: userAccount.name, 
            userId: data.userId,
            isViewOnly: userAccount.permissions && userAccount.permissions.includes('view_only')
        };
    }
    if (data.role === 'hospital' && data.hospitalId && hospitalAccounts[data.hospitalId] && data.password === hospitalAccounts[data.hospitalId].password) {
        logSystemActivity('system', 'Hospital', 'Login', `Hospital ${data.hospitalId} login successful`);
        return { success: true, message: 'Login successful', hospitalName: data.hospitalId, hospitalId: data.hospitalId };
    }
    return { success: false, error: 'Invalid credentials' };
        
        case 'submitAllocation':
            const refNumber = 'ADS-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            const uniquePassword = generateUniquePassword();
            
            const allocation = {
                id: Date.now(),
                refnumber: refNumber,
                hospitalname: data.hospitalName,
                contactperson: data.contactPerson,
                contactphone: data.contactPhone,
                contactemail: data.contactEmail,
                votenumber: data.voteNumber,
                jobdescription: data.jobDescription,
                requiredamount: data.requiredAmount,
                approvedamount: 0,
                prioritylevel: data.priorityLevel,
                requireddate: data.requiredDate,
                additionalnotes: data.additionalNotes || '',
                status: 'Pending',
                approvingauthority: '',
                approvalnotes: '',
                rejectionreason: '',
                timestamp: new Date().toISOString(),
                uniquepassword: uniquePassword,
                hospitalId: data.hospitalId,
                approvaldate: null
            };
            
            let allocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            allocations.push(allocation);
            localStorage.setItem('allocations', JSON.stringify(allocations));
            
            logSystemActivity('allocation', data.hospitalName, 'Allocation Submitted', `Ref: ${refNumber}`);
            
            return {
                success: true,
                message: 'Allocation request submitted successfully',
                requestId: allocation.id,
                refNumber: refNumber,
                uniquePassword: uniquePassword
            };
        
        case 'getAllocations':
            const storedAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            return { allocations: storedAllocations };
        
       case 'approveAllocation':
    let allAllocationsData = JSON.parse(localStorage.getItem('allocations') || '[]');
    
    const allocationIndex = allAllocationsData.findIndex(a => a.id == data.requestId);
    
    if (allocationIndex === -1) {
        return { success: false, error: 'Allocation not found' };
    }
    
    const storedPassword = allAllocationsData[allocationIndex].uniquepassword;
    const enteredPassword = data.uniquePassword;
    
    if (!storedPassword || !enteredPassword) {
        return { success: false, error: 'Password is required' };
    }
    
    if (storedPassword.toUpperCase() !== enteredPassword.toUpperCase()) {
        return { success: false, error: 'Invalid request password. Please check and try again.' };
    }
    
    allAllocationsData[allocationIndex].approvedamount = data.approvedAmount;
    allAllocationsData[allocationIndex].approvingauthority = data.approvingAuthority;
    allAllocationsData[allocationIndex].approvalnotes = data.approvalNotes || '';
    allAllocationsData[allocationIndex].status = 'Approved';
    // Use provided approval date or current date
    allAllocationsData[allocationIndex].approvaldate = data.approvalDate || new Date().toISOString();
    
    localStorage.setItem('allocations', JSON.stringify(allAllocationsData));
    
    logSystemActivity('approval', 'Administrator', 'Allocation Approved', 
        `Request: ${allAllocationsData[allocationIndex].refnumber}, Amount: ${data.approvedAmount}, Authority: ${data.approvingAuthority}, Date: ${data.approvalDate}`);
    
    return { success: true, message: 'Allocation approved successfully' };
        
        case 'rejectAllocation':
            let rejectAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            
            const rejectIndex = rejectAllocations.findIndex(a => a.id == data.requestId);
            
            if (rejectIndex === -1) {
                return { success: false, error: 'Allocation not found' };
            }
            
            const storedRejectPassword = rejectAllocations[rejectIndex].uniquepassword;
            const enteredRejectPassword = data.uniquePassword;
            
            if (!storedRejectPassword || !enteredRejectPassword) {
                return { success: false, error: 'Password is required' };
            }
            
            if (storedRejectPassword.toUpperCase() !== enteredRejectPassword.toUpperCase()) {
                return { success: false, error: 'Invalid request password. Please check and try again.' };
            }
            
            rejectAllocations[rejectIndex].rejectionreason = data.rejectionReason;
            rejectAllocations[rejectIndex].status = 'Rejected';
            
            localStorage.setItem('allocations', JSON.stringify(rejectAllocations));
            
            logSystemActivity('rejection', 'Administrator', 'Allocation Rejected', 
                `Request: ${rejectAllocations[rejectIndex].refnumber}, Reason: ${data.rejectionReason}`);
            
            return { success: true, message: 'Allocation rejected successfully' };
        
        case 'editAllocation':
            let editAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            const editIndex = editAllocations.findIndex(a => a.id == data.requestId);
            
            if (editIndex === -1) {
                return { success: false, error: 'Allocation not found' };
            }
            
            editAllocations[editIndex].hospitalname = data.hospitalName;
            editAllocations[editIndex].contactperson = data.contactPerson;
            editAllocations[editIndex].contactphone = data.contactPhone;
            editAllocations[editIndex].contactemail = data.contactEmail;
            editAllocations[editIndex].votenumber = data.voteNumber;
            editAllocations[editIndex].jobdescription = data.jobDescription;
            editAllocations[editIndex].requiredamount = data.requiredAmount;
            editAllocations[editIndex].prioritylevel = data.priorityLevel;
            editAllocations[editIndex].requireddate = data.requiredDate;
            editAllocations[editIndex].additionalnotes = data.additionalNotes || '';
            
            localStorage.setItem('allocations', JSON.stringify(editAllocations));
            
            logSystemActivity('allocation', 'Administrator', 'Allocation Updated', `Ref: ${editAllocations[editIndex].refnumber}`);
            
            return { success: true, message: 'Allocation updated successfully' };
        
        case 'deleteAllocation':
            let deleteAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            const deleteIndex = deleteAllocations.findIndex(a => a.id == data.requestId);
            
            if (deleteIndex === -1) {
                return { success: false, error: 'Allocation not found' };
            }
            
            const deletedRef = deleteAllocations[deleteIndex].refnumber;
            deleteAllocations.splice(deleteIndex, 1);
            localStorage.setItem('allocations', JSON.stringify(deleteAllocations));
            
            logSystemActivity('allocation', 'Administrator', 'Allocation Deleted', `Ref: ${deletedRef}`);
            
            return { success: true, message: 'Allocation deleted successfully' };
        
        case 'getReports':
            const reportAllocations = JSON.parse(localStorage.getItem('allocations') || '[]');
            
            let filteredData = reportAllocations;
            
            if (data.startDate && data.endDate) {
                const startTimestamp = new Date(data.startDate).getTime();
                const endTimestamp = new Date(data.endDate).getTime() + 86400000;
                
                filteredData = reportAllocations.filter(allocation => {
                    const allocationTime = new Date(allocation.timestamp).getTime();
                    return allocationTime >= startTimestamp && allocationTime < endTimestamp;
                });
            }
            
            if (data.hospital && data.hospital !== 'all') {
                filteredData = filteredData.filter(allocation => allocation.hospitalname === data.hospital);
            }
            
            let reportData = [];
            let title = '';
            
            switch(data.type) {
                case 'allocations':
                    title = 'Allocation Summary Report';
                    reportData = [['Request Ref', 'Hospital', 'Vote Number', 'Job Description', 'Requested Amount', 'Approved Amount', 'Status', 'Date']];
                    filteredData.forEach(allocation => {
                        reportData.push([
                            allocation.refnumber,
                            allocation.hospitalname,
                            allocation.votenumber,
                            allocation.jobdescription.substring(0, 50) + (allocation.jobdescription.length > 50 ? '...' : ''),
                            formatCurrency(allocation.requiredamount),
                            allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved',
                            allocation.status,
                            formatDate(allocation.timestamp)
                        ]);
                    });
                    break;
                    
                case 'hospitals':
                    title = 'Hospital-wise Summary Report';
                    const hospitalData = {};
                    
                    filteredData.forEach(allocation => {
                        if (!hospitalData[allocation.hospitalname]) {
                            hospitalData[allocation.hospitalname] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                        }
                        hospitalData[allocation.hospitalname].total++;
                        hospitalData[allocation.hospitalname][allocation.status.toLowerCase()]++;
                        hospitalData[allocation.hospitalname].totalRequested += parseFloat(allocation.requiredamount);
                        if (allocation.approvedamount > 0) {
                            hospitalData[allocation.hospitalname].totalApproved += parseFloat(allocation.approvedamount);
                        }
                    });
                    
                    reportData = [['Hospital', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                    Object.keys(hospitalData).forEach(hospital => {
                        const data = hospitalData[hospital];
                        reportData.push([
                            hospital,
                            data.total.toString(),
                            data.pending.toString(),
                            data.approved.toString(),
                            data.rejected.toString(),
                            formatCurrency(data.totalRequested),
                            formatCurrency(data.totalApproved)
                        ]);
                    });
                    break;
                    
                case 'votes':
                    title = 'Vote-wise Summary Report';
                    const voteData = {};
                    
                    filteredData.forEach(allocation => {
                        if (!voteData[allocation.votenumber]) {
                            voteData[allocation.votenumber] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                        }
                        voteData[allocation.votenumber].total++;
                        voteData[allocation.votenumber][allocation.status.toLowerCase()]++;
                        voteData[allocation.votenumber].totalRequested += parseFloat(allocation.requiredamount);
                        if (allocation.approvedamount > 0) {
                            voteData[allocation.votenumber].totalApproved += parseFloat(allocation.approvedamount);
                        }
                    });
                    
                    reportData = [['Vote Number', 'Total Requests', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                    Object.keys(voteData).forEach(vote => {
                        const data = voteData[vote];
                        reportData.push([
                            vote,
                            data.total.toString(),
                            data.pending.toString(),
                            data.approved.toString(),
                            data.rejected.toString(),
                            formatCurrency(data.totalRequested),
                            formatCurrency(data.totalApproved)
                        ]);
                    });
                    break;
                    
                case 'monthly':
                    title = 'Monthly Summary Report';
                    const monthlyData = {};
                    
                    filteredData.forEach(allocation => {
                        const monthYear = new Date(allocation.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                        if (!monthlyData[monthYear]) {
                            monthlyData[monthYear] = { total: 0, pending: 0, approved: 0, rejected: 0, totalRequested: 0, totalApproved: 0 };
                        }
                        monthlyData[monthYear].total++;
                        monthlyData[monthYear][allocation.status.toLowerCase()]++;
                        monthlyData[monthYear].totalRequested += parseFloat(allocation.requiredamount);
                        if (allocation.approvedamount > 0) {
                            monthlyData[monthYear].totalApproved += parseFloat(allocation.approvedamount);
                        }
                    });
                    
                    reportData = [['Month', 'Total', 'Pending', 'Approved', 'Rejected', 'Total Requested', 'Total Approved']];
                    Object.keys(monthlyData).forEach(month => {
                        const data = monthlyData[month];
                        reportData.push([
                            month,
                            data.total.toString(),
                            data.pending.toString(),
                            data.approved.toString(),
                            data.rejected.toString(),
                            formatCurrency(data.totalRequested),
                            formatCurrency(data.totalApproved)
                        ]);
                    });
                    break;
                    
                default:
                    return { success: false, error: 'Invalid report type' };
            }
            
            return {
                success: true,
                title: title,
                generatedAt: new Date().toISOString(),
                reportData: reportData
            };
        
        case 'getSystemLogs':
            const logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
            return { logs: logs };
        
        default:
            return { success: false, error: 'Unknown action' };
    }
}

// Authentication Functions
async function handleLogin() {
    const hospitalSelect = document.getElementById('hospitalSelect');
    const passwordInput = document.getElementById('password');
    const loginSpinner = document.getElementById('loginSpinner');
    const loginBtn = document.getElementById('loginBtn');
    
    const hospitalId = hospitalSelect.value;
    const password = passwordInput.value.trim();
    
    if (currentUserRole === 'hospital' && !hospitalId) {
        showMessage('Please select a hospital');
        return;
    }
    
    if (!password) {
        showMessage('Please enter a password');
        return;
    }

    showElement(loginSpinner);
    loginBtn.disabled = true;

  try {
        const result = await callGoogleAppsScript('login', {
            role: currentUserRole,
            hospitalId: hospitalId,
            userId: hospitalId,
            password: password
        });

        if (result.success) {
            showElement(document.getElementById('loginScreen'), false);
            
            // Check if the selected account is one of the special admin/view-only accounts
            const isSpecialAccount = hospitalId === 'Deputy Director General (Planning)' || 
                                   hospitalId === 'Accountant (Budget Control)' || 
                                   hospitalId === 'admin';
            
            // If it's a special account, force admin role with view-only permissions
            if (isSpecialAccount && currentUserRole === 'hospital') {
                currentUserIsViewOnly = true;
                showElement(document.getElementById('viewOnlyDashboard'));
                document.getElementById('viewOnlyDisplayName').textContent = hospitalId;
                loadViewOnlyData();
            } else if (currentUserRole === 'hospital') {
                // Regular hospital user
                currentUserId = hospitalId;
                showElement(document.getElementById('hospitalDashboard'));
                document.getElementById('hospitalDisplayName').textContent = result.hospitalName || 'Hospital User';
                document.getElementById('hospitalName').value = result.hospitalName || hospitalId;
                resetAllocationForm();
                loadMyRequests();
                updateUserAllocationStatus();
            } else if (currentUserIsViewOnly) {
                // View-only admin
                showElement(document.getElementById('viewOnlyDashboard'));
                document.getElementById('viewOnlyDisplayName').textContent = result.userName || 'View Only User';
                loadViewOnlyData();
            } else {
                // Full admin
                showElement(document.getElementById('adminDashboard'));
                document.getElementById('adminDisplayName').textContent = 
                    result.role === 'mainadmin' ? 'Main Administrator' : result.userName || 'Administrator';
                loadAdminData();
                loadSystemLogs();
                loadAdminAllocationHistory();
                loadAdminVoteDistribution();
                loadHospitalSummary();
                enhanceLoggingSection();
            }
        } else {
            showMessage(result.error || 'Invalid password');
        }
    } catch (error) {
        showMessage('Login failed. Please try again.');
    } finally {
        showElement(loginSpinner, false);
        loginBtn.disabled = false;
    }
}
// Add logout handler for view-only dashboard
document.getElementById('viewOnlyLogout')?.addEventListener('click', logout);

// Add tab switching for view-only dashboard
document.querySelectorAll('.view-only-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.view-only-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
        
        this.classList.add('active');
        // Only handle the viewAllocations tab
        if (this.getAttribute('data-tab') === 'viewAllocations') {
            document.getElementById('viewAllocationsTab').classList.remove('hidden');
        }
    });
});

// Add event listeners for view-only dashboard filters
function setupViewOnlyEventListeners() {
    // Status filter event listener
    const statusFilter = document.getElementById('viewStatusFilterAllocations');
    const searchFilter = document.getElementById('viewSearchAllocationsStatus');
    
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            updateViewAllocationStatus();
        });
    }
    
    if (searchFilter) {
        searchFilter.addEventListener('input', function() {
            updateViewAllocationStatus();
        });
    }
}

async function loadViewOnlyData() {
    const viewSpinner = document.getElementById('viewSpinner');
    showElement(viewSpinner);
    
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        allAllocations = allocationsResult.allocations || [];
        
        updateViewOnlyStats();
        updateViewAllocationStatus();
        
        // Setup event listeners for filters
        setupViewOnlyEventListeners();
        
    } catch (error) {
        console.error('Error loading view-only data:', error);
        document.getElementById('viewPendingAllocationsList').innerHTML = '<div class="text-center">Error loading data</div>';
    } finally {
        showElement(viewSpinner, false);
    }
}

function updateViewOnlyStats() {
    document.getElementById('viewOnlyTotalAllocations').textContent = allAllocations.length;
    document.getElementById('viewOnlyPendingAllocations').textContent = allAllocations.filter(a => a.status === 'Pending').length;
    document.getElementById('viewOnlyApprovedAllocations').textContent = allAllocations.filter(a => a.status === 'Approved').length;
    
    const totalAllocated = allAllocations
        .filter(a => a.status === 'Approved')
        .reduce((sum, allocation) => sum + parseFloat(allocation.approvedamount), 0);
    document.getElementById('viewOnlyTotalAllocatedAmount').textContent = formatCurrency(totalAllocated);
}

function filterViewAllocations() {
    const status = document.getElementById('viewStatusFilter').value;
    const searchTerm = document.getElementById('viewSearchAllocations').value.toLowerCase();
    
    const filteredAllocations = allAllocations.filter(allocation => {
        const statusMatch = status === 'all' || allocation.status === status;
        const searchMatch = !searchTerm || 
            allocation.refnumber.toLowerCase().includes(searchTerm) ||
            allocation.hospitalname.toLowerCase().includes(searchTerm) ||
            allocation.votenumber.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    displayViewAllocations(filteredAllocations);
}

function displayViewAllocations(allocations) {
    const viewRequestsTableBody = document.getElementById('viewRequestsTableBody');
    const viewRequestCount = document.getElementById('viewRequestCount');
    viewRequestsTableBody.innerHTML = '';
    
    if (allocations.length === 0) {
        viewRequestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No allocation requests found</td></tr>';
        viewRequestCount.textContent = '0 requests';
        return;
    }

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, allocations.length);
    const currentAllocations = allocations.slice(startIndex, endIndex);

    viewRequestCount.textContent = `${allocations.length} requests`;

    currentAllocations.forEach(allocation => {
        const row = document.createElement('tr');
        row.className = 'enhanced-table-row';
        if (allocation.status === 'Pending') {
            row.classList.add('highlighted-row');
        }

        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        // View-only users only get view button
        const actions = `<button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>`;

        row.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.hospitalname}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.prioritylevel}</td>
            <td>${statusBadge}</td>
            <td>${actions}</td>
        `;

        viewRequestsTableBody.appendChild(row);
    });
}

function updateViewAllocationStatus() {
    const statusFilter = document.getElementById('viewStatusFilterAllocations');
    const searchFilter = document.getElementById('viewSearchAllocationsStatus');
    
    const statusValue = statusFilter ? statusFilter.value : 'all';
    const searchValue = searchFilter ? searchFilter.value.toLowerCase() : '';
    
    // Filter allocations based on status and search term
    let filteredAllocations = allAllocations;
    
    if (statusValue !== 'all') {
        filteredAllocations = filteredAllocations.filter(a => a.status === statusValue);
    }
    
    if (searchValue) {
        filteredAllocations = filteredAllocations.filter(allocation => {
            return allocation.refnumber.toLowerCase().includes(searchValue) ||
                   allocation.hospitalname.toLowerCase().includes(searchValue) ||
                   allocation.votenumber.toLowerCase().includes(searchValue);
        });
    }
    
    // Update counts
    const pendingCount = filteredAllocations.filter(a => a.status === 'Pending').length;
    const approvedCount = filteredAllocations.filter(a => a.status === 'Approved').length;
    const rejectedCount = filteredAllocations.filter(a => a.status === 'Rejected').length;
    
    // Update the UI
    document.getElementById('viewPendingAllocationsCount').textContent = pendingCount;
    document.getElementById('viewApprovedAllocationsCount').textContent = approvedCount;
    document.getElementById('viewRejectedAllocationsCount').textContent = rejectedCount;
    
    // Populate the lists with filtered allocations
    populateFilteredViewStatusList('viewPendingAllocationsList', 'Pending', filteredAllocations);
    populateFilteredViewStatusList('viewApprovedAllocationsList', 'Approved', filteredAllocations);
    populateFilteredViewStatusList('viewRejectedAllocationsList', 'Rejected', filteredAllocations);
}

function populateFilteredViewStatusList(listId, status, filteredAllocations) {
    const list = document.getElementById(listId);
    if (!list) return;
    
    list.innerHTML = '';
    
    const filtered = filteredAllocations.filter(a => a.status === status);
    
    if (filtered.length === 0) {
        list.innerHTML = `<div class="text-center">No ${status.toLowerCase()} allocations found</div>`;
        return;
    }
    
    filtered.forEach(allocation => {
        const div = document.createElement('div');
        div.className = 'selection-item';
        
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${allocation.refnumber}</strong><br>
                    <small style="color: #666;">${allocation.hospitalname}</small>
                </div>
                <span class="status-badge status-${status.toLowerCase()}">${status}</span>
            </div>
            <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                ${allocation.votenumber} - ${formatCurrency(allocation.requiredamount)}
            </div>
            <div style="margin-top: 5px;">
                <button class="btn btn-sm" onclick="viewAllocation(${allocation.id})" style="padding: 3px 8px; font-size: 11px;">View Details</button>
            </div>
        `;
        
        list.appendChild(div);
    });
}

// Add similar functions for view history, vote distribution, etc.
// These can be adapted from the existing admin functions but removing edit/delete capabilities

// Update the logout function to handle view-only dashboard
function logout() {
    logSystemActivity('system', currentUserRole === 'hospital' ? 'Hospital' : 
        (currentUserIsViewOnly ? 'View Only User' : 'Administrator'), 'Logout');
    
    showElement(document.getElementById('hospitalDashboard'), false);
    showElement(document.getElementById('adminDashboard'), false);
    showElement(document.getElementById('viewOnlyDashboard'), false);
    showElement(document.getElementById('loginScreen'));
    
    document.getElementById('password').value = '';
    document.getElementById('hospitalSelect').value = '';
    showElement(document.getElementById('loginMessage'), false);
    
    currentUserId = null;
    currentUserIsViewOnly = false;
}

function logout() {
    logSystemActivity('system', currentUserRole === 'hospital' ? 'Hospital' : 'Administrator', 'Logout');
    showElement(document.getElementById('hospitalDashboard'), false);
    showElement(document.getElementById('adminDashboard'), false);
    showElement(document.getElementById('loginScreen'));
    document.getElementById('password').value = '';
    document.getElementById('hospitalSelect').value = '';
    showElement(document.getElementById('loginMessage'), false);
    currentUserId = null;
}

// Allocation Functions
async function submitAllocation() {
    const requiredFields = ['hospitalName', 'contactPerson', 'contactPhone', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate'];
    
    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            alert(`Please fill in the ${field.previousElementSibling.textContent}`);
            field.focus();
            return;
        }
    }

    const requiredDate = new Date(document.getElementById('requiredDate').value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (requiredDate < today) {
        alert('Required date cannot be in the past');
        return;
    }

    const allocationData = {
        hospitalName: document.getElementById('hospitalName').value.trim(),
        contactPerson: document.getElementById('contactPerson').value.trim(),
        contactPhone: document.getElementById('contactPhone').value.trim(),
        contactEmail: document.getElementById('contactEmail').value.trim(),
        voteNumber: document.getElementById('voteNumber').value,
        jobDescription: document.getElementById('jobDescription').value.trim(),
        requiredAmount: document.getElementById('requiredAmount').value,
        priorityLevel: document.getElementById('priorityLevel').value,
        requiredDate: document.getElementById('requiredDate').value,
        additionalNotes: document.getElementById('additionalNotes').value.trim(),
        hospitalId: currentUserId
    };

    const submitAllocationBtn = document.getElementById('submitAllocation');
    const submitSpinner = document.getElementById('submitSpinner');
    submitAllocationBtn.disabled = true;
    showElement(submitSpinner);

    try {
        const result = await callGoogleAppsScript('submitAllocation', allocationData);
        
        if (result.success) {
            currentRequestId = result.requestId;
            currentRequestRef = result.refNumber;
            updateAllocationConfirmation(result, allocationData);
            showElement(document.getElementById('allocationForm'), false);
            showElement(document.getElementById('allocationSuccess'));
            
            if (document.getElementById('adminDashboard').style.display === 'block') {
                loadAdminData();
                loadAdminAllocationHistory();
                loadAdminVoteDistribution();
                loadHospitalSummary();
            }
            
            loadMyRequests();
        } else {
            alert('Allocation submission failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Allocation submission failed. Please try again.');
    } finally {
        submitAllocationBtn.disabled = false;
        showElement(submitSpinner, false);
    }
}

function updateAllocationConfirmation(result, data) {
    document.getElementById('enhancedPdfRefNumber').textContent = result.refNumber;
    document.getElementById('enhancedPdfPassword').textContent = result.uniquePassword;
    document.getElementById('enhancedPdfDate').textContent = new Date().toLocaleDateString();
    document.getElementById('enhancedPdfHospitalDetails').textContent = 
        `${data.hospitalName}, ${data.contactPerson}, ${data.contactPhone}`;
    document.getElementById('enhancedPdfVoteNumber').textContent = data.voteNumber;
    document.getElementById('enhancedPdfJobDescription').textContent = data.jobDescription;
    document.getElementById('enhancedPdfAmount').textContent = formatCurrency(data.requiredAmount);
    document.getElementById('enhancedPdfPriority').textContent = data.priorityLevel;
    document.getElementById('enhancedPdfRequiredDate').textContent = formatDate(data.requiredDate);
    document.getElementById('enhancedPdfAdditionalNotes').textContent = 
        data.additionalNotes || 'No additional notes';
    document.getElementById('uniquePasswordDisplay').textContent = result.uniquePassword;
}

function resetAllocationForm() {
    const fields = ['contactPerson', 'contactPhone', 'contactEmail', 'voteNumber', 'jobDescription', 'requiredAmount', 'priorityLevel', 'requiredDate', 'additionalNotes'];
    fields.forEach(id => {
        const field = document.getElementById(id);
        if (field) field.value = '';
    });
    
    document.getElementById('hospitalName').value = currentUserId;
    
    showElement(document.getElementById('allocationForm'));
    showElement(document.getElementById('allocationSuccess'), false);
}

// Hospital My Requests Functions
async function loadMyRequests() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
        filteredMyRequests = myAllocations;
        displayMyRequests();
        updateMyRequestsPagination();
    } catch (error) {
        console.error('Error loading my requests:', error);
    }
}

function filterMyRequests() {
    const status = document.getElementById('myRequestsStatusFilter').value;
    const searchTerm = document.getElementById('searchMyRequests').value.toLowerCase();
    
    let myAllocations = allAllocations.filter(allocation => allocation.hospitalId === currentUserId);
    
    filteredMyRequests = myAllocations.filter(allocation => {
        const statusMatch = status === 'all' || allocation.status === status;
        const searchMatch = !searchTerm || 
            allocation.refnumber.toLowerCase().includes(searchTerm) ||
            allocation.votenumber.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    myRequestsPage = 1;
    displayMyRequests();
    updateMyRequestsPagination();
}

function displayMyRequests() {
    const myRequestsTableBody = document.getElementById('myRequestsTableBody');
    const myRequestCount = document.getElementById('myRequestCount');
    myRequestsTableBody.innerHTML = '';
    
    if (filteredMyRequests.length === 0) {
        myRequestsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No allocation requests found</td></tr>';
        myRequestCount.textContent = '0 requests';
        return;
    }

    const startIndex = (myRequestsPage - 1) * myRequestsItemsPerPage;
    const endIndex = Math.min(startIndex + myRequestsItemsPerPage, filteredMyRequests.length);
    const currentRequests = filteredMyRequests.slice(startIndex, endIndex);

    myRequestCount.textContent = `${filteredMyRequests.length} requests`;

    currentRequests.forEach(allocation => {
        const row = document.createElement('tr');
        row.className = 'enhanced-table-row';
        if (allocation.status === 'Pending') {
            row.classList.add('highlighted-row');
        }

        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        row.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.prioritylevel}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="action-btn btn" onclick="viewMyAllocation(${allocation.id})">View</button>
            </td>
        `;

        myRequestsTableBody.appendChild(row);
    });
}

function updateMyRequestsPagination() {
    const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
    document.getElementById('myRequestsPageInfo').textContent = `Page ${myRequestsPage} of ${totalPages}`;
    document.getElementById('myRequestsPrevPage').disabled = myRequestsPage === 1;
    document.getElementById('myRequestsNextPage').disabled = myRequestsPage === totalPages || totalPages === 0;
}

function goToMyRequestsPrevPage() {
    if (myRequestsPage > 1) {
        myRequestsPage--;
        displayMyRequests();
        updateMyRequestsPagination();
    }
}

function goToMyRequestsNextPage() {
    const totalPages = Math.ceil(filteredMyRequests.length / myRequestsItemsPerPage);
    if (myRequestsPage < totalPages) {
        myRequestsPage++;
        displayMyRequests();
        updateMyRequestsPagination();
    }
}

function viewMyAllocation(requestId) {
    currentRequestId = requestId;
    
    const allocation = filteredMyRequests.find(a => a.id == requestId);
    
    if (allocation) {
        // Populate all the existing fields...
        document.getElementById('viewRefNumber').textContent = allocation.refnumber;
        document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
        document.getElementById('viewHospitalDetails').textContent = 
            `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
        document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
        document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
        document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
        document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
        document.getElementById('viewPriority').textContent = allocation.prioritylevel;
        document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
        document.getElementById('viewAdditionalNotes').textContent = 
            allocation.additionalnotes || 'No additional notes';
        document.getElementById('viewStatus').textContent = allocation.status;
        document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
        document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
        
        // SHOW/HIDE REJECTION REASON
        const rejectionSection = document.getElementById('rejectionSection');
        const rejectionReasonElement = document.getElementById('viewRejectionReason');
        
        if (allocation.status === 'Rejected' && allocation.rejectionreason) {
            // Show rejection section
            rejectionSection.style.display = 'block';
            rejectionReasonElement.textContent = allocation.rejectionreason;
        } else {
            // Hide rejection section
            rejectionSection.style.display = 'none';
        }
        
        updatePdfSignature(allocation);
        updateHospitalSignature(allocation);
        
        const downloadFinalPdfBtn = document.getElementById('downloadFinalPdf');
        if (allocation.status === 'Approved') {
            downloadFinalPdfBtn.style.display = 'inline-block';
        } else {
            downloadFinalPdfBtn.style.display = 'none';
        }
        
        showElement(document.getElementById('viewModal'));
    } else {
        console.error('Allocation not found:', requestId);
        alert('Allocation details not found. Please try again.');
    }
}
// Update PDF signature based on approving authority
function updatePdfSignature(allocation) {
    const ddgSignature = document.getElementById('ddgSignatureSection');
    const directorSignature = document.getElementById('directorSignatureSection');
    
    if (ddgSignature) ddgSignature.style.display = 'none';
    if (directorSignature) directorSignature.style.display = 'none';
    
    if (allocation.approvingauthority === 'Deputy Director General (Logistics)') {
        if (ddgSignature) ddgSignature.style.display = 'block';
    } else if (allocation.approvingauthority === 'Director Building (Administration)') {
        if (directorSignature) directorSignature.style.display = 'block';
    }
}

// Update hospital signature in view modal
function updateHospitalSignature(allocation) {
    const signatory = hospitalSignatories[allocation.hospitalname] || {
        name: '[Hospital Director/Deputy Director General]',
        title: '[Position]',
        institution: allocation.hospitalname
    };
    
    document.getElementById('hospitalSignatureName').textContent = signatory.name;
    document.getElementById('hospitalSignatureTitle').textContent = signatory.title;
    document.getElementById('hospitalSignatureInstitution').textContent = signatory.institution;
}

// Hospital Allocation Status Functions
async function updateUserAllocationStatus() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
        
        const approved = myAllocations.filter(a => a.status === 'Approved').length;
        const pending = myAllocations.filter(a => a.status === 'Pending').length;
        const rejected = myAllocations.filter(a => a.status === 'Rejected').length;
        
        document.getElementById('userApprovedCount').textContent = approved;
        document.getElementById('userPendingCount').textContent = pending;
        document.getElementById('userRejectedCount').textContent = rejected;
        document.getElementById('userTotalAllocations').textContent = myAllocations.length;
        
        filterUserAllocations(myAllocations);
    } catch (error) {
        console.error('Error loading user allocation data:', error);
    }
}

function filterUserAllocations(myAllocations) {
    const searchTerm = document.getElementById('searchUserAllocations').value.toLowerCase();
    
    const filtered = myAllocations.filter(allocation => {
        const searchMatch = !searchTerm || 
            allocation.refnumber.toLowerCase().includes(searchTerm) ||
            allocation.votenumber.toLowerCase().includes(searchTerm) ||
            allocation.jobdescription.toLowerCase().includes(searchTerm);
        
        return searchMatch;
    });
    
    displayUserAllocations(filtered);
}

function displayUserAllocations(allocations) {
    const userAllocationsList = document.getElementById('userAllocationsList');
    userAllocationsList.innerHTML = '';
    
    if (allocations.length === 0) {
        userAllocationsList.innerHTML = '<tr><td colspan="6" class="text-center">No allocations found</td></tr>';
        return;
    }

    allocations.forEach(allocation => {
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        tr.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.prioritylevel}</td>
            <td>${statusBadge}</td>
        `;
        userAllocationsList.appendChild(tr);
    });
}

// Hospital Allocation History Functions
async function loadAllocationHistory() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
        
        populateVoteFilter(myAllocations);
        filterAllocationHistory(myAllocations);
    } catch (error) {
        console.error('Error loading allocation history:', error);
    }
}

function populateVoteFilter(allocations) {
    const voteFilter = document.getElementById('historyVoteFilter');
    voteFilter.innerHTML = '<option value="all">All Votes</option>';
    
    const uniqueVotes = [...new Set(allocations.map(allocation => allocation.votenumber).filter(Boolean))];
    
    uniqueVotes.forEach(vote => {
        const option = document.createElement('option');
        option.value = vote;
        option.textContent = vote;
        voteFilter.appendChild(option);
    });
}

function filterAllocationHistory(myAllocations) {
    const yearFilter = document.getElementById('historyYearFilter').value;
    const voteFilter = document.getElementById('historyVoteFilter').value;
    const statusFilter = document.getElementById('historyStatusFilter').value;
    
    let filteredHistory = myAllocations;
    
    if (yearFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
    }
    
    if (voteFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => allocation.votenumber === voteFilter);
    }
    
    if (statusFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => allocation.status === statusFilter);
    }
    
    filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    displayAllocationHistory(filteredHistory);
    updateHistorySummary(filteredHistory);
}

function displayAllocationHistory(allocations) {
    const historyTableBody = document.getElementById('historyTableBody');
    historyTableBody.innerHTML = '';
    
    if (allocations.length === 0) {
        historyTableBody.innerHTML = '<tr><td colspan="10" class="text-center">No historical allocation data found</td></tr>';
        return;
    }
    
    allocations.forEach(allocation => {
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        let approvalTime = 'N/A';
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            approvalTime = `${diffDays} days`;
        }
        
        tr.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(allocation.timestamp)}</td>
            <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
            <td>${allocation.approvingauthority || 'N/A'}</td>
            <td>
                <button class="action-btn btn" onclick="viewMyAllocation(${allocation.id})">View</button>
            </td>
        `;
        historyTableBody.appendChild(tr);
    });
}

function updateHistorySummary(allocations) {
    const totalRequests = allocations.length;
    const totalAmount = allocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
    const approvedRequests = allocations.filter(a => a.status === 'Approved').length;
    const successRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
    
    let totalApprovalDays = 0;
    let approvedCount = 0;
    
    allocations.forEach(allocation => {
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            totalApprovalDays += diffDays;
            approvedCount++;
        }
    });
    
    const avgApprovalTime = approvedCount > 0 ? Math.round(totalApprovalDays / approvedCount) : 0;
    
    document.getElementById('totalHistoricalRequests').textContent = totalRequests;
    document.getElementById('totalHistoricalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('avgApprovalTime').textContent = `${avgApprovalTime} days`;
    document.getElementById('successRate').textContent = `${successRate}%`;
}

// Vote Distribution Functions
async function loadVoteDistribution() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const myAllocations = allocationsResult.allocations.filter(allocation => allocation.hospitalId === currentUserId) || [];
        
        const yearFilter = document.getElementById('distributionYearFilter').value;
        
        const filteredAllocations = myAllocations.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
        
        calculateVoteDistribution(filteredAllocations);
    } catch (error) {
        console.error('Error loading vote distribution:', error);
    }
}

function calculateVoteDistribution(allocations) {
    const voteData = {};
    
    allocations.forEach(allocation => {
        const voteNumber = allocation.votenumber || 'Unknown';
        
        if (!voteData[voteNumber]) {
            voteData[voteNumber] = {
                totalRequests: 0,
                approvedRequests: 0,
                totalRequested: 0,
                totalApproved: 0,
                allocations: []
            };
        }
        
        voteData[voteNumber].totalRequests++;
        voteData[voteNumber].totalRequested += parseFloat(allocation.requiredamount);
        
        if (allocation.status === 'Approved') {
            voteData[voteNumber].approvedRequests++;
            voteData[voteNumber].totalApproved += parseFloat(allocation.approvedamount || allocation.requiredamount);
        }
        
        voteData[voteNumber].allocations.push(allocation);
    });
    
    displayVoteDistribution(voteData);
    updateVoteDistributionChart(voteData);
}

function displayVoteDistribution(voteData) {
    const tableBody = document.getElementById('voteDistributionTableBody');
    tableBody.innerHTML = '';
    
    if (Object.keys(voteData).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No vote distribution data available</td></tr>';
        return;
    }
    
    Object.keys(voteData).forEach(voteNumber => {
        const data = voteData[voteNumber];
        const approvalRate = data.totalRequests > 0 ? Math.round((data.approvedRequests / data.totalRequests) * 100) : 0;
        const avgAmount = data.totalRequests > 0 ? data.totalRequested / data.totalRequests : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${voteNumber}</td>
            <td>${data.totalRequests}</td>
            <td>${data.approvedRequests}</td>
            <td>${formatCurrency(data.totalRequested)}</td>
            <td>${formatCurrency(data.totalApproved)}</td>
            <td>${approvalRate}%</td>
            <td>${formatCurrency(avgAmount)}</td>
        `;
        tableBody.appendChild(tr);
    });
}

function updateVoteDistributionChart(voteData) {
    const ctx = document.getElementById('voteDistributionChart').getContext('2d');
    
    if (window.voteDistributionChartInstance) {
        window.voteDistributionChartInstance.destroy();
    }
    
    const voteNumbers = Object.keys(voteData);
    const totalAmounts = voteNumbers.map(vote => voteData[vote].totalRequested);
    
    window.voteDistributionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: voteNumbers,
            datasets: [{
                label: 'Total Requested Amount (LKR)',
                data: totalAmounts,
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            }, {
                label: 'Total Approved Amount (LKR)',
                data: voteNumbers.map(vote => voteData[vote].totalApproved),
                backgroundColor: 'rgba(52, 168, 83, 0.7)',
                borderColor: 'rgba(52, 168, 83, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (LKR)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Vote Number'
                    }
                }
            }
        }
    });
}

// Export vote distribution to Excel
function exportVoteDistributionToExcel() {
    const yearFilter = document.getElementById('distributionYearFilter').value;
    const hospitalName = currentUserId || 'Hospital';
    
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Vote Number,Total Requests,Approved Requests,Total Requested,Total Approved,Approval Rate,Average Amount\n"
        + Array.from(document.querySelectorAll('#voteDistributionTableBody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).map(cell => `"${cell.textContent}"`).join(',');
        }).join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `vote_distribution_${hospitalName}_${yearFilter}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    logSystemActivity('report', currentUserId, 'Vote Distribution Exported', `Year: ${yearFilter}`);
}

// Admin Functions
async function loadAdminData() {
    const adminSpinner = document.getElementById('adminSpinner');
    showElement(adminSpinner);
    
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');

        allAllocations = allocationsResult.allocations || [];

        updateAdminStats();
        filterAllocations();
        updateAllocationStatusEnhanced();
        updatePendingAllocationNotification();
        
        populateHospitalFilter();
    } catch (error) {
        console.error('Error loading admin data:', error);
        document.getElementById('requestsTableBody').innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
    } finally {
        showElement(adminSpinner, false);
    }
}

// Populate hospital filter in reports
function populateHospitalFilter() {
    const hospitalFilter = document.getElementById('hospitalFilter');
    if (!hospitalFilter) return;
    
    hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
    
    const uniqueHospitals = [...new Set(allAllocations.map(allocation => allocation.hospitalname).filter(Boolean))];
    
    uniqueHospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        hospitalFilter.appendChild(option);
    });
}

function updateAdminStats() {
    document.getElementById('totalAllocations').textContent = allAllocations.length;
    document.getElementById('pendingAllocations').textContent = allAllocations.filter(a => a.status === 'Pending').length;
    document.getElementById('approvedAllocations').textContent = allAllocations.filter(a => a.status === 'Approved').length;
    
    const totalAllocated = allAllocations
        .filter(a => a.status === 'Approved')
        .reduce((sum, allocation) => sum + parseFloat(allocation.approvedamount), 0);
    document.getElementById('totalAllocatedAmount').textContent = formatCurrency(totalAllocated);
}

function filterAllocations() {
    const status = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchAllocations').value.toLowerCase();
    
    filteredAllocations = allAllocations.filter(allocation => {
        const statusMatch = status === 'all' || allocation.status === status;
        const searchMatch = !searchTerm || 
            allocation.refnumber.toLowerCase().includes(searchTerm) ||
            allocation.hospitalname.toLowerCase().includes(searchTerm) ||
            allocation.votenumber.toLowerCase().includes(searchTerm);
        
        return statusMatch && searchMatch;
    });
    
    currentPage = 1;
    displayAllocations();
    updatePagination();
    updateAdminStats();
}

function displayAllocations() {
    const requestsTableBody = document.getElementById('requestsTableBody');
    const requestCount = document.getElementById('requestCount');
    requestsTableBody.innerHTML = '';
    
    if (filteredAllocations.length === 0) {
        requestsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No allocation requests found</td></tr>';
        requestCount.textContent = '0 requests';
        return;
    }

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredAllocations.length);
    const currentAllocations = filteredAllocations.slice(startIndex, endIndex);

    requestCount.textContent = `${filteredAllocations.length} requests`;

    currentAllocations.forEach(allocation => {
        const row = document.createElement('tr');
        row.className = 'enhanced-table-row';
        if (allocation.status === 'Pending') {
            row.classList.add('highlighted-row');
        }

        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        let actions = '';
        if (allocation.status === 'Pending') {
            actions = `
                <button class="action-btn btn" onclick="openApprovalModal(${allocation.id})">Approve</button>
                <button class="action-btn btn btn-danger" onclick="openRejectionModal(${allocation.id})">Reject</button>
                <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">View Hospital History</button>
                <button class="action-btn btn btn-danger" onclick="authenticateAdmin('delete', ${allocation.id})">Delete</button>
            `;
        } else {
            actions = `
                <button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>
                <button class="action-btn btn btn-secondary" onclick="authenticateAdmin('edit', ${allocation.id})">Edit</button>
                <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">View Hospital History</button>
            `;
        }

        row.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.hospitalname}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 50)}${allocation.jobdescription.length > 50 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.prioritylevel}</td>
            <td>${statusBadge}</td>
            <td>${actions}</td>
        `;

        requestsTableBody.appendChild(row);
    });
}

function updatePagination() {
    const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
}

function goToPrevPage() {
    if (currentPage > 1) {
        currentPage--;
        displayAllocations();
        updatePagination();
    }
}

function goToNextPage() {
    const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        displayAllocations();
        updatePagination();
    }
}

// View Hospital History
function viewHospitalHistory(hospitalName) {
    const hospitalAllocations = allAllocations.filter(allocation => allocation.hospitalname === hospitalName);
    
    if (hospitalAllocations.length === 0) {
        alert(`No allocation history found for ${hospitalName}`);
        return;
    }
    
    document.getElementById('hospitalHistoryTitle').textContent = `Allocation History for ${hospitalName}`;
    
    const totalRequests = hospitalAllocations.length;
    const totalAmount = hospitalAllocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
    const approvedCount = hospitalAllocations.filter(a => a.status === 'Approved').length;
    const approvalRate = totalRequests > 0 ? Math.round((approvedCount / totalRequests) * 100) : 0;
    
    document.getElementById('hospitalHistoryTotalRequests').textContent = totalRequests;
    document.getElementById('hospitalHistoryTotalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('hospitalHistoryApprovedCount').textContent = approvedCount;
    document.getElementById('hospitalHistoryApprovalRate').textContent = `${approvalRate}%`;
    
    const historyTableBody = document.getElementById('hospitalHistoryTableBody');
    historyTableBody.innerHTML = '';
    
    hospitalAllocations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    hospitalAllocations.forEach(allocation => {
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        tr.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(allocation.timestamp)}</td>
            <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
            <td>
                <button class="action-btn btn btn-sm" onclick="viewAllocation(${allocation.id})">View</button>
            </td>
        `;
        historyTableBody.appendChild(tr);
    });
    
    showElement(document.getElementById('hospitalHistoryModal'));
}

// Enhanced Allocation Status Display
function updateAllocationStatusEnhanced() {
    const pendingCount = allAllocations.filter(a => a.status === 'Pending').length;
    const approvedCount = allAllocations.filter(a => a.status === 'Approved').length;
    const rejectedCount = allAllocations.filter(a => a.status === 'Rejected').length;
    const completedCount = allAllocations.filter(a => a.status === 'Completed').length;
    
    const statusContainer = document.querySelector('.allocation-status-cards');
    if (statusContainer) {
        statusContainer.innerHTML = `
            <div class="status-card-enhanced pending">
                <div class="status-card-count-enhanced">${pendingCount}</div>
                <div class="status-card-label-enhanced">Pending</div>
                <div class="status-card-list" id="pendingAllocationsList"></div>
            </div>
            <div class="status-card-enhanced approved">
                <div class="status-card-count-enhanced">${approvedCount}</div>
                <div class="status-card-label-enhanced">Approved</div>
                <div class="status-card-list" id="approvedAllocationsList"></div>
            </div>
            <div class="status-card-enhanced rejected">
                <div class="status-card-count-enhanced">${rejectedCount}</div>
                <div class="status-card-label-enhanced">Rejected</div>
                <div class="status-card-list" id="rejectedAllocationsList"></div>
            </div>
            <div class="status-card-enhanced completed">
                <div class="status-card-count-enhanced">${completedCount}</div>
                <div class="status-card-label-enhanced">Completed</div>
                <div class="status-card-list" id="completedAllocationsList"></div>
            </div>
        `;
    }
    
    const pendingList = document.getElementById('pendingAllocationsList');
    const approvedList = document.getElementById('approvedAllocationsList');
    const rejectedList = document.getElementById('rejectedAllocationsList');
    const completedList = document.getElementById('completedAllocationsList');
    
    pendingList.innerHTML = '';
    approvedList.innerHTML = '';
    rejectedList.innerHTML = '';
    completedList.innerHTML = '';
    
    allAllocations.forEach(allocation => {
        const div = document.createElement('div');
        div.className = 'selection-item';
        const statusBadge = getEnhancedStatusBadge(allocation.status, false);
        
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${allocation.refnumber}</strong><br>
                    <small style="color: #666;">${allocation.hospitalname}</small>
                </div>
                ${statusBadge}
            </div>
            <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                ${allocation.votenumber} - ${formatCurrency(allocation.requiredamount)}
            </div>
            <div style="margin-top: 5px;">
                <button class="btn btn-sm" onclick="viewAllocation(${allocation.id})" style="padding: 3px 8px; font-size: 11px;">View</button>
            </div>
        `;
        
        if (allocation.status === 'Pending') {
            pendingList.appendChild(div);
        } else if (allocation.status === 'Approved') {
            approvedList.appendChild(div);
        } else if (allocation.status === 'Rejected') {
            rejectedList.appendChild(div);
        } else if (allocation.status === 'Completed') {
            completedList.appendChild(div);
        }
    });
}

// Enhanced Logging Section with Hospital Search
function enhanceLoggingSection() {
    const adminControls = document.querySelector('#logsTab .admin-controls');
    if (adminControls) {
        const hospitalFilterHTML = `
            <div class="filter-control">
                <label class="form-label" for="logHospitalFilter">Filter by Hospital</label>
                <select id="logHospitalFilter" class="form-control">
                    <option value="all">All Hospitals</option>
                </select>
            </div>
        `;
        
        const userFilter = adminControls.querySelector('#userFilter').parentElement;
        userFilter.insertAdjacentHTML('afterend', hospitalFilterHTML);
        
        populateLogHospitalFilter();
    }
}

function populateLogHospitalFilter() {
    const hospitalFilter = document.getElementById('logHospitalFilter');
    if (!hospitalFilter) return;
    
    hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
    
    const uniqueHospitals = [...new Set(allAllocations.map(allocation => allocation.hospitalname).filter(Boolean))];
    
    uniqueHospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        hospitalFilter.appendChild(option);
    });
}

function openApprovalModal(requestId) {
    currentRequestId = requestId;
    const allocation = allAllocations.find(a => a.id === requestId);

    if (allocation) {
        document.getElementById('approvalRefNumber').textContent = allocation.refnumber;
        document.getElementById('approvalHospital').textContent = allocation.hospitalname;
        document.getElementById('approvalVoteNumber').textContent = allocation.votenumber;
        document.getElementById('approvalJobDescription').textContent = allocation.jobdescription;
        document.getElementById('approvalRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
        document.getElementById('approvalPriority').textContent = allocation.prioritylevel;
        
        // ADDED: Populate Additional Notes
        const additionalNotesElement = document.getElementById('approvalAdditionalNotes');
        if (allocation.additionalnotes && allocation.additionalnotes.trim() !== '') {
            additionalNotesElement.textContent = allocation.additionalnotes;
        } else {
            additionalNotesElement.textContent = 'No additional notes provided.';
            additionalNotesElement.style.color = '#999';
            additionalNotesElement.style.fontStyle = 'italic';
        }
        
        document.getElementById('approvedAmount').value = allocation.requiredamount;
        document.getElementById('approvalNotes').value = '';
        document.getElementById('approvingAuthority').value = '';
        document.getElementById('uniquePassword').value = allocation.uniquepassword || '';
        
        // ADDED: Set approval date to current date
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        document.getElementById('approvalDate').value = formattedDate;

        showElement(document.getElementById('approvalModal'));
    }
}

function openRejectionModal(requestId) {
    currentRequestId = requestId;
    const allocation = allAllocations.find(a => a.id === requestId);

    if (allocation) {
        document.getElementById('rejectionRefNumber').textContent = allocation.refnumber;
        document.getElementById('rejectionHospital').textContent = allocation.hospitalname;
        document.getElementById('rejectionVoteNumber').textContent = allocation.votenumber;
        document.getElementById('rejectionRequestedAmount').textContent = formatCurrency(allocation.requiredamount);

        document.getElementById('rejectionPassword').value = allocation.uniquepassword || '';
        document.getElementById('rejectionReason').value = '';

        showElement(document.getElementById('rejectionModal'));
    }
}

async function approveAllocation() {
    const uniquePassword = document.getElementById('uniquePassword').value.trim();
    const approvedAmount = document.getElementById('approvedAmount').value.trim();
    const approvalNotes = document.getElementById('approvalNotes').value.trim();
    const approvingAuthority = document.getElementById('approvingAuthority').value;
    const approvalDate = document.getElementById('approvalDate').value; // ADDED
    
    if (!uniquePassword) {
        alert('Please enter the request password');
        return;
    }
    
    if (!approvedAmount) {
        alert('Please enter the approved amount');
        return;
    }
    
    if (!approvingAuthority) {
        alert('Please select the approving authority');
        return;
    }
    
    if (!approvalDate) { // ADDED
        alert('Please select the approval date');
        return;
    }
    
    const confirmApprovalBtn = document.getElementById('confirmApproval');
    confirmApprovalBtn.disabled = true;
    
    try {
        const result = await callGoogleAppsScript('approveAllocation', {
            requestId: currentRequestId,
            approvedAmount: approvedAmount,
            approvalNotes: approvalNotes,
            approvingAuthority: approvingAuthority,
            approvalDate: approvalDate, // ADDED
            uniquePassword: uniquePassword
        });
        
        if (result.success) {
            alert('Allocation approved successfully');
            hideModal('approvalModal');
            loadAdminData();
            loadAdminAllocationHistory();
            loadAdminVoteDistribution();
            loadHospitalSummary();
        } else {
            alert('Approval failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Approval failed. Please try again.');
    } finally {
        confirmApprovalBtn.disabled = false;
    }
}

async function rejectAllocation() {
    const uniquePassword = document.getElementById('rejectionPassword').value.trim();
    const rejectionReason = document.getElementById('rejectionReason').value.trim();

    if (!uniquePassword) {
        alert('Please enter the request password');
        return;
    }

    if (!rejectionReason) {
        alert('Please provide a rejection reason');
        return;
    }

    const confirmRejectionBtn = document.getElementById('confirmRejection');
    confirmRejectionBtn.disabled = true;

    try {
        const result = await callGoogleAppsScript('rejectAllocation', {
            requestId: currentRequestId,
            rejectionReason: rejectionReason,
            uniquePassword: uniquePassword
        });

        if (result.success) {
            alert('Allocation rejected successfully');
            hideModal('rejectionModal');
            loadAdminData();
            loadAdminAllocationHistory();
            loadAdminVoteDistribution();
            loadHospitalSummary();
        } else {
            alert('Rejection failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Rejection failed. Please try again.');
    } finally {
        confirmRejectionBtn.disabled = false;
    }
}
// Add these functions to your existing JavaScript:

// Initialize Analytics
async function loadAnalyticsData() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        allAllocations = allocationsResult.allocations || [];
        
        updateAnalyticsStats();
        populateAnalyticsFilters();
        updateAnalyticsCharts();
        updateAnalyticsTables();
        updateDetailedAnalyticsTable();
        
        // Setup event listeners for analytics filters
        setupAnalyticsEventListeners();
    } catch (error) {
        console.error('Error loading analytics data:', error);
    }
}

// Update Analytics Statistics
function updateAnalyticsStats() {
    if (allAllocations.length === 0) return;
    
    // Total requested amount
    const totalRequested = allAllocations.reduce((sum, allocation) => {
        return sum + parseFloat(allocation.requiredamount || 0);
    }, 0);
    
    // Total approved amount
    const totalApproved = allAllocations
        .filter(a => a.status === 'Approved')
        .reduce((sum, allocation) => {
            return sum + parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }, 0);
    
    // Approval rate
    const totalApprovedCount = allAllocations.filter(a => a.status === 'Approved').length;
    const approvalRate = allAllocations.length > 0 ? 
        Math.round((totalApprovedCount / allAllocations.length) * 100) : 0;
    
    // Unique hospitals
    const uniqueHospitals = [...new Set(allAllocations.map(a => a.hospitalname))];
    
    // Update UI
    document.getElementById('analyticsTotalAmount').textContent = formatCurrency(totalRequested);
    document.getElementById('analyticsApprovedAmount').textContent = formatCurrency(totalApproved);
    document.getElementById('analyticsApprovalRate').textContent = `${approvalRate}%`;
    document.getElementById('analyticsHospitalsCount').textContent = uniqueHospitals.length;
}

// Populate Analytics Filters
function populateAnalyticsFilters() {
    // Populate vote filter
    const voteFilter = document.getElementById('analyticsVoteFilter');
    const uniqueVotes = [...new Set(allAllocations.map(a => a.votenumber).filter(Boolean))];
    voteFilter.innerHTML = '<option value="all">All Votes</option>';
    uniqueVotes.forEach(vote => {
        const option = document.createElement('option');
        option.value = vote;
        option.textContent = vote;
        voteFilter.appendChild(option);
    });
    
    // Populate hospital filter
    const hospitalFilter = document.getElementById('analyticsHospitalFilter');
    const uniqueHospitals = [...new Set(allAllocations.map(a => a.hospitalname).filter(Boolean))];
    hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
    uniqueHospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        hospitalFilter.appendChild(option);
    });
}

// Setup Analytics Event Listeners
function setupAnalyticsEventListeners() {
    const yearFilter = document.getElementById('analyticsYearFilter');
    const voteFilter = document.getElementById('analyticsVoteFilter');
    const hospitalFilter = document.getElementById('analyticsHospitalFilter');
    const searchFilter = document.getElementById('searchAnalyticsData');
    
    if (yearFilter) yearFilter.addEventListener('change', updateAnalyticsData);
    if (voteFilter) voteFilter.addEventListener('change', updateAnalyticsData);
    if (hospitalFilter) hospitalFilter.addEventListener('change', updateAnalyticsData);
    if (searchFilter) searchFilter.addEventListener('input', updateDetailedAnalyticsTable);
    
    // Export buttons
    document.getElementById('exportHospitalSummaryAnalytics')?.addEventListener('click', exportHospitalSummaryAnalytics);
    document.getElementById('exportVoteSummaryAnalytics')?.addEventListener('click', exportVoteSummaryAnalytics);
    document.getElementById('exportMonthlySummaryAnalytics')?.addEventListener('click', exportMonthlySummaryAnalytics);
    document.getElementById('exportAllAnalyticsData')?.addEventListener('click', exportAllAnalyticsData);
    
    // Pagination
    document.getElementById('analyticsPrevPage')?.addEventListener('click', goToAnalyticsPrevPage);
    document.getElementById('analyticsNextPage')?.addEventListener('click', goToAnalyticsNextPage);
}

// Filter analytics data
function getFilteredAnalyticsData() {
    const yearFilter = document.getElementById('analyticsYearFilter')?.value || 'all';
    const voteFilter = document.getElementById('analyticsVoteFilter')?.value || 'all';
    const hospitalFilter = document.getElementById('analyticsHospitalFilter')?.value || 'all';
    
    let filteredData = [...allAllocations];
    
    // Filter by year
    if (yearFilter !== 'all') {
        filteredData = filteredData.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
    }
    
    // Filter by vote
    if (voteFilter !== 'all') {
        filteredData = filteredData.filter(allocation => allocation.votenumber === voteFilter);
    }
    
    // Filter by hospital
    if (hospitalFilter !== 'all') {
        filteredData = filteredData.filter(allocation => allocation.hospitalname === hospitalFilter);
    }
    
    return filteredData;
}

// Update all analytics components
function updateAnalyticsData() {
    updateAnalyticsStats();
    updateAnalyticsCharts();
    updateAnalyticsTables();
    updateDetailedAnalyticsTable();
}

// Update Analytics Charts
function updateAnalyticsCharts() {
    const filteredData = getFilteredAnalyticsData();
    
    // Monthly Trend Chart
    updateMonthlyTrendChart(filteredData);
    
    // Vote Distribution Chart
    updateVoteDistributionAnalyticsChart(filteredData);
    
    // Hospital Allocation Chart
    updateHospitalAllocationChart(filteredData);
    
    // Status Distribution Chart
    updateStatusDistributionChart(filteredData);
}

// Monthly Trend Chart
function updateMonthlyTrendChart(data) {
    const ctx = document.getElementById('monthlyTrendChart')?.getContext('2d');
    if (!ctx) return;
    
    // Group by month
    const monthlyData = {};
    data.forEach(allocation => {
        const date = new Date(allocation.timestamp);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        
        if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = {
                requested: 0,
                approved: 0,
                count: 0
            };
        }
        
        monthlyData[monthYear].requested += parseFloat(allocation.requiredamount || 0);
        monthlyData[monthYear].count++;
        
        if (allocation.status === 'Approved') {
            monthlyData[monthYear].approved += parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }
    });
    
    const months = Object.keys(monthlyData).sort();
    const requestedData = months.map(month => monthlyData[month].requested);
    const approvedData = months.map(month => monthlyData[month].approved);
    
    if (window.monthlyTrendChartInstance) {
        window.monthlyTrendChartInstance.destroy();
    }
    
    window.monthlyTrendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month-1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }),
            datasets: [
                {
                    label: 'Requested Amount',
                    data: requestedData,
                    borderColor: 'rgba(26, 115, 232, 1)',
                    backgroundColor: 'rgba(26, 115, 232, 0.1)',
                    tension: 0.3
                },
                {
                    label: 'Approved Amount',
                    data: approvedData,
                    borderColor: 'rgba(52, 168, 83, 1)',
                    backgroundColor: 'rgba(52, 168, 83, 0.1)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (LKR)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) {
                                return 'LKR ' + (value / 1000000).toFixed(1) + 'M';
                            } else if (value >= 1000) {
                                return 'LKR ' + (value / 1000).toFixed(0) + 'K';
                            }
                            return 'LKR ' + value;
                        }
                    }
                }
            }
        }
    });
}

// Vote Distribution Analytics Chart
function updateVoteDistributionAnalyticsChart(data) {
    const ctx = document.getElementById('voteDistributionAnalyticsChart')?.getContext('2d');
    if (!ctx) return;
    
    // Group by vote
    const voteData = {};
    data.forEach(allocation => {
        const vote = allocation.votenumber || 'Unknown';
        if (!voteData[vote]) {
            voteData[vote] = {
                requested: 0,
                approved: 0
            };
        }
        voteData[vote].requested += parseFloat(allocation.requiredamount || 0);
        if (allocation.status === 'Approved') {
            voteData[vote].approved += parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }
    });
    
    const votes = Object.keys(voteData).slice(0, 10); // Top 10 votes
    const requestedData = votes.map(vote => voteData[vote].requested);
    
    if (window.voteDistributionAnalyticsChartInstance) {
        window.voteDistributionAnalyticsChartInstance.destroy();
    }
    
    window.voteDistributionAnalyticsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: votes,
            datasets: [{
                label: 'Total Requested',
                data: requestedData,
                backgroundColor: 'rgba(26, 95, 122, 0.7)',
                borderColor: 'rgba(26, 95, 122, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (LKR)'
                    }
                }
            }
        }
    });
}

// Hospital Allocation Chart
function updateHospitalAllocationChart(data) {
    const ctx = document.getElementById('hospitalAllocationChart')?.getContext('2d');
    if (!ctx) return;
    
    // Group by hospital
    const hospitalData = {};
    data.forEach(allocation => {
        const hospital = allocation.hospitalname || 'Unknown';
        if (!hospitalData[hospital]) {
            hospitalData[hospital] = {
                requested: 0,
                count: 0
            };
        }
        hospitalData[hospital].requested += parseFloat(allocation.requiredamount || 0);
        hospitalData[hospital].count++;
    });
    
    const hospitals = Object.keys(hospitalData)
        .sort((a, b) => hospitalData[b].requested - hospitalData[a].requested)
        .slice(0, 8); // Top 8 hospitals
    
    const requestedData = hospitals.map(hospital => hospitalData[hospital].requested);
    const colors = generateChartColors(hospitals.length);
    
    if (window.hospitalAllocationChartInstance) {
        window.hospitalAllocationChartInstance.destroy();
    }
    
    window.hospitalAllocationChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: hospitals,
            datasets: [{
                data: requestedData,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = requestedData.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Status Distribution Chart
function updateStatusDistributionChart(data) {
    const ctx = document.getElementById('statusDistributionChart')?.getContext('2d');
    if (!ctx) return;
    
    // Group by status
    const statusData = {
        'Pending': 0,
        'Approved': 0,
        'Rejected': 0,
        'Completed': 0
    };
    
    data.forEach(allocation => {
        statusData[allocation.status] = (statusData[allocation.status] || 0) + 1;
    });
    
    const statuses = Object.keys(statusData);
    const counts = statuses.map(status => statusData[status]);
    const colors = {
        'Pending': '#ffc107',
        'Approved': '#28a745',
        'Rejected': '#dc3545',
        'Completed': '#17a2b8'
    };
    
    if (window.statusDistributionChartInstance) {
        window.statusDistributionChartInstance.destroy();
    }
    
    window.statusDistributionChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: statuses,
            datasets: [{
                data: counts,
                backgroundColor: statuses.map(status => colors[status]),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = counts.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value} requests (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Generate chart colors
function generateChartColors(count) {
    const colors = [];
    const baseColor = [26, 95, 122]; // Primary color
    const step = 360 / count;
    
    for (let i = 0; i < count; i++) {
        const hue = (i * step) % 360;
        colors.push(`hsla(${hue}, 70%, 50%, 0.7)`);
    }
    
    return colors;
}

// Update Analytics Tables
function updateAnalyticsTables() {
    const filteredData = getFilteredAnalyticsData();
    
    // Hospital Summary Table
    updateHospitalAnalyticsTable(filteredData);
    
    // Vote Summary Table
    updateVoteAnalyticsTable(filteredData);
    
    // Monthly Summary Table
    updateMonthlyAnalyticsTable(filteredData);
}

// Hospital Analytics Table
function updateHospitalAnalyticsTable(data) {
    const tableBody = document.getElementById('hospitalAnalyticsTableBody');
    if (!tableBody) return;
    
    // Group by hospital
    const hospitalData = {};
    data.forEach(allocation => {
        const hospital = allocation.hospitalname;
        if (!hospitalData[hospital]) {
            hospitalData[hospital] = {
                total: 0,
                pending: 0,
                approved: 0,
                rejected: 0,
                requested: 0,
                approvedAmount: 0,
                processingTimes: []
            };
        }
        
        hospitalData[hospital].total++;
        hospitalData[hospital][allocation.status.toLowerCase()]++;
        hospitalData[hospital].requested += parseFloat(allocation.requiredamount || 0);
        
        if (allocation.status === 'Approved') {
            hospitalData[hospital].approvedAmount += parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }
        
        // Calculate processing time for approved requests
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            hospitalData[hospital].processingTimes.push(diffDays);
        }
    });
    
    tableBody.innerHTML = '';
    Object.keys(hospitalData).forEach(hospital => {
        const data = hospitalData[hospital];
        const approvalRate = data.total > 0 ? Math.round((data.approved / data.total) * 100) : 0;
        const avgProcessingTime = data.processingTimes.length > 0 ? 
            Math.round(data.processingTimes.reduce((a, b) => a + b, 0) / data.processingTimes.length) : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${hospital}</td>
            <td>${data.total}</td>
            <td>${data.pending}</td>
            <td>${data.approved}</td>
            <td>${data.rejected}</td>
            <td>${formatCurrency(data.requested)}</td>
            <td>${formatCurrency(data.approvedAmount)}</td>
            <td>${approvalRate}%</td>
            <td>${avgProcessingTime} days</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Vote Analytics Table
function updateVoteAnalyticsTable(data) {
    const tableBody = document.getElementById('voteAnalyticsTableBody');
    if (!tableBody) return;
    
    // Group by vote
    const voteData = {};
    data.forEach(allocation => {
        const vote = allocation.votenumber || 'Unknown';
        if (!voteData[vote]) {
            voteData[vote] = {
                total: 0,
                approved: 0,
                rejected: 0,
                requested: 0,
                approvedAmount: 0
            };
        }
        
        voteData[vote].total++;
        voteData[vote][allocation.status.toLowerCase()]++;
        voteData[vote].requested += parseFloat(allocation.requiredamount || 0);
        
        if (allocation.status === 'Approved') {
            voteData[vote].approvedAmount += parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }
    });
    
    tableBody.innerHTML = '';
    Object.keys(voteData).forEach(vote => {
        const data = voteData[vote];
        const approvalRate = data.total > 0 ? Math.round((data.approved / data.total) * 100) : 0;
        const avgAmount = data.total > 0 ? data.requested / data.total : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${vote}</td>
            <td>${data.total}</td>
            <td>${data.approved}</td>
            <td>${data.rejected}</td>
            <td>${formatCurrency(data.requested)}</td>
            <td>${formatCurrency(data.approvedAmount)}</td>
            <td>${approvalRate}%</td>
            <td>${formatCurrency(avgAmount)}</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Monthly Analytics Table
function updateMonthlyAnalyticsTable(data) {
    const tableBody = document.getElementById('monthlyAnalyticsTableBody');
    if (!tableBody) return;
    
    // Group by month
    const monthlyData = {};
    data.forEach(allocation => {
        const date = new Date(allocation.timestamp);
        const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = {
                name: monthName,
                total: 0,
                approved: 0,
                rejected: 0,
                requested: 0,
                approvedAmount: 0,
                processingTimes: []
            };
        }
        
        monthlyData[monthYear].total++;
        monthlyData[monthYear][allocation.status.toLowerCase()]++;
        monthlyData[monthYear].requested += parseFloat(allocation.requiredamount || 0);
        
        if (allocation.status === 'Approved') {
            monthlyData[monthYear].approvedAmount += parseFloat(allocation.approvedamount || allocation.requiredamount || 0);
        }
        
        // Calculate processing time
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            monthlyData[monthYear].processingTimes.push(diffDays);
        }
    });
    
    tableBody.innerHTML = '';
    const sortedMonths = Object.keys(monthlyData).sort().reverse();
    
    sortedMonths.forEach(month => {
        const data = monthlyData[month];
        const approvalRate = data.total > 0 ? Math.round((data.approved / data.total) * 100) : 0;
        const avgProcessingTime = data.processingTimes.length > 0 ? 
            Math.round(data.processingTimes.reduce((a, b) => a + b, 0) / data.processingTimes.length) : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${data.name}</td>
            <td>${data.total}</td>
            <td>${data.approved}</td>
            <td>${data.rejected}</td>
            <td>${formatCurrency(data.requested)}</td>
            <td>${formatCurrency(data.approvedAmount)}</td>
            <td>${approvalRate}%</td>
            <td>${avgProcessingTime} days</td>
        `;
        tableBody.appendChild(tr);
    });
}

// Detailed Analytics Table with Pagination
let analyticsCurrentPage = 1;
let filteredAnalyticsData = [];
const analyticsItemsPerPage = 10;

function updateDetailedAnalyticsTable() {
    const filteredData = getFilteredAnalyticsData();
    const searchTerm = document.getElementById('searchAnalyticsData')?.value.toLowerCase() || '';
    
    // Filter by search term
    filteredAnalyticsData = filteredData.filter(allocation => {
        const searchMatch = !searchTerm || 
            allocation.refnumber?.toLowerCase().includes(searchTerm) ||
            allocation.hospitalname?.toLowerCase().includes(searchTerm) ||
            allocation.votenumber?.toLowerCase().includes(searchTerm) ||
            allocation.jobdescription?.toLowerCase().includes(searchTerm);
        
        return searchMatch;
    });
    
    analyticsCurrentPage = 1;
    displayDetailedAnalyticsTable();
    updateAnalyticsPagination();
}

function displayDetailedAnalyticsTable() {
    const tableBody = document.getElementById('detailedAnalyticsTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    if (filteredAnalyticsData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12" class="text-center">No data found</td></tr>';
        return;
    }
    
    const startIndex = (analyticsCurrentPage - 1) * analyticsItemsPerPage;
    const endIndex = Math.min(startIndex + analyticsItemsPerPage, filteredAnalyticsData.length);
    const currentPageData = filteredAnalyticsData.slice(startIndex, endIndex);
    
    currentPageData.forEach(allocation => {
        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        // Calculate processing time
        let processingTime = 'N/A';
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            processingTime = `${diffDays} days`;
        }
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.hospitalname}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription?.substring(0, 50) || ''}${allocation.jobdescription?.length > 50 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${allocation.prioritylevel}</td>
            <td>${formatDate(allocation.timestamp)}</td>
            <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
            <td>${processingTime}</td>
            <td>${allocation.approvingauthority || 'N/A'}</td>
        `;
        tableBody.appendChild(tr);
    });
}

function updateAnalyticsPagination() {
    const totalPages = Math.ceil(filteredAnalyticsData.length / analyticsItemsPerPage);
    document.getElementById('analyticsPageInfo').textContent = `Page ${analyticsCurrentPage} of ${totalPages}`;
    document.getElementById('analyticsPrevPage').disabled = analyticsCurrentPage === 1;
    document.getElementById('analyticsNextPage').disabled = analyticsCurrentPage === totalPages || totalPages === 0;
}

function goToAnalyticsPrevPage() {
    if (analyticsCurrentPage > 1) {
        analyticsCurrentPage--;
        displayDetailedAnalyticsTable();
        updateAnalyticsPagination();
    }
}

function goToAnalyticsNextPage() {
    const totalPages = Math.ceil(filteredAnalyticsData.length / analyticsItemsPerPage);
    if (analyticsCurrentPage < totalPages) {
        analyticsCurrentPage++;
        displayDetailedAnalyticsTable();
        updateAnalyticsPagination();
    }
}

// Export Functions
function exportHospitalSummaryAnalytics() {
    const tableBody = document.getElementById('hospitalAnalyticsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    if (rows.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = "Hospital,Total Requests,Pending,Approved,Rejected,Requested Amount,Approved Amount,Approval Rate,Avg. Processing Time\n";
    
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csvContent += rowData + '\n';
    });
    
    downloadCSV(csvContent, 'hospital_summary_analytics.csv');
}

function exportVoteSummaryAnalytics() {
    const tableBody = document.getElementById('voteAnalyticsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    if (rows.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = "Vote Number,Total Requests,Approved,Rejected,Total Requested,Total Approved,Approval Rate,Avg. Amount\n";
    
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csvContent += rowData + '\n';
    });
    
    downloadCSV(csvContent, 'vote_summary_analytics.csv');
}

function exportMonthlySummaryAnalytics() {
    const tableBody = document.getElementById('monthlyAnalyticsTableBody');
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    if (rows.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = "Month,Total Requests,Approved,Rejected,Total Requested,Total Approved,Approval Rate,Avg. Processing Time\n";
    
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
        csvContent += rowData + '\n';
    });
    
    downloadCSV(csvContent, 'monthly_summary_analytics.csv');
}

function exportAllAnalyticsData() {
    const filteredData = getFilteredAnalyticsData();
    
    if (filteredData.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csvContent = "Reference No.,Hospital,Vote Number,Job Description,Requested Amount,Approved Amount,Status,Priority,Submitted Date,Approved Date,Processing Time,Approving Authority,Additional Notes\n";
    
    filteredData.forEach(allocation => {
        // Calculate processing time
        let processingTime = 'N/A';
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            processingTime = `${diffDays} days`;
        }
        
        const rowData = [
            `"${allocation.refnumber || ''}"`,
            `"${allocation.hospitalname || ''}"`,
            `"${allocation.votenumber || ''}"`,
            `"${allocation.jobdescription?.replace(/"/g, '""') || ''}"`,
            `"${formatCurrency(allocation.requiredamount)}"`,
            `"${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}"`,
            `"${allocation.status || ''}"`,
            `"${allocation.prioritylevel || ''}"`,
            `"${formatDate(allocation.timestamp)}"`,
            `"${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}"`,
            `"${processingTime}"`,
            `"${allocation.approvingauthority || 'N/A'}"`,
            `"${allocation.additionalnotes?.replace(/"/g, '""') || ''}"`
        ].join(',');
        
        csvContent += rowData + '\n';
    });
    
    downloadCSV(csvContent, 'complete_analytics_data.csv');
}

// Helper function to download CSV
function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    logSystemActivity('analytics', currentUserRole, 'Data Exported', `File: ${filename}`);
}

// Update the loadViewOnlyData function to include analytics
async function loadViewOnlyData() {
    const viewSpinner = document.getElementById('viewSpinner');
    showElement(viewSpinner);
    
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        allAllocations = allocationsResult.allocations || [];
        
        updateViewOnlyStats();
        updateViewAllocationStatus();
        
        // Check if we're on the analytics tab
        const activeTab = document.querySelector('.view-only-tab.active')?.getAttribute('data-tab');
        if (activeTab === 'viewAnalytics') {
            loadAnalyticsData();
        }
        
        // Setup event listeners
        setupViewOnlyEventListeners();
        
    } catch (error) {
        console.error('Error loading view-only data:', error);
        document.getElementById('viewPendingAllocationsList').innerHTML = '<div class="text-center">Error loading data</div>';
    } finally {
        showElement(viewSpinner, false);
    }
}

// Update tab switching for view-only dashboard
document.querySelectorAll('.view-only-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        document.querySelectorAll('.view-only-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
        
        this.classList.add('active');
        
        if (tabId === 'viewAllocations') {
            document.getElementById('viewAllocationsTab').classList.remove('hidden');
        } else if (tabId === 'viewAnalytics') {
            document.getElementById('viewAnalyticsTab').classList.remove('hidden');
            loadAnalyticsData();
        }
    });
});
function openEditModal(requestId) {
    currentRequestId = requestId;
    const allocation = allAllocations.find(a => a.id === requestId);
    
    if (allocation) {
        document.getElementById('editHospitalName').value = allocation.hospitalname || '';
        document.getElementById('editContactPerson').value = allocation.contactperson || '';
        document.getElementById('editContactPhone').value = allocation.contactphone || '';
        document.getElementById('editContactEmail').value = allocation.contactemail || '';
        document.getElementById('editVoteNumber').value = allocation.votenumber || '';
        document.getElementById('editJobDescription').value = allocation.jobdescription || '';
        document.getElementById('editRequiredAmount').value = allocation.requiredamount || '';
        document.getElementById('editPriorityLevel').value = allocation.prioritylevel || '';
        document.getElementById('editRequiredDate').value = allocation.requireddate ? allocation.requireddate.substring(0, 10) : '';
        document.getElementById('editAdditionalNotes').value = allocation.additionalnotes || '';
        
        showElement(document.getElementById('editModal'));
    }
}

// View Allocation for Admin
function viewAllocation(requestId) {
    currentRequestId = requestId;
    const allocation = allAllocations.find(a => a.id === requestId);
    
    if (allocation) {
        document.getElementById('viewRefNumber').textContent = allocation.refnumber;
        document.getElementById('viewDate').textContent = formatDate(allocation.timestamp);
        document.getElementById('viewHospitalDetails').textContent = 
            `${allocation.hospitalname}, ${allocation.contactperson}, ${allocation.contactphone}`;
        document.getElementById('viewVoteNumber').textContent = allocation.votenumber;
        document.getElementById('viewJobDescription').textContent = allocation.jobdescription;
        document.getElementById('viewRequestedAmount').textContent = formatCurrency(allocation.requiredamount);
        document.getElementById('viewApprovedAmount').textContent = allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'Not approved';
        document.getElementById('viewPriority').textContent = allocation.prioritylevel;
        document.getElementById('viewRequiredDate').textContent = formatDate(allocation.requireddate);
        document.getElementById('viewAdditionalNotes').textContent = 
            allocation.additionalnotes || 'No additional notes';
        document.getElementById('viewStatus').textContent = allocation.status;
        document.getElementById('viewApprovingAuthority').textContent = allocation.approvingauthority || 'Not specified';
        document.getElementById('viewApprovalNotes').textContent = allocation.approvalnotes || 'No approval notes';
        
        updatePdfSignature(allocation);
        updateHospitalSignature(allocation);
      // Show rejection reason if rejected
        const rejectionSection = document.getElementById('rejectionSection');
        const rejectionReasonElement = document.getElementById('viewRejectionReason');
        
        if (allocation.status === 'Rejected' && allocation.rejectionreason) {
            rejectionSection.style.display = 'block';
            rejectionReasonElement.textContent = allocation.rejectionreason;
        } else {
            rejectionSection.style.display = 'none';
        }
        
        const downloadFinalPdfBtn = document.getElementById('downloadFinalPdf');
        if (allocation.status === 'Approved') {
            downloadFinalPdfBtn.style.display = 'inline-block';
        } else {
            downloadFinalPdfBtn.style.display = 'none';
        }
        
        showElement(document.getElementById('viewModal'));
    }
}

async function saveEdit() {
    const confirmEditBtn = document.getElementById('confirmEdit');
    confirmEditBtn.disabled = true;
    
    try {
        const result = await callGoogleAppsScript('editAllocation', {
            requestId: currentRequestId,
            hospitalName: document.getElementById('editHospitalName').value.trim(),
            contactPerson: document.getElementById('editContactPerson').value.trim(),
            contactPhone: document.getElementById('editContactPhone').value.trim(),
            contactEmail: document.getElementById('editContactEmail').value.trim(),
            voteNumber: document.getElementById('editVoteNumber').value,
            jobDescription: document.getElementById('editJobDescription').value.trim(),
            requiredAmount: document.getElementById('editRequiredAmount').value,
            priorityLevel: document.getElementById('editPriorityLevel').value,
            requiredDate: document.getElementById('editRequiredDate').value,
            additionalNotes: document.getElementById('editAdditionalNotes').value.trim()
        });
        
        if (result.success) {
            alert('Allocation updated successfully');
            hideModal('editModal');
            loadAdminData();
            loadAdminAllocationHistory();
            loadAdminVoteDistribution();
            loadHospitalSummary();
        } else {
            alert('Update failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Update failed. Please try again.');
    } finally {
        confirmEditBtn.disabled = false;
    }
}

async function deleteAllocation(requestId) {
    if (!confirm('Are you sure you want to delete this allocation?')) {
        return;
    }
    
    try {
        const result = await callGoogleAppsScript('deleteAllocation', { requestId: requestId });
        
        if (result.success) {
            alert('Allocation deleted successfully');
            loadAdminData();
            loadAdminAllocationHistory();
            loadAdminVoteDistribution();
            loadHospitalSummary();
        } else {
            alert('Delete failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Delete failed. Please try again.');
    }
}

function hideModal(modalId) {
    showElement(document.getElementById(modalId), false);
}

// Enhanced Logging Functions with Hospital Search
function filterLogs() {
    const typeFilter = document.getElementById('logTypeFilter').value;
    const userFilter = document.getElementById('userFilter').value;
    const hospitalFilter = document.getElementById('logHospitalFilter') ? document.getElementById('logHospitalFilter').value : 'all';
    const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
    
    filteredLogs = systemLogs.filter(log => {
        const typeMatch = typeFilter === 'all' || log.type === typeFilter;
        const userMatch = userFilter === 'all' || log.user === userFilter;
        const searchMatch = !searchTerm || 
            log.user.toLowerCase().includes(searchTerm) ||
            log.action.toLowerCase().includes(searchTerm) ||
            log.details.toLowerCase().includes(searchTerm);
        
        let hospitalMatch = true;
        if (hospitalFilter !== 'all') {
            hospitalMatch = log.details.toLowerCase().includes(hospitalFilter.toLowerCase());
        }
        
        return typeMatch && userMatch && searchMatch && hospitalMatch;
    });
    
    logsPage = 1;
    displayLogs();
    updateLogsPagination();
}

function displayLogs() {
    const systemLogsTable = document.getElementById('systemLogsTable');
    systemLogsTable.innerHTML = '';
    
    if (filteredLogs.length === 0) {
        systemLogsTable.innerHTML = '<tr><td colspan="5" class="text-center">No logs found</td></tr>';
        return;
    }

    const startIndex = (logsPage - 1) * logsItemsPerPage;
    const endIndex = Math.min(startIndex + logsItemsPerPage, filteredLogs.length);
    const currentLogs = filteredLogs.slice(startIndex, endIndex);

    currentLogs.forEach(log => {
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        const typeClass = `status-${log.type.toLowerCase()}`;
        
        tr.innerHTML = `
            <td>${formatDateTime(log.timestamp)}</td>
            <td><span class="status-badge ${typeClass}">${log.type}</span></td>
            <td>${log.user}</td>
            <td>${log.action}</td>
            <td>${log.details}</td>
        `;
        systemLogsTable.appendChild(tr);
    });
}

function updateLogsPagination() {
    const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
    document.getElementById('logsPageInfo').textContent = `Page ${logsPage} of ${totalPages}`;
    document.getElementById('logsPrevPage').disabled = logsPage === 1;
    document.getElementById('logsNextPage').disabled = logsPage === totalPages || totalPages === 0;
}

function goToLogsPrevPage() {
    if (logsPage > 1) {
        logsPage--;
        displayLogs();
        updateLogsPagination();
    }
}

function goToLogsNextPage() {
    const totalPages = Math.ceil(filteredLogs.length / logsItemsPerPage);
    if (logsPage < totalPages) {
        logsPage++;
        displayLogs();
        updateLogsPagination();
    }
}

function exportLogs() {
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Timestamp,Type,User,Action,Details\n"
        + filteredLogs.map(log => 
            `"${formatDateTime(log.timestamp)}","${log.type}","${log.user}","${log.action}","${log.details}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "system_logs.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Enhanced A4 PDF Generation Functions
function generateProfessionalPDF(isFinal = false) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    
    let yPosition = margin;
    let currentPage = 1;
    
    // ========== HEADER ==========
    addHeader(doc, pageWidth, isFinal);
    yPosition = 45;
    
    // ========== DOCUMENT CONTENT ==========
    let allocation;
    if (isFinal) {
        if (currentUserRole === 'hospital') {
            allocation = filteredMyRequests.find(a => a.id == currentRequestId);
        } else {
            allocation = allAllocations.find(a => a.id === currentRequestId);
        }
    } else {
        // Get data from preview
        allocation = {
            refnumber: document.getElementById('enhancedPdfRefNumber').textContent,
            hospitalname: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[0],
            contactperson: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[1],
            contactphone: document.getElementById('enhancedPdfHospitalDetails').textContent.split(', ')[2],
            votenumber: document.getElementById('enhancedPdfVoteNumber').textContent,
            jobdescription: document.getElementById('enhancedPdfJobDescription').textContent,
            requiredamount: document.getElementById('enhancedPdfAmount').textContent.replace('LKR ', '').replace(/,/g, ''),
            prioritylevel: document.getElementById('enhancedPdfPriority').textContent,
            requireddate: document.getElementById('enhancedPdfRequiredDate').textContent,
            additionalnotes: document.getElementById('enhancedPdfAdditionalNotes').textContent,
            timestamp: new Date().toISOString(),
            uniquepassword: document.getElementById('enhancedPdfPassword').textContent
        };
    }
    
    if (!allocation) {
        console.error('Allocation data not found');
        return;
    }
    
    if (isFinal) {
        yPosition = addFinalApprovalContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
    } else {
        yPosition = addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
    }
    
    // ========== SIGNATURES ==========
    yPosition = addSignatures(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal);
    
    // ========== COPIES NOTE ==========
    yPosition = addCopiesNote(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal);
    
    // ========== FOOTER WITH QR CODE ==========
    addFooterWithQRCode(doc, pageWidth, pageHeight, margin, isFinal, allocation);
    
    // ========== ADD PAGE NUMBERS ==========
    addPageNumbers(doc, pageWidth, pageHeight);
    
    const fileName = isFinal ? 
        `Allocation_Approval_${allocation?.refnumber || currentRequestRef}.pdf` : 
        `Allocation_Request_${allocation?.refnumber || currentRequestRef}.pdf`;
    
    doc.save(fileName);
    
    logSystemActivity('system', currentUserRole, 'PDF Downloaded', 
        isFinal ? `Final approval for ${allocation?.refnumber || currentRequestRef}` : 
                  `Request preview for ${allocation?.refnumber || currentRequestRef}`);
}

function addHeader(doc, pageWidth, isFinal) {
    // Government Header
    doc.setFillColor(26, 115, 232);
    doc.rect(0, 0, pageWidth, 25, 'F');
    
    // Ministry Logo/Text
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text("MINISTRY OF HEALTH", pageWidth / 2, 15, { align: 'center' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text("Government of Sri Lanka", pageWidth / 2, 22, { align: 'center' });
    
    // Document Type Box
    doc.setDrawColor(26, 115, 232);
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(20, 30, pageWidth - 40, 15, 3, 3, 'F');
    
    doc.setTextColor(26, 115, 232);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    const title = isFinal ? "ALLOCATION APPROVAL CERTIFICATE" : "ALLOCATION REQUEST FORM";
    doc.text(title, pageWidth / 2, 40, { align: 'center' });
}

function addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight) {
    // Document Border
    doc.setDrawColor(200, 200, 200);
    doc.roundedRect(margin, yPosition, contentWidth, pageHeight - 100, 3, 3, 'S');
    
    yPosition += 10;
    doc.setFillColor(245, 245, 245);
    doc.roundedRect(margin + 5, yPosition, contentWidth - 10, 15, 2, 2, 'F');
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text(`REFERENCE: ${allocation.refnumber || ''}`, margin + 10, yPosition + 10);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    const dateStr = allocation.timestamp ? new Date(allocation.timestamp).toLocaleDateString('en-GB') : new Date().toLocaleDateString('en-GB');
    doc.text(`Date: ${dateStr}`, pageWidth - margin - 50, yPosition + 10);
    
    yPosition += 25;
    
    // 1. HOSPITAL INFORMATION
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(26, 115, 232);
    doc.text("1. HOSPITAL INFORMATION", margin + 5, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    
    const hospitalData = [
        ['Hospital Name:', allocation.hospitalname || ''],
        ['Contact Person:', allocation.contactperson || ''],
        ['Contact Phone:', allocation.contactphone || ''],
        ['Vote Number:', allocation.votenumber || '']
    ];
    
    hospitalData.forEach(([label, value]) => {
        if (yPosition > pageHeight - 50) {
            doc.addPage();
            yPosition = margin;
            doc.setFontSize(10);
        }
        
        doc.text(label.toString(), margin + 10, yPosition);
        doc.setFont('helvetica', 'bold');
        doc.text(value.toString(), margin + 40, yPosition);
        doc.setFont('helvetica', 'normal');
        yPosition += 7;
    });
    
    yPosition += 10;
    
    // 2. ALLOCATION DETAILS
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(26, 115, 232);
    doc.text("2. ALLOCATION DETAILS", margin + 5, yPosition);
    
    yPosition += 10;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    
    // Format amount properly
    const amount = allocation.requiredamount ? 
        parseFloat(allocation.requiredamount.toString().replace(/[^0-9.-]+/g, "")).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }) : '0.00';
    
    const allocationData = [
        ['Job Description:', allocation.jobdescription || ''],
        ['Required Amount:', `LKR ${amount}`],
        ['Priority Level:', allocation.prioritylevel || ''],
        ['Required Date:', allocation.requireddate ? new Date(allocation.requireddate).toLocaleDateString('en-GB') : ''],
        ['Additional Notes:', allocation.additionalnotes || 'None']
    ];
    
    allocationData.forEach(([label, value]) => {
        if (yPosition > pageHeight - 50) {
            doc.addPage();
            yPosition = margin;
            doc.setFontSize(10);
        }
        
        doc.text(label.toString(), margin + 10, yPosition);
        
        if (label === 'Job Description:' || label === 'Additional Notes:') {
            const lines = doc.splitTextToSize(value.toString(), contentWidth - 50);
            lines.forEach((line, index) => {
                if (index === 0) {
                    doc.setFont('helvetica', 'bold');
                    doc.text(line, margin + 40, yPosition);
                    doc.setFont('helvetica', 'normal');
                } else {
                    doc.text(line, margin + 40, yPosition + (index * 5));
                }
            });
            yPosition += Math.max(lines.length * 5, 7);
        } else {
            doc.setFont('helvetica', 'bold');
            doc.text(value.toString(), margin + 40, yPosition);
            doc.setFont('helvetica', 'normal');
            yPosition += 7;
        }
    });
    
    yPosition += 10;
    
    // 3. IMPORTANT INSTRUCTIONS
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(26, 115, 232);
    doc.text("3. IMPORTANT INSTRUCTIONS", margin + 5, yPosition);
    
    yPosition += 10;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(0, 0, 0);
    
    const instructions = [
    "I. Action shall be taken strictly in accordance with the Government Financial Regulations (GFR), Establishments Code, GFR 135 on Delegation of Authority, and all other applicable laws and regulations.",
    "II. The relevant works shall be executed only after obtaining approval from your Hospital's Regional Procurement Committee.",
    "III. The availability of adequate cash flow shall be confirmed prior to entering into any financial commitments.",
    "IV. Commencement of any work without the necessary financial provisions shall be strictly avoided.",
    "V. The provisions granted under this letter shall remain valid until 31.12.2026.",
    "VI. Monthly expenditure reports shall be submitted on or before the 10th day of the following month to the email address ddglogisticsmoh@gmail.com.",
    "VII. This is an electronically generated PDF and does not require a physical signature."
];

    
    instructions.forEach((instruction, index) => {
        if (yPosition > pageHeight - 50) {
            doc.addPage();
            yPosition = margin;
            doc.setFontSize(9);
        }
        
        const lines = doc.splitTextToSize(`${String.fromCharCode(97 + index)}. ${instruction}`, contentWidth - 20);
        lines.forEach((line, lineIndex) => {
            doc.text(line, margin + 10, yPosition);
            yPosition += 5;
        });
        yPosition += 2;
    });
    
    return yPosition;
}

function addFinalApprovalContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight) {
    // Approval Header
    doc.setFillColor(52, 168, 83);
    doc.roundedRect(margin, yPosition, contentWidth, 20, 3, 3, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text("APPROVAL CERTIFICATE", pageWidth / 2, yPosition + 12, { align: 'center' });
    
    yPosition += 30;
    
    // Approval Details
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    
    const approvalDate = allocation.approvaldate ? new Date(allocation.approvaldate).toLocaleDateString('en-GB') : 'N/A';
    
    const approvalDetails = [
        ['Reference Number:', allocation.refnumber || ''],
        ['Approval Date:', approvalDate],
        ['Approving Authority:', allocation.approvingauthority || 'N/A'],
        ['Status:', allocation.status || '']
    ];
    
    approvalDetails.forEach(([label, value]) => {
        doc.text(label.toString(), margin + 10, yPosition);
        doc.setFont('helvetica', 'bold');
        doc.text(value.toString(), margin + 50, yPosition);
        doc.setFont('helvetica', 'normal');
        yPosition += 8;
    });
    
    // Add approved amount if available
    if (allocation.approvedamount) {
        const approvedAmount = parseFloat(allocation.approvedamount).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        doc.text('Approved Amount:', margin + 10, yPosition);
        doc.setFont('helvetica', 'bold');
        doc.text(`LKR ${approvedAmount}`, margin + 50, yPosition);
        doc.setFont('helvetica', 'normal');
        yPosition += 8;
    }
    
    yPosition += 10;
    
    // Continue with regular content
    return addRequestContent(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight);
}

function addSignatures(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal) {
    if (yPosition > pageHeight - 80) {
        doc.addPage();
        yPosition = margin;
    }
    
    // Only show hospital signature for request forms (not final)
    if (!isFinal) {
        // Hospital Signature
        const signatory = hospitalSignatories[allocation.hospitalname] || {
            name: '[Hospital Director/Deputy Director General]',
            title: '[Position]',
            institution: allocation.hospitalname || ''
        };
        
        // Left side - Hospital Signature
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 20, yPosition, margin + 100, yPosition);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("Hospital Authorization:", margin + 20, yPosition + 10);
        
        doc.setFont('helvetica', 'normal');
        doc.text(signatory.name, margin + 20, yPosition + 17);
        
        doc.setFontSize(9);
        doc.text(signatory.title, margin + 20, yPosition + 22);
        doc.text(signatory.institution, margin + 20, yPosition + 27);
        
        yPosition += 40;
    }
    
    // Only show approval signature for final approved documents
    if (isFinal && allocation.status === 'Approved') {
        // Left side - Approval Signature
        doc.setDrawColor(0, 0, 0);
        doc.line(margin + 20, yPosition, margin + 100, yPosition);
        
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("Approval Signature:", margin + 20, yPosition + 10);
        
        doc.setFont('helvetica', 'normal');
        
        if (allocation.approvingauthority === 'Deputy Director General (Logistics)') {
            doc.text("H.M.N Dinipriya Herath", margin + 20, yPosition + 17);
            doc.setFontSize(9);
            doc.text("Deputy Director General (Logistics)", margin + 20, yPosition + 22);
            doc.text("For Secretary", margin + 20, yPosition + 27);
        } else if (allocation.approvingauthority === 'Director Building (Administration)') {
            doc.text("Director Building Branch", margin + 20, yPosition + 17);
            doc.setFontSize(9);
            doc.text("Director Building Branch (Administration)", margin + 20, yPosition + 22);
        }
        
        yPosition += 40;
    }
    
    return yPosition + 20;
}

function addCopiesNote(doc, allocation, margin, yPosition, contentWidth, pageWidth, pageHeight, isFinal) {
    // Check if we need a new page before adding the copies note
    if (yPosition > pageHeight - 60) {
        doc.addPage();
        yPosition = margin;
    }
    
    // Only add copies note for final approval documents
    if (isFinal) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("Copies:", margin + 5, yPosition);
        
        yPosition += 7;
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        
        const copies = [
            "1. Accountant (Budget - Control) - For kind information and necessary action (f.k.i. & n.a.)/For entry into the ITMIS system",
            "2. Officer-in-Charge of Subject B02 - For kind information and necessary action (f.k.i. & n.a.)"
        ];
        
        copies.forEach(copy => {
            if (yPosition > pageHeight - 50) {
                doc.addPage();
                yPosition = margin;
                doc.setFontSize(9);
            }
            
            // Split long text if needed
            const lines = doc.splitTextToSize(copy, contentWidth - 20);
            lines.forEach(line => {
                doc.text(line, margin + 10, yPosition);
                yPosition += 5;
            });
        });
        
        yPosition += 10; // Add some spacing after the copies note
    }
    
    return yPosition;
}

// FIXED QR CODE FUNCTION
function addFooterWithQRCode(doc, pageWidth, pageHeight, margin, isFinal, allocation) {
    const footerY = pageHeight - 30;
    
    // Footer text
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text("Official Document - Ministry of Health, Sri Lanka", pageWidth / 2, footerY, { align: 'center' });
    doc.text("This is a system generated document", pageWidth / 2, footerY + 5, { align: 'center' });
    
    // QR Code Generation - FIXED VERSION
    try {
        // Generate QR code text
        const qrText = isFinal ? 
            `Approval: ${allocation?.refnumber || ''}
Date: ${allocation?.approvaldate ? new Date(allocation.approvaldate).toLocaleDateString('en-GB') : ''}
Amount: LKR ${allocation?.approvedamount || allocation?.requiredamount || ''}
Status: ${allocation?.status || 'Approved'}` :
            `Request: ${allocation?.refnumber || ''}
Hospital: ${allocation?.hospitalname || ''}
Date: ${allocation?.timestamp ? new Date(allocation.timestamp).toLocaleDateString('en-GB') : new Date().toLocaleDateString('en-GB')}
Amount: LKR ${allocation?.requiredamount || ''}`;
        
        // Check if QRCode library is available
        if (typeof QRCode !== 'undefined') {
            // Method 1: Using QRCode library if available
            const qrSize = 20;
            const qrX = pageWidth - margin - qrSize - 5;
            const qrY = footerY - qrSize - 5;
            
            // Create canvas for QR code
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            
            // Generate QR code
            QRCode.toCanvas(canvas, qrText, {
                width: 128,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (!error) {
                    // Convert canvas to data URL
                    const qrDataURL = canvas.toDataURL('image/png');
                    // Add to PDF
                    doc.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);
                } else {
                    console.error('QR Code generation error:', error);
                    addFallbackQR(doc, qrText, qrX, qrY, qrSize);
                }
            });
        } else if (typeof qrcode !== 'undefined') {
            // Method 2: Using older qrcode library
            const qrSize = 20;
            const qrX = pageWidth - margin - qrSize - 5;
            const qrY = footerY - qrSize - 5;
            
            const qr = qrcode(0, 'L');
            qr.addData(qrText);
            qr.make();
            const qrDataURL = qr.createDataURL(4, 0);
            doc.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);
        } else {
            console.warn('No QR code library available');
            addFallbackQR(doc, qrText, pageWidth - margin - 25, footerY - 25, 20);
        }
    } catch (e) {
        console.log('QR Code skipped:', e.message);
        // Add fallback text
        doc.setFontSize(6);
        doc.setTextColor(150, 150, 150);
        doc.text("QR Code Unavailable", pageWidth - margin - 15, footerY - 10, { align: 'center' });
    }
}

// Fallback function if QR code generation fails
function addFallbackQR(doc, text, x, y, size) {
    // Draw a simple QR placeholder
    doc.setDrawColor(100, 100, 100);
    doc.setFillColor(255, 255, 255);
    doc.rect(x, y, size, size, 'FD');
    
    // Draw grid pattern
    doc.setFillColor(0, 0, 0);
    const cellSize = size / 7;
    for (let i = 0; i < 7; i++) {
        for (let j = 0; j < 7; j++) {
            if ((i + j) % 2 === 0) {
                doc.rect(x + i * cellSize, y + j * cellSize, cellSize, cellSize, 'F');
            }
        }
    }
    
    // Add text
    doc.setFontSize(4);
    doc.setTextColor(100, 100, 100);
    doc.text("QR", x + size/2, y + size/2, { align: 'center' });
}

function addPageNumbers(doc, pageWidth, pageHeight) {
    const totalPages = doc.internal.getNumberOfPages();
    
    for(let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
    }
}
// Update the download PDF button event listeners
document.getElementById('downloadPdf')?.addEventListener('click', function() {
    generateProfessionalPDF(false);
});

document.getElementById('downloadFinalPdf')?.addEventListener('click', function() {
    generateProfessionalPDF(true);
});
// Admin Allocation History Functions
async function loadAdminAllocationHistory() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const allAllocationsData = allocationsResult.allocations || [];
        
        populateAdminHistoryHospitalFilter(allAllocationsData);
        filterAdminAllocationHistory(allAllocationsData);
    } catch (error) {
        console.error('Error loading admin allocation history:', error);
    }
}

function populateAdminHistoryHospitalFilter(allocations) {
    const hospitalFilter = document.getElementById('adminHistoryHospitalFilter');
    if (!hospitalFilter) return;
    
    hospitalFilter.innerHTML = '<option value="all">All Hospitals</option>';
    
    const uniqueHospitals = [...new Set(allocations.map(allocation => allocation.hospitalname).filter(Boolean))];
    
    uniqueHospitals.forEach(hospital => {
        const option = document.createElement('option');
        option.value = hospital;
        option.textContent = hospital;
        hospitalFilter.appendChild(option);
    });
}

function filterAdminAllocationHistory(allocations) {
    const yearFilter = document.getElementById('adminHistoryYearFilter').value;
    const hospitalFilter = document.getElementById('adminHistoryHospitalFilter').value;
    const statusFilter = document.getElementById('adminHistoryStatusFilter').value;
    
    let filteredHistory = allocations;
    
    if (yearFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
    }
    
    if (hospitalFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => allocation.hospitalname === hospitalFilter);
    }
    
    if (statusFilter !== 'all') {
        filteredHistory = filteredHistory.filter(allocation => allocation.status === statusFilter);
    }
    
    filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    displayAdminAllocationHistory(filteredHistory);
    updateAdminHistorySummary(filteredHistory);
}

function displayAdminAllocationHistory(allocations) {
    const historyTableBody = document.getElementById('adminHistoryTableBody');
    historyTableBody.innerHTML = '';
    
    if (allocations.length === 0) {
        historyTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No historical allocation data found</td></tr>';
        return;
    }
    
    allocations.forEach(allocation => {
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        const statusBadge = getEnhancedStatusBadge(allocation.status, true);
        
        let approvalTime = 'N/A';
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            approvalTime = `${diffDays} days`;
        }
        
        tr.innerHTML = `
            <td>${allocation.refnumber}</td>
            <td>${allocation.hospitalname}</td>
            <td>${allocation.votenumber}</td>
            <td>${allocation.jobdescription.substring(0, 40)}${allocation.jobdescription.length > 40 ? '...' : ''}</td>
            <td>${formatCurrency(allocation.requiredamount)}</td>
            <td>${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}</td>
            <td>${statusBadge}</td>
            <td>${formatDate(allocation.timestamp)}</td>
            <td>${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}</td>
            <td>${allocation.approvingauthority || 'N/A'}</td>
            <td>
                <button class="action-btn btn" onclick="viewAllocation(${allocation.id})">View</button>
                <button class="action-btn btn btn-warning" onclick="viewHospitalHistory('${allocation.hospitalname}')">Hospital History</button>
            </td>
        `;
        historyTableBody.appendChild(tr);
    });
}

function updateAdminHistorySummary(allocations) {
    const totalRequests = allocations.length;
    const totalAmount = allocations.reduce((sum, allocation) => sum + parseFloat(allocation.requiredamount), 0);
    const approvedRequests = allocations.filter(a => a.status === 'Approved').length;
    const successRate = totalRequests > 0 ? Math.round((approvedRequests / totalRequests) * 100) : 0;
    
    let totalApprovalDays = 0;
    let approvedCount = 0;
    
    allocations.forEach(allocation => {
        if (allocation.status === 'Approved' && allocation.timestamp && allocation.approvaldate) {
            const submitDate = new Date(allocation.timestamp);
            const approveDate = new Date(allocation.approvaldate);
            const diffTime = Math.abs(approveDate - submitDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            totalApprovalDays += diffDays;
            approvedCount++;
        }
    });
    
    const avgApprovalTime = approvedCount > 0 ? Math.round(totalApprovalDays / approvedCount) : 0;
    
    document.getElementById('adminTotalHistoricalRequests').textContent = totalRequests;
    document.getElementById('adminTotalHistoricalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('adminAvgApprovalTime').textContent = `${avgApprovalTime} days`;
    document.getElementById('adminSuccessRate').textContent = `${successRate}%`;
}

// Admin Vote Distribution Functions
async function loadAdminVoteDistribution() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const allAllocationsData = allocationsResult.allocations || [];
        
        const yearFilter = document.getElementById('adminDistributionYearFilter').value;
        
        const filteredAllocations = allAllocationsData.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
        
        calculateAdminVoteDistribution(filteredAllocations);
    } catch (error) {
        console.error('Error loading admin vote distribution:', error);
    }
}

function calculateAdminVoteDistribution(allocations) {
    const voteData = {};
    
    allocations.forEach(allocation => {
        const voteNumber = allocation.votenumber || 'Unknown';
        
        if (!voteData[voteNumber]) {
            voteData[voteNumber] = {
                totalRequests: 0,
                approvedRequests: 0,
                totalRequested: 0,
                totalApproved: 0,
                allocations: []
            };
        }
        
        voteData[voteNumber].totalRequests++;
        voteData[voteNumber].totalRequested += parseFloat(allocation.requiredamount);
        
        if (allocation.status === 'Approved') {
            voteData[voteNumber].approvedRequests++;
            voteData[voteNumber].totalApproved += parseFloat(allocation.approvedamount || allocation.requiredamount);
        }
        
        voteData[voteNumber].allocations.push(allocation);
    });
    
    displayAdminVoteDistribution(voteData);
    updateAdminVoteDistributionChart(voteData);
}

function displayAdminVoteDistribution(voteData) {
    const tableBody = document.getElementById('adminVoteDistributionTableBody');
    tableBody.innerHTML = '';
    
    if (Object.keys(voteData).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No vote distribution data available</td></tr>';
        return;
    }
    
    Object.keys(voteData).forEach(voteNumber => {
        const data = voteData[voteNumber];
        const approvalRate = data.totalRequests > 0 ? Math.round((data.approvedRequests / data.totalRequests) * 100) : 0;
        const avgAmount = data.totalRequests > 0 ? data.totalRequested / data.totalRequests : 0;
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${voteNumber}</td>
            <td>${data.totalRequests}</td>
            <td>${data.approvedRequests}</td>
            <td>${formatCurrency(data.totalRequested)}</td>
            <td>${formatCurrency(data.totalApproved)}</td>
            <td>${approvalRate}%</td>
            <td>${formatCurrency(avgAmount)}</td>
        `;
        tableBody.appendChild(tr);
    });
}

function updateAdminVoteDistributionChart(voteData) {
    const ctx = document.getElementById('adminVoteDistributionChart').getContext('2d');
    
    if (window.adminVoteDistributionChartInstance) {
        window.adminVoteDistributionChartInstance.destroy();
    }
    
    const voteNumbers = Object.keys(voteData);
    const totalAmounts = voteNumbers.map(vote => voteData[vote].totalRequested);
    
    window.adminVoteDistributionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: voteNumbers,
            datasets: [{
                label: 'Total Requested Amount (LKR)',
                data: totalAmounts,
                backgroundColor: 'rgba(26, 115, 232, 0.7)',
                borderColor: 'rgba(26, 115, 232, 1)',
                borderWidth: 1
            }, {
                label: 'Total Approved Amount (LKR)',
                data: voteNumbers.map(vote => voteData[vote].totalApproved),
                backgroundColor: 'rgba(52, 168, 83, 0.7)',
                borderColor: 'rgba(52, 168, 83, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (LKR)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Vote Number'
                    }
                }
            }
        }
    });
}

// Export admin vote distribution to Excel
function exportAdminVoteDistributionToExcel() {
    const yearFilter = document.getElementById('adminDistributionYearFilter').value;
    
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Vote Number,Total Requests,Approved Requests,Total Requested,Total Approved,Approval Rate,Average Amount\n"
        + Array.from(document.querySelectorAll('#adminVoteDistributionTableBody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).map(cell => `"${cell.textContent}"`).join(',');
        }).join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `vote_distribution_admin_${yearFilter}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    logSystemActivity('report', 'Administrator', 'Vote Distribution Exported', `Year: ${yearFilter}`);
}

// Hospital Summary Functions
async function loadHospitalSummary() {
    try {
        const allocationsResult = await callGoogleAppsScript('getAllocations');
        const allAllocationsData = allocationsResult.allocations || [];
        
        filterHospitalSummary(allAllocationsData);
    } catch (error) {
        console.error('Error loading hospital summary:', error);
    }
}

function filterHospitalSummary(allocations) {
    const yearFilter = document.getElementById('hospitalSummaryYearFilter').value;
    const statusFilter = document.getElementById('hospitalSummaryStatusFilter').value;
    
    let filteredAllocations = allocations;
    
    if (yearFilter !== 'all') {
        filteredAllocations = filteredAllocations.filter(allocation => {
            const allocationYear = new Date(allocation.timestamp).getFullYear().toString();
            return allocationYear === yearFilter;
        });
    }
    
    if (statusFilter !== 'all') {
        filteredAllocations = filteredAllocations.filter(allocation => allocation.status === statusFilter);
    }
    
    calculateHospitalSummary(filteredAllocations);
}

function calculateHospitalSummary(allocations) {
    const hospitalData = {};
    
    allocations.forEach(allocation => {
        const hospitalName = allocation.hospitalname || 'Unknown';
        
        if (!hospitalData[hospitalName]) {
            hospitalData[hospitalName] = {
                totalRequests: 0,
                pending: 0,
                approved: 0,
                rejected: 0,
                totalRequested: 0,
                totalApproved: 0,
                allocations: []
            };
        }
        
        hospitalData[hospitalName].totalRequests++;
        hospitalData[hospitalName][allocation.status.toLowerCase()]++;
        hospitalData[hospitalName].totalRequested += parseFloat(allocation.requiredamount);
        
        if (allocation.approvedamount > 0) {
            hospitalData[hospitalName].totalApproved += parseFloat(allocation.approvedamount);
        }
        
        hospitalData[hospitalName].allocations.push(allocation);
    });
    
    displayHospitalSummary(hospitalData);
}

function displayHospitalSummary(hospitalData) {
    const hospitalSummaryGrid = document.getElementById('hospitalSummaryGrid');
    const hospitalSummaryTableBody = document.getElementById('hospitalSummaryTableBody');
    
    hospitalSummaryGrid.innerHTML = '';
    hospitalSummaryTableBody.innerHTML = '';
    
    if (Object.keys(hospitalData).length === 0) {
        hospitalSummaryGrid.innerHTML = '<div class="text-center w-100">No hospital data available</div>';
        hospitalSummaryTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No hospital data available</td></tr>';
        return;
    }
    
    Object.keys(hospitalData).forEach(hospitalName => {
        const data = hospitalData[hospitalName];
        const approvalRate = data.totalRequests > 0 ? Math.round((data.approved / data.totalRequests) * 100) : 0;
        
        const card = document.createElement('div');
        card.className = 'hospital-summary-card';
        card.innerHTML = `
            <div class="hospital-summary-header">
                <div class="hospital-summary-name">${hospitalName}</div>
                <div class="hospital-summary-count">${data.totalRequests}</div>
            </div>
            <div class="hospital-summary-stats">
                <div class="hospital-stat-item">
                    <div class="hospital-stat-value">${data.pending}</div>
                    <div class="hospital-stat-label">Pending</div>
                </div>
                <div class="hospital-stat-item">
                    <div class="hospital-stat-value">${data.approved}</div>
                    <div class="hospital-stat-label">Approved</div>
                </div>
                <div class="hospital-stat-item">
                    <div class="hospital-stat-value">${data.rejected}</div>
                    <div class="hospital-stat-label">Rejected</div>
                </div>
                <div class="hospital-stat-item">
                    <div class="hospital-stat-value">${approvalRate}%</div>
                    <div class="hospital-stat-label">Approval Rate</div>
                </div>
            </div>
            <div class="mt-10">
                <button class="btn btn-sm btn-block" onclick="viewHospitalHistory('${hospitalName}')">View Details</button>
            </div>
        `;
        hospitalSummaryGrid.appendChild(card);
        
        const tr = document.createElement('tr');
        tr.className = 'enhanced-table-row';
        tr.innerHTML = `
            <td>${hospitalName}</td>
            <td>${data.totalRequests}</td>
            <td>${data.pending}</td>
            <td>${data.approved}</td>
            <td>${data.rejected}</td>
            <td>${formatCurrency(data.totalRequested)}</td>
            <td>${formatCurrency(data.totalApproved)}</td>
            <td>${approvalRate}%</td>
            <td>
                <button class="action-btn btn" onclick="viewHospitalHistory('${hospitalName}')">View History</button>
            </td>
        `;
        hospitalSummaryTableBody.appendChild(tr);
    });
}

// Export hospital summary to Excel
function exportHospitalSummaryToExcel() {
    const yearFilter = document.getElementById('hospitalSummaryYearFilter').value;
    
    const csvContent = "data:text/csv;charset=utf-8," 
        + "Hospital,Total Requests,Pending,Approved,Rejected,Total Requested,Total Approved,Approval Rate\n"
        + Array.from(document.querySelectorAll('#hospitalSummaryTableBody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return Array.from(cells).map(cell => `"${cell.textContent}"`).join(',');
        }).join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `hospital_summary_${yearFilter}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    logSystemActivity('report', 'Administrator', 'Hospital Summary Exported', `Year: ${yearFilter}`);
}

// Report Functions
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const hospital = document.getElementById('hospitalFilter').value;
    
    const reportResults = document.getElementById('reportResults');
    reportResults.innerHTML = '<div class="spinner"></div>';
    
    try {
        const result = await callGoogleAppsScript('getReports', {
            reportType: reportType,
            startDate: startDate,
            endDate: endDate,
            hospital: hospital
        });                
        
        if (result.success) {
            displayReport(result);
        } else {
            reportResults.innerHTML = `<div style="color: red;">Error: ${result.error || 'Failed to generate report'}</div>`;
        }
    } catch (error) {
        reportResults.innerHTML = `<div style="color: red;">Error generating report: ${error.message}</div>`;
    }
}

function displayReport(result) {
    const reportResults = document.getElementById('reportResults');
    
    let html = `
        <div class="enhanced-pdf">
            <div class="enhanced-pdf-header">
                <div class="enhanced-pdf-title">${result.title}</div>
                <div class="enhanced-pdf-subtitle">Generated on ${formatDateTime(result.generatedAt)}</div>
                <button id="downloadReport" class="btn" style="margin-top: 15px;">Download Report</button>
            </div>
    `;
    
    if (result.reportData && result.reportData.length > 0) {
        html += '<div class="table-scroll-container"><table>';
        
        result.reportData.forEach((row, rowIndex) => {
            const rowClass = rowIndex === 0 ? 'style="font-weight: bold; background-color: #f8f9fa;"' : '';
            html += '<tr ' + rowClass + '>';
            
            row.forEach(cell => {
                html += '<td>' + (cell || '') + '</td>';
            });
            
            html += '</tr>';
        });
        
        html += '</table></div>';
    } else {
        html += '<p style="text-align: center; color: #999;">No data available for this report</p>';
    }
    
    html += '</div>';
    
    reportResults.innerHTML = html;
    
    document.getElementById('downloadReport').addEventListener('click', function() {
        downloadReportAsCSV(result);
    });
}

function downloadReportAsCSV(reportData) {
    const csvContent = "data:text/csv;charset=utf-8," 
        + reportData.reportData.map(row => 
            row.map(cell => `"${cell}"`).join(",")
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${reportData.title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// System Logs Functions
async function loadSystemLogs() {
    try {
        const result = await callGoogleAppsScript('getSystemLogs');
        systemLogs = result.logs || [];
        
        const userFilter = document.getElementById('userFilter');
        const uniqueUsers = [...new Set(systemLogs.map(log => log.user))];
        
        userFilter.innerHTML = '<option value="all">All Users</option>';
        uniqueUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            userFilter.appendChild(option);
        });
        
        filterLogs();
    } catch (error) {
        console.error('Error loading system logs:', error);
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    initializeLocalStorage();

// Add event listeners for view-only filters
document.addEventListener('DOMContentLoaded', function() {
    // Filter for view allocation status
    const viewStatusFilter = document.getElementById('viewStatusFilterAllocations');
    const viewSearchAllocations = document.getElementById('viewSearchAllocationsStatus');
    
    if (viewStatusFilter) {
        viewStatusFilter.addEventListener('change', function() {
            updateViewAllocationStatus();
        });
    }
    
    if (viewSearchAllocations) {
        viewSearchAllocations.addEventListener('input', function() {
            updateViewAllocationStatus();
        });
    }
});
    
    // Role selector
    document.querySelectorAll('.role-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
            currentUserRole = this.dataset.role;
        });
    });
    
    // Login button
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    
    // Logout buttons
    document.getElementById('hospitalLogout')?.addEventListener('click', logout);
    document.getElementById('adminLogout')?.addEventListener('click', logout);
    
    // Submit allocation
    document.getElementById('submitAllocation')?.addEventListener('click', submitAllocation);
    
    // New allocation button
    document.getElementById('newAllocation')?.addEventListener('click', resetAllocationForm);
    
    // Download PDF buttons
    document.getElementById('downloadPdf')?.addEventListener('click', function() {
        generateProfessionalPDF(false);
    });
    
    document.getElementById('downloadFinalPdf')?.addEventListener('click', function() {
        generateProfessionalPDF(true);
    });
    
    // Tab switching for hospital user
    document.querySelectorAll('.user-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            document.querySelectorAll('.user-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.user-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            if (tabName === 'myRequests') {
                loadMyRequests();
            } else if (tabName === 'history') {
                loadAllocationHistory();
            } else if (tabName === 'voteDistribution') {
                loadVoteDistribution();
            } else if (tabName === 'allocations') {
                updateUserAllocationStatus();
            }
        });
    });
    
    // Tab switching for admin
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            if (tabName === 'requests') {
                loadAdminData();
            } else if (tabName === 'allocationHistory') {
                loadAdminAllocationHistory();
            } else if (tabName === 'voteDistribution') {
                loadAdminVoteDistribution();
            } else if (tabName === 'hospitalSummary') {
                loadHospitalSummary();
            } else if (tabName === 'logs') {
                loadSystemLogs();
            }
        });
    });
    
    // Filter and search event listeners for hospital
    document.getElementById('myRequestsStatusFilter')?.addEventListener('change', filterMyRequests);
    document.getElementById('searchMyRequests')?.addEventListener('input', filterMyRequests);
    document.getElementById('myRequestsPrevPage')?.addEventListener('click', goToMyRequestsPrevPage);
    document.getElementById('myRequestsNextPage')?.addEventListener('click', goToMyRequestsNextPage);
    document.getElementById('searchUserAllocations')?.addEventListener('input', function() {
        updateUserAllocationStatus();
    });
    
    // History filters for hospital
    document.getElementById('historyYearFilter')?.addEventListener('change', function() {
        loadAllocationHistory();
    });
    document.getElementById('historyVoteFilter')?.addEventListener('change', function() {
        loadAllocationHistory();
    });
    document.getElementById('historyStatusFilter')?.addEventListener('change', function() {
        loadAllocationHistory();
    });
    
    // Vote distribution for hospital
    document.getElementById('distributionYearFilter')?.addEventListener('change', loadVoteDistribution);
    document.getElementById('exportVoteDistribution')?.addEventListener('click', exportVoteDistributionToExcel);
    document.getElementById('printVoteDistribution')?.addEventListener('click', function() {
        window.print();
    });
    
    // Filter and search event listeners for admin
    document.getElementById('statusFilter')?.addEventListener('change', filterAllocations);
    document.getElementById('searchAllocations')?.addEventListener('input', filterAllocations);
    document.getElementById('prevPage')?.addEventListener('click', goToPrevPage);
    document.getElementById('nextPage')?.addEventListener('click', goToNextPage);
    
    // Status filter for admin allocations tab
    document.getElementById('statusFilterAllocations')?.addEventListener('change', function() {
        updateAllocationStatusEnhanced();
    });
    document.getElementById('searchAllocationsStatus')?.addEventListener('input', function() {
        updateAllocationStatusEnhanced();
    });
    
    // History filters for admin
    document.getElementById('adminHistoryYearFilter')?.addEventListener('change', function() {
        loadAdminAllocationHistory();
    });
    document.getElementById('adminHistoryHospitalFilter')?.addEventListener('change', function() {
        loadAdminAllocationHistory();
    });
    document.getElementById('adminHistoryStatusFilter')?.addEventListener('change', function() {
        loadAdminAllocationHistory();
    });
    
    // Vote distribution for admin
    document.getElementById('adminDistributionYearFilter')?.addEventListener('change', loadAdminVoteDistribution);
    document.getElementById('exportAdminVoteDistribution')?.addEventListener('click', exportAdminVoteDistributionToExcel);
    document.getElementById('printAdminVoteDistribution')?.addEventListener('click', function() {
        window.print();
    });
    
    // Hospital summary filters
    document.getElementById('hospitalSummaryYearFilter')?.addEventListener('change', loadHospitalSummary);
    document.getElementById('hospitalSummaryStatusFilter')?.addEventListener('change', loadHospitalSummary);
    document.getElementById('exportHospitalSummary')?.addEventListener('click', exportHospitalSummaryToExcel);
    document.getElementById('printHospitalSummary')?.addEventListener('click', function() {
        window.print();
    });
    
    // Reports
    document.getElementById('generateReport')?.addEventListener('click', generateReport);
    
    // Logs
    document.getElementById('logTypeFilter')?.addEventListener('change', filterLogs);
    document.getElementById('userFilter')?.addEventListener('change', filterLogs);
    document.getElementById('logHospitalFilter')?.addEventListener('change', filterLogs);
    document.getElementById('searchLogs')?.addEventListener('input', filterLogs);
    document.getElementById('refreshLogs')?.addEventListener('click', loadSystemLogs);
    document.getElementById('exportLogs')?.addEventListener('click', exportLogs);
    document.getElementById('logsPrevPage')?.addEventListener('click', goToLogsPrevPage);
    document.getElementById('logsNextPage')?.addEventListener('click', goToLogsNextPage);
    
    // Modal close buttons
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                showElement(modal, false);
            }
        });
    });
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                showElement(this, false);
            }
        });
    });
    
    // Approval modal buttons
    document.getElementById('confirmApproval')?.addEventListener('click', approveAllocation);
    document.getElementById('rejectRequest')?.addEventListener('click', function() {
        hideModal('approvalModal');
        openRejectionModal(currentRequestId);
    });
    
    // Rejection modal buttons
    document.getElementById('confirmRejection')?.addEventListener('click', rejectAllocation);
    document.getElementById('cancelRejection')?.addEventListener('click', function() {
        hideModal('rejectionModal');
    });
    
    // Edit modal buttons
    document.getElementById('confirmEdit')?.addEventListener('click', saveEdit);
    document.getElementById('cancelEdit')?.addEventListener('click', function() {
        hideModal('editModal');
    });
    
    // View modal buttons
    document.getElementById('closeView')?.addEventListener('click', function() {
        hideModal('viewModal');
    });
    
    // Admin password modal
    document.getElementById('confirmAdminPassword')?.addEventListener('click', function() {
        const password = document.getElementById('adminPassword').value;
        if (password === ADMIN_PASSWORD) {
            hideModal('adminPasswordModal');
            executePendingAction();
        } else {
            alert('Invalid admin password');
        }
    });
    
    document.getElementById('cancelAdminPassword')?.addEventListener('click', function() {
        hideModal('adminPasswordModal');
        pendingAction = null;
        pendingRequestId = null;
    });
    
    // Hospital history modal
    document.getElementById('closeHospitalHistory')?.addEventListener('click', function() {
        hideModal('hospitalHistoryModal');
    });
    
    document.getElementById('exportHospitalHistory')?.addEventListener('click', function() {
        const hospitalName = document.getElementById('hospitalHistoryTitle').textContent.replace('Allocation History for ', '');
        const hospitalAllocations = allAllocations.filter(allocation => allocation.hospitalname === hospitalName);
        
        const csvContent = "data:text/csv;charset=utf-8," 
            + "Ref No.,Vote Number,Job Description,Requested Amount,Approved Amount,Status,Submitted Date,Approved Date\n"
            + hospitalAllocations.map(allocation => 
                `"${allocation.refnumber}","${allocation.votenumber}","${allocation.jobdescription}","${formatCurrency(allocation.requiredamount)}","${allocation.approvedamount > 0 ? formatCurrency(allocation.approvedamount) : 'N/A'}","${allocation.status}","${formatDate(allocation.timestamp)}","${allocation.approvaldate ? formatDate(allocation.approvaldate) : 'N/A'}"`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `hospital_history_${hospitalName}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    // Initialize enhanced status display observer
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    const statusCells = table.querySelectorAll('td:nth-last-child(2)');
                    statusCells.forEach(cell => {
                        if (cell.innerHTML.includes('status-badge') && !cell.innerHTML.includes('status-badge-enhanced')) {
                            const status = cell.textContent.trim();
                            cell.innerHTML = getEnhancedStatusBadge(status, true);
                        }
                    });
                });
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});

// Add these event listeners in your initialization section
document.getElementById('viewPrevPage')?.addEventListener('click', goToViewPrevPage);
document.getElementById('viewNextPage')?.addEventListener('click', goToViewNextPage);

function goToViewPrevPage() {
    if (currentPage > 1) {
        currentPage--;
        filterViewAllocations();
    }
}

function goToViewNextPage() {
    const totalPages = Math.ceil(filteredAllocations.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        filterViewAllocations();
    }
}

const loginInputs = [
    document.getElementById("password"),
    document.getElementById("hospitalSelect")
  ];

  loginInputs.forEach(input => {
    input.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("loginBtn").click();
      }
    });
  });

    </script>
</body>
</html>










